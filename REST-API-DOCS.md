# REST API Документация (Integrations)

Базовый URL: `/api/integrations`

Заголовки авторизации (обязательны для всех методов):
- `X-Api-Key: <api_key>`
- `Content-Type: application/json`

Соглашения:
- Все поля в `snake_case`.
- Денежные значения и баллы — целые числа, если не указано иное.
- В `items` цена указывается за единицу товара.
- Если поле отмечено как обязательное, отсутствие вернёт `400`.

---

## CODE
`POST /api/integrations/code`

Назначение: проверить QR `user_token` и вернуть профиль клиента и ставки.

Тело запроса:
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `user_token` | string | да | QR токен клиента. |

Тело ответа:
| Поле | Тип | Описание |
| --- | --- | --- |
| `type` | string | Константа: `"bonus"`. |
| `client` | object | Профиль клиента (см. ниже). |

Объект `client`:
| Поле | Тип | Описание |
| --- | --- | --- |
| `id_client` | string | ID клиента в системе лояльности. |
| `id_ext` | string \| null | Внешний ID (если есть). |
| `name` | string \| null | Имя клиента. |
| `phone` | string \| null | Телефон в формате E.164. |
| `email` | string \| null | Email. |
| `balance` | number | Баланс баллов. |
| `earn_percent` | number | Базовый процент начисления по уровню. |
| `redeem_limit_percent` | number | Максимальный процент списания по уровню. |
| `birth_date` | string \| null | `YYYY-MM-DD`. |
| `avg_bill` | number | Средний чек. |
| `visit_frequency` | number \| null | Среднее число дней между визитами. |
| `visit_count` | number | Количество визитов. |
| `total_amount` | number | Сумма покупок за всё время. |
| `accruals_blocked` | boolean | Начисления заблокированы для клиента. |
| `redemptions_blocked` | boolean | Списания заблокированы для клиента. |

Примечания:
- Тот же объект `client` возвращается методом `BONUS`.

---

## CALCULATE-ACTION
`POST /api/integrations/calculate/action`

Назначение: применить акции (цена, бесплатные позиции, бонусные множители) к товарам
и вернуть нормализованные позиции.

Тело запроса:
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id_client` | string | условно | ID клиента в системе лояльности. Обязателен, если нет `phone`. |
| `phone` | string | условно | Телефон клиента. Обязателен, если нет `id_client`. |
| `outlet_id` | string | нет | ID торговой точки (опционально). |
| `items` | array | да | Список позиций (см. ниже). |

Элемент `items`:
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id_product` | string | да | Внешний ID товара. |
| `qty` | number | да | Количество. |
| `price` | number | да | Базовая цена до применения акций. |
| `name` | string | нет | Название товара (опционально). |

Тело ответа:
| Поле | Тип | Описание |
| --- | --- | --- |
| `status` | string | `"ok"` или ошибка. |
| `positions` | array | Рассчитанные позиции (см. ниже). |
| `info` | string[] | Человекочитаемые описания применённых акций. |

Элемент `positions`:
| Поле | Тип | Описание |
| --- | --- | --- |
| `id_product` | string | Внешний ID товара. |
| `name` | string \| null | Название товара. |
| `qty` | number | Количество в данной позиции. |
| `price` | number | Цена после применения акций. |
| `base_price` | number \| null | Исходная цена, если была изменена акцией. |
| `actions` | string[] | ID применённых акций. |
| `actions_names` | string[] | Названия применённых акций. |

Примечания:
- Акции типа `NTH_FREE` могут разбивать позицию на несколько строк
  (например, бесплатные и платные позиции).
- `POINTS_MULTIPLIER` попадает в `actions`, но цену не меняет.

---

## CALCULATE-BONUS
`POST /api/integrations/calculate/bonus`

Назначение: расчёт начисляемых/списываемых баллов без фиксации операции.

Тело запроса:
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `user_token` | string | условно | QR токен клиента. Обязателен, если нет `id_client` и `phone`. |
| `id_client` | string | условно | ID клиента. Обязателен, если нет `user_token` и `phone`. |
| `phone` | string | условно | Телефон клиента. Обязателен, если нет `user_token` и `id_client`. |
| `outlet_id` | string | нет | ID торговой точки (опционально). |
| `total` | number | условно | Сумма чека, обязательна, если нет `items`. |
| `paid_bonus` | number | нет | Желаемое списание (для пересчёта). |
| `items` | array | условно | Позиции (см. ниже). Обязательны, если нет `total`. |

Элемент `items`:
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id_product` | string | да | Внешний ID товара. |
| `name` | string | нет | Название товара. |
| `qty` | number | нет | Количество (по умолчанию `1`). |
| `price` | number | да | Цена за единицу для расчёта. |
| `actions` | string[] | нет | ID применённых акций. |
| `action_names` | string[] | нет | Названия применённых акций. |

Тело ответа:
| Поле | Тип | Описание |
| --- | --- | --- |
| `status` | string | `"ok"` или ошибка. |
| `max_pay_bonus` | number | Максимальное списание по всему чеку. |
| `bonus_value` | number | Начисление по всему чеку. |
| `final_payable` | number | `total - max_pay_bonus` после ограничений. |
| `items` | array \| undefined | Расшифровка по позициям (см. ниже). |

Элемент `items`:
| Поле | Тип | Описание |
| --- | --- | --- |
| `id_product` | string \| null | Внешний ID товара. |
| `name` | string \| null | Название товара. |
| `price` | number | Цена за единицу для расчёта. |
| `quantity` | number | Количество. |
| `max_pay_bonus` | number | Максимальное списание по позиции. |
| `earn_bonus` | number | Начисление по позиции. |

Примечания:
- Акции применяются **только** если переданы `actions`/`action_names`.
  Автоприменения акций в методе нет.
- Учитываются уровни, минимальная сумма, дневные лимиты и блокировки.

---

## BONUS
`POST /api/integrations/bonus`

Назначение: фиксация покупки — списание и/или начисление баллов.

Тело запроса:
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `user_token` | string | условно | QR токен клиента. Обязателен, если нет `id_client`. |
| `id_client` | string | условно | ID клиента. Обязателен, если нет `user_token`. |
| `invoice_num` | string | нет | Номер чека от мерчанта. |
| `idempotency_key` | string | да | Уникальный ключ идемпотентности операции. |
| `device_id` | string | условно | Код устройства (касса). |
| `outlet_id` | string | условно | ID торговой точки. |
| `outlet_name` | string | нет | Название торговой точки (опционально). |
| `manager_id` | string | условно | ID сотрудника. |
| `manager_name` | string | нет | Имя сотрудника (опционально). |
| `total` | number | условно | Сумма чека (если нет, считается из `items`). |
| `paid_bonus` | number | нет | Сколько списываем. Если не передано — списаний нет. |
| `bonus_value` | number | нет | Сколько начисляем. Если не передано — авторасчёт. |
| `operation_date` | string | нет | ISO 8601, может быть в прошлом. |
| `items` | array | условно | Позиции (см. ниже). Обязательны, если нет `total`. |

Должно быть передано хотя бы одно: `outlet_id`, `device_id`, `manager_id`.

Элемент `items`:
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `id_product` | string | да | Внешний ID товара. |
| `name` | string | нет | Название товара. |
| `qty` | number | да | Количество. |
| `price` | number | да | Цена за единицу для расчёта. |
| `base_price` | number | нет | Исходная цена до акции (для справки). |
| `actions` | string[] | нет | ID применённых акций. |
| `action_names` | string[] | нет | Названия применённых акций. |

Тело ответа:
| Поле | Тип | Описание |
| --- | --- | --- |
| `result` | string | `"ok"` или ошибка. |
| `invoice_num` | string \| null | Номер чека (из запроса или сгенерирован). |
| `order_id` | string \| null | Внутренний ID операции лояльности. |
| `redeem_applied` | number | Списано баллов. |
| `earn_applied` | number | Начислено баллов. |
| `client` | object | Профиль клиента (как в `CODE`). |

Примечания:
- Если `bonus_value` не передан — начисления рассчитываются автоматически.
  Если `bonus_value` явно `0`, начисления не делаются.
- Акции применяются **только** если переданы `actions`/`action_names`.
  Автоприменения акций в методе нет.
- Если `total` не передан, он считается по `items`.
  `paid_bonus` **не** вычитается из рассчитанного `total`.
- Идемпотентность обеспечивается по `idempotency_key` в рамках мерчанта.

---

## REFUND
`POST /api/integrations/refund`

Назначение: отмена ранее зафиксированной покупки.

Тело запроса:
| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `invoice_num` | string | условно | Номер чека от мерчанта. Обязателен, если нет `order_id`. |
| `order_id` | string | условно | Внутренний ID операции. Обязателен, если нет `invoice_num`. |
| `device_id` | string | нет | Код устройства. |
| `outlet_id` | string | нет | ID торговой точки. |
| `operation_date` | string | нет | ISO 8601, может быть в прошлом. |

Тело ответа:
| Поле | Тип | Описание |
| --- | --- | --- |
| `result` | string | `"ok"` или ошибка. |
| `invoice_num` | string | Номер чека. |
| `order_id` | string | Внутренний ID операции лояльности. |
| `points_restored` | number | Восстановленные баллы (за списание). |
| `points_revoked` | number | Отозванные баллы (за начисление). |
| `balance_after` | number \| null | Баланс после возврата (если доступен). |

Примечания:
- Используйте `order_id` или `invoice_num` из ответа `BONUS`.
