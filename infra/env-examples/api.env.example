# API (NestJS)
NODE_ENV=production

# Database
# Use together with docker-compose.production.yml: DB_PASSWORD is referenced
DB_PASSWORD=change_me_db
DATABASE_URL=postgresql://loyalty:${DB_PASSWORD}@postgres:5432/loyalty

# Redis (optional but recommended)
REDIS_PASSWORD=change_me_redis
REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379

# Local cache (optional)
# CACHE_MAX_ENTRIES=5000
# CACHE_TTL_SETTINGS_MS=30000
# CACHE_TTL_OUTLET_MS=30000
# CACHE_TTL_STAFF_MS=15000

# Core secrets
ADMIN_KEY=change_me_admin_key
API_KEY=change_me_api_key
QR_JWT_SECRET=change_me_qr_secret
ADMIN_SESSION_SECRET=change_me_session_secret
PORTAL_JWT_SECRET=change_me_portal_jwt_secret
PORTAL_REFRESH_SECRET=change_me_portal_refresh_secret

# Public origins and base URLs (adjust DOMAIN)
DOMAIN=example.com
CORS_ORIGINS=https://admin.${DOMAIN},https://cashier.${DOMAIN},https://app.${DOMAIN},https://portal.${DOMAIN}
API_BASE_URL=https://api.${DOMAIN}
MINIAPP_BASE_URL=https://app.${DOMAIN}

# Security / proxy
TRUST_PROXY=1
COOKIE_SECURE=true
# Admin IP allowlist (recommended)
# ADMIN_IP_WHITELIST=1.2.3.4,5.6.7.0/24
# ADMIN_IP_ALLOW_ALL=false
# MAINTENANCE_MODE=0
# READ_ONLY_MODE=0

# Observability (optional)
LOG_LEVEL=info
# LOG_HTTP_IGNORE_PATHS=/healthz,/readyz,/live,/metrics
SENTRY_DSN=
SENTRY_TRACES_SAMPLE_RATE=0.0
OTEL_ENABLED=0
OTEL_EXPORTER_OTLP_ENDPOINT=
OTEL_SERVICE_NAME=loyalty-api
APP_VERSION=dev
METRICS_TOKEN=
ALERTS_5XX_SAMPLE_RATE=0.0

# Alerts (optional)
ALERT_TELEGRAM_BOT_TOKEN=
ALERT_TELEGRAM_CHAT_ID=
ALERT_HTTP_5XX_PER_MIN=0
ALERT_HTTP_SLOW_PER_MIN=0
ALERT_HTTP_SLOW_THRESHOLD_MS=1500
ALERT_OUTBOX_DEAD_DELTA=0
ALERT_OUTBOX_PENDING_THRESHOLD=200
ALERT_OUTBOX_DEAD_THRESHOLD=5
ALERT_WORKER_STALE_MINUTES=5
ALERT_MONITOR_INTERVAL_MS=60000
ALERT_REPEAT_MINUTES=30
# Communications alerts
# ALERT_COMM_TASK_STALE_THRESHOLD=1
# ALERT_COMM_TASK_FAILED_THRESHOLD=5
# ALERT_COMM_TASK_FAILED_WINDOW_MINUTES=60
# Data import alerts
# ALERT_DATA_IMPORT_STALE_THRESHOLD=1

# Staff notifications (optional)
TELEGRAM_NOTIFY_BOT_TOKEN=
TELEGRAM_NOTIFY_WEBHOOK_SECRET=

# Idempotency TTL (hours)
IDEMPOTENCY_TTL_HOURS=72

# Workers
WORKERS_ENABLED=0
NO_HTTP=0
# Internal worker-only metrics endpoint (used when NO_HTTP=1)
# WORKER_METRICS_PORT=3001
# WORKER_PROGRESS_HEARTBEAT_MS=30000
# WORKER_STALE_GRACE_MS=0
# WORKER_LOCK_MISS_GRACE_MS=300000
# Auto-return mechanic (interval in ms, batch size per tick)
# AUTO_RETURN_WORKER_INTERVAL_MS=21600000
# AUTO_RETURN_BATCH_SIZE=200
# Birthday mechanic (interval in ms)
# BIRTHDAY_WORKER_INTERVAL_MS=21600000
# Retention GC (interval in ms)
# RETENTION_GC_INTERVAL_MS=21600000
# Feature flags
EARN_LOTS_FEATURE=0
LEDGER_FEATURE=0
POINTS_TTL_FEATURE=0
POINTS_TTL_BURN=0
POINTS_TTL_REMINDER=0
# POINTS_TTL_REMINDER_INTERVAL_MS=21600000
# OUTBOX_WORKER_CONCURRENCY=3
# OUTBOX_MAX_RETRIES=10
# OUTBOX_HTTP_TIMEOUT_MS=10000
# OUTBOX_CB_THRESHOLD=5
# OUTBOX_CB_WINDOW_MS=60000
# OUTBOX_CB_COOLDOWN_MS=120000
# OUTBOX_RPS_DEFAULT=0
# OUTBOX_RPS_BY_MERCHANT="M-1=5,M-2=3"
# OUTBOX_GC_INTERVAL_MS=3600000
# OUTBOX_RETENTION_DAYS=30
# IDEMPOTENCY_GC_INTERVAL_MS=60000
# IDEMPOTENCY_TTL_HOURS=72
# COMM_WORKER_INTERVAL_MS=15000
# COMM_TASK_STALE_MS=1200000
# COMM_TASK_MAX_RETRIES=2
# COMM_TASK_RETRY_DELAY_MS=300000
# COMM_TASK_RETRY_BATCH=20
# COMM_RECIPIENT_BATCH=200
# COMM_DELIVERY_CONCURRENCY=5
# DATA_IMPORT_STALE_MS=7200000
# DATA_IMPORT_RETRY_STALE=0
# Retention windows (days)
# ADMIN_AUDIT_RETENTION_DAYS=90
# SYNC_LOG_RETENTION_DAYS=30
# COMMUNICATION_TASK_RETENTION_DAYS=180

# Notifications (optional)
# SMTP
SMTP_HOST=
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=
SMTP_PASSWORD=
SMTP_FROM=

# Notification worker (optional)
# NOTIFY_WORKER_INTERVAL_MS=15000
# NOTIFY_WORKER_BATCH=10
# NOTIFY_BACKOFF_BASE_MS=60000
# NOTIFY_BACKOFF_CAP_MS=3600000
# NOTIFY_RPS_DEFAULT=0
# NOTIFY_RPS_BY_MERCHANT="M-1=5,M-2=3"
# NOTIFY_SENDING_STALE_MS=300000

# API throttling (global fallback)
# THROTTLER_DEFAULT_TTL_MS=60000
# THROTTLER_DEFAULT_LIMIT=200

# Portal throttling profile (per merchant + route)
# RL_LIMIT_PORTAL_READ=600
# RL_TTL_PORTAL_READ=60000
# RL_LIMIT_PORTAL_WRITE=180
# RL_TTL_PORTAL_WRITE=60000
# RL_LIMIT_PORTAL_ANALYTICS_READ=900
# RL_TTL_PORTAL_ANALYTICS_READ=60000
# RL_LIMIT_PORTAL_OPERATIONS_READ=900
# RL_TTL_PORTAL_OPERATIONS_READ=60000

# Antifraud guard
ANTIFRAUD_GUARD=on

# Antifraud defaults (overridable per-merchant in Admin -> Anti-Fraud)
# Per-scope rate limits and windows (seconds)
AF_LIMIT_MERCHANT=200
AF_WINDOW_MERCHANT_SEC=3600
AF_LIMIT_OUTLET=20
AF_WINDOW_OUTLET_SEC=600
AF_LIMIT_DEVICE=20
AF_WINDOW_DEVICE_SEC=600
AF_LIMIT_STAFF=60
AF_WINDOW_STAFF_SEC=600
AF_LIMIT_CUSTOMER=5
AF_WINDOW_CUSTOMER_SEC=120

# Optional daily caps (0 = disabled)
AF_DAILY_CAP_MERCHANT=0
AF_DAILY_CAP_OUTLET=0
AF_DAILY_CAP_DEVICE=0
AF_DAILY_CAP_STAFF=0
AF_DAILY_CAP_CUSTOMER=0

# Optional weekly caps (0 = disabled)
AF_WEEKLY_CAP_MERCHANT=0
AF_WEEKLY_CAP_OUTLET=0
AF_WEEKLY_CAP_DEVICE=0
AF_WEEKLY_CAP_STAFF=0
AF_WEEKLY_CAP_CUSTOMER=0
