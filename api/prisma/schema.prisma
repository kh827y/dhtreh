datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum WalletType {
  POINTS
}

enum HoldMode {
  REDEEM
  EARN
}

enum HoldStatus {
  PENDING
  COMMITTED
  CANCELED
}

enum DeviceType {
  SMART
  PC_POS
  VIRTUAL
}

enum StaffRole {
  ADMIN
  MANAGER
  CASHIER
}

enum TxnType {
  EARN
  REDEEM
  REFUND
  ADJUST
}

enum LedgerAccount {
  CUSTOMER_BALANCE
  MERCHANT_LIABILITY
  RESERVED
}

model Merchant {
  id        String            @id @default(cuid())
  name      String
  settings  MerchantSettings?
  wallets   Wallet[]
  holds     Hold[]
  txns      Transaction[]
  createdAt DateTime          @default(now())
  Receipt   Receipt[]
  outlets   Outlet[]
  devices   Device[]
  staff     Staff[]
  consents  Consent[]
  telegramBot TelegramBot?
  subscription Subscription?
  fraudChecks FraudCheck[]
  integrations Integration[]
  customerSegments CustomerSegment[]
  campaigns Campaign[]
}

model MerchantSettings {
  merchantId     String   @id
  merchant       Merchant @relation(fields: [merchantId], references: [id])
  earnBps        Int      @default(500)
  redeemLimitBps Int      @default(5000)
  qrTtlSec       Int      @default(120)
  webhookUrl     String?
  webhookSecret  String?
  webhookKeyId   String?
  webhookSecretNext String?
  webhookKeyIdNext  String?
  useWebhookNext    Boolean  @default(false)
  pointsTtlDays     Int?
  redeemCooldownSec Int   @default(0)
  earnCooldownSec   Int   @default(0)
  redeemDailyCap    Int?
  earnDailyCap      Int?
  requireJwtForQuote Boolean @default(false)
  requireBridgeSig   Boolean @default(false)
  bridgeSecret       String?
  bridgeSecretNext   String?
  rulesJson          Json?
  requireStaffKey    Boolean @default(false)
  // Telegram miniapp per merchant
  telegramBotToken   String?
  telegramBotUsername String?
  telegramStartParamRequired Boolean @default(false)
  miniappBaseUrl     String?
  miniappThemePrimary String?
  miniappThemeBg      String?
  miniappLogoUrl      String?
  outboxPausedUntil   DateTime?
  updatedAt      DateTime @default(now())
}

model IdempotencyKey {
  id         String   @id @default(cuid())
  merchantId String
  key        String
  response   Json
  createdAt  DateTime @default(now())
  expiresAt  DateTime?

  @@unique([merchantId, key])
  @@index([merchantId, createdAt])
  @@index([expiresAt])
}

model Consent {
  merchantId String
  customerId String
  consentAt  DateTime
  createdAt  DateTime @default(now())

  merchant   Merchant @relation(fields: [merchantId], references: [id])
  customer   Customer @relation(fields: [customerId], references: [id])

  @@id([merchantId, customerId])
}

model Customer {
  id        String        @id @default(cuid())
  phone     String?       @unique
  tgId      String?       @unique
  wallets   Wallet[]
  holds     Hold[]
  txns      Transaction[]
  createdAt DateTime      @default(now())
  Receipt   Receipt[]
  consents  Consent[]
}

model Wallet {
  id         String     @id @default(cuid())
  customerId String
  customer   Customer   @relation(fields: [customerId], references: [id])
  merchantId String
  merchant   Merchant   @relation(fields: [merchantId], references: [id])
  type       WalletType
  balance    Int        @default(0)
  createdAt  DateTime   @default(now())

  @@unique([customerId, merchantId, type])
}

model Hold {
  id           String     @id @default(cuid())
  customerId   String
  customer     Customer   @relation(fields: [customerId], references: [id])
  merchantId   String
  merchant     Merchant   @relation(fields: [merchantId], references: [id])
  mode         HoldMode
  redeemAmount Int        @default(0)
  earnPoints   Int        @default(0)
  status       HoldStatus @default(PENDING)
  orderId      String?
  receiptId    String?
  total         Int?
  eligibleTotal Int?
  qrJti        String?    @unique   // <— НОВОЕ: один hold на один QR
  expiresAt    DateTime?
  outletId     String?
  deviceId     String?
  staffId      String?
  createdAt    DateTime   @default(now())

  outlet       Outlet?    @relation(fields: [outletId], references: [id], onDelete: SetNull)
  device       Device?    @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  staff        Staff?     @relation(fields: [staffId], references: [id], onDelete: SetNull)

  @@index([customerId, status])
  @@index([merchantId, status])
  @@index([merchantId, outletId])
  @@index([merchantId, deviceId])
  @@index([merchantId, staffId])
}

model Receipt {
  id         String   @id @default(cuid())
  merchantId String
  merchant   Merchant @relation(fields: [merchantId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  orderId       String
  receiptNumber String?
  total         Int
  eligibleTotal Int
  redeemApplied Int      @default(0) // сколько списали баллами
  earnApplied   Int      @default(0) // сколько начислили
  createdAt     DateTime @default(now())
  outletId      String?
  deviceId      String?
  staffId       String?

  outlet       Outlet?    @relation(fields: [outletId], references: [id], onDelete: SetNull)
  device       Device?    @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  staff        Staff?     @relation(fields: [staffId], references: [id], onDelete: SetNull)

  @@unique([merchantId, orderId])
  @@index([merchantId, createdAt])
  @@index([merchantId, outletId])
  @@index([merchantId, deviceId])
  @@index([merchantId, staffId])
}

model Transaction {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  merchantId String
  merchant   Merchant @relation(fields: [merchantId], references: [id])
  type       TxnType
  amount     Int
  orderId    String?
  createdAt  DateTime @default(now())
  outletId   String?
  deviceId   String?
  staffId    String?

  outlet       Outlet?    @relation(fields: [outletId], references: [id], onDelete: SetNull)
  device       Device?    @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  staff        Staff?     @relation(fields: [staffId], references: [id], onDelete: SetNull)

  @@index([customerId, createdAt])
  @@index([merchantId, createdAt])
  @@index([merchantId, outletId])
  @@index([merchantId, deviceId])
  @@index([merchantId, staffId])
  @@index([merchantId, customerId, type, createdAt])
}

model QrNonce {
  jti        String   @id                  // уникальный ID токена (JTI)
  customerId String
  merchantId String?
  issuedAt   DateTime
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime @default(now())

  @@index([merchantId, usedAt])
}

model EventOutbox {
  id          String   @id @default(cuid())
  merchantId  String
  eventType   String
  payload     Json
  status      String   @default("PENDING")
  retries     Int      @default(0)
  nextRetryAt DateTime?
  lastError   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status, nextRetryAt])
  @@index([merchantId, createdAt])
}

model Outlet {
  id          String    @id @default(cuid())
  merchantId  String
  merchant    Merchant  @relation(fields: [merchantId], references: [id])
  name        String
  address     String?
  createdAt   DateTime  @default(now())

  @@index([merchantId])

  // обратные связи
  devices     Device[]
  holds       Hold[]
  receipts    Receipt[]
  txns        Transaction[]
}

model Device {
  id          String     @id @default(cuid())
  merchantId  String
  merchant    Merchant   @relation(fields: [merchantId], references: [id])
  outletId    String?
  outlet      Outlet?    @relation(fields: [outletId], references: [id], onDelete: SetNull)
  type        DeviceType
  label       String?
  lastSeenAt  DateTime?
  bridgeSecret String?
  createdAt   DateTime   @default(now())

  @@index([merchantId])
  @@index([merchantId, outletId])

  // обратные связи
  holds     Hold[]
  receipts  Receipt[]
  txns      Transaction[]
}

model Staff {
  id          String     @id @default(cuid())
  merchantId  String
  merchant    Merchant   @relation(fields: [merchantId], references: [id])
  login       String?
  email       String?
  role        StaffRole  @default(CASHIER)
  status      String     @default("ACTIVE")
  hash        String?
  apiKeyHash  String?
  allowedOutletId String?
  allowedDeviceId String?
  createdAt   DateTime   @default(now())

  @@index([merchantId])
  @@unique([merchantId, login])
  @@index([merchantId, apiKeyHash])

  // обратные связи
  holds     Hold[]
  receipts  Receipt[]
  txns      Transaction[]
}

model LedgerEntry {
  id          String         @id @default(cuid())
  merchantId  String
  customerId  String?
  debit       LedgerAccount
  credit      LedgerAccount
  amount      Int
  orderId     String?
  receiptId   String?
  outletId    String?
  deviceId    String?
  staffId     String?
  meta        Json?
  createdAt   DateTime       @default(now())

  @@index([merchantId, createdAt])
  @@index([merchantId, customerId, createdAt])
}

model EarnLot {
  id            String   @id @default(cuid())
  merchantId    String
  customerId    String
  points        Int
  consumedPoints Int     @default(0)
  earnedAt      DateTime
  expiresAt     DateTime?
  orderId       String?
  receiptId     String?
  outletId      String?
  deviceId      String?
  staffId       String?
  createdAt     DateTime @default(now())

  @@index([merchantId, customerId, earnedAt])
  @@index([merchantId, expiresAt])
}

model AdminAudit {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  actor       String
  method      String
  path        String
  merchantId  String?
  action      String?
  payload     Json?

  @@index([merchantId, createdAt])
}

model TelegramBot {
  id                String   @id @default(cuid())
  merchantId        String   @unique
  botToken          String   @unique
  botUsername       String   @unique
  botId             String?
  webhookUrl        String?
  webhookSecret     String?
  isActive          Boolean  @default(true)
  welcomeMessage    String?
  menuConfig        Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  merchant          Merchant @relation(fields: [merchantId], references: [id])
}

model Plan {
  id                String   @id @default(cuid())
  name              String
  displayName       String
  price             Int
  currency          String   @default("RUB")
  interval          String
  features          Json
  maxTransactions   Int?
  maxCustomers      Int?
  maxOutlets        Int?
  webhooksEnabled   Boolean  @default(true)
  customBranding    Boolean  @default(false)
  prioritySupport   Boolean  @default(false)
  apiAccess         Boolean  @default(true)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())

  subscriptions     Subscription[]
}

model Subscription {
  id                String    @id @default(cuid())
  merchantId        String    @unique
  planId            String
  status            String    @default("active")
  currentPeriodStart DateTime
  currentPeriodEnd  DateTime
  cancelAt          DateTime?
  canceledAt        DateTime?
  trialEnd          DateTime?
  metadata          Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  plan              Plan      @relation(fields: [planId], references: [id])
  merchant          Merchant  @relation(fields: [merchantId], references: [id])
  payments          Payment[]
}

model Payment {
  id                String    @id @default(cuid())
  subscriptionId    String
  amount            Int
  currency          String    @default("RUB")
  status            String
  paymentMethod     String?
  invoiceId         String?
  receiptUrl        String?
  failureReason     String?
  paidAt            DateTime?
  createdAt         DateTime  @default(now())

  subscription      Subscription @relation(fields: [subscriptionId], references: [id])
}

model FraudCheck {
  id                String    @id @default(cuid())
  merchantId        String
  customerId        String
  transactionId     String?
  riskScore         Int
  riskLevel         String
  factors           String[]
  blocked           Boolean   @default(false)
  reviewed          Boolean   @default(false)
  reviewedBy        String?
  reviewNotes       String?
  metadata          Json?
  createdAt         DateTime  @default(now())

  merchant          Merchant  @relation(fields: [merchantId], references: [id])
}

model Integration {
  id                String    @id @default(cuid())
  merchantId        String
  type              String
  provider          String
  config            Json
  credentials       Json?
  isActive          Boolean   @default(true)
  lastSync          DateTime?
  errorCount        Int       @default(0)
  lastError         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  merchant          Merchant  @relation(fields: [merchantId], references: [id])
}

model CustomerSegment {
  id                String    @id @default(cuid())
  merchantId        String
  name              String
  description       String?
  rules             Json
  customerCount     Int       @default(0)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  merchant          Merchant  @relation(fields: [merchantId], references: [id])
  campaigns         Campaign[]
}

model Campaign {
  id                String    @id @default(cuid())
  merchantId        String
  name              String
  type              String
  status            String    @default("draft")
  segmentId         String?
  content           Json
  schedule          Json?
  metrics           Json?
  startAt           DateTime?
  endAt             DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  merchant          Merchant  @relation(fields: [merchantId], references: [id])
  segment           CustomerSegment? @relation(fields: [segmentId], references: [id])
}
