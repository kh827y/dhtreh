datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum WalletType {
  POINTS
}

enum HoldMode {
  REDEEM
  EARN
}

enum HoldStatus {
  PENDING
  COMMITTED
  CANCELED
}

enum TxnType {
  EARN
  REDEEM
  REFUND
  ADJUST
}

model Merchant {
  id        String            @id @default(cuid())
  name      String
  settings  MerchantSettings?
  wallets   Wallet[]
  holds     Hold[]
  txns      Transaction[]
  createdAt DateTime          @default(now())
  Receipt   Receipt[]
}

model MerchantSettings {
  merchantId     String   @id
  merchant       Merchant @relation(fields: [merchantId], references: [id])
  earnBps        Int      @default(500)
  redeemLimitBps Int      @default(5000)
  qrTtlSec       Int      @default(120)
  webhookUrl     String?
  webhookSecret  String?
  updatedAt      DateTime @default(now())
}

model Customer {
  id        String        @id @default(cuid())
  phone     String?       @unique
  tgId      String?       @unique
  wallets   Wallet[]
  holds     Hold[]
  txns      Transaction[]
  createdAt DateTime      @default(now())
  Receipt   Receipt[]
}

model Wallet {
  id         String     @id @default(cuid())
  customerId String
  customer   Customer   @relation(fields: [customerId], references: [id])
  merchantId String
  merchant   Merchant   @relation(fields: [merchantId], references: [id])
  type       WalletType
  balance    Int        @default(0)
  createdAt  DateTime   @default(now())

  @@unique([customerId, merchantId, type])
}

model Hold {
  id           String     @id @default(cuid())
  customerId   String
  customer     Customer   @relation(fields: [customerId], references: [id])
  merchantId   String
  merchant     Merchant   @relation(fields: [merchantId], references: [id])
  mode         HoldMode
  redeemAmount Int        @default(0)
  earnPoints   Int        @default(0)
  status       HoldStatus @default(PENDING)
  orderId      String?
  receiptId    String?
  total         Int?
  eligibleTotal Int?
  qrJti        String?    @unique   // <— НОВОЕ: один hold на один QR
  expiresAt    DateTime?
  createdAt    DateTime   @default(now())

  @@index([customerId, status])
  @@index([merchantId, status])
}

model Receipt {
  id         String   @id @default(cuid())
  merchantId String
  merchant   Merchant @relation(fields: [merchantId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  orderId       String
  receiptNumber String?
  total         Int
  eligibleTotal Int
  redeemApplied Int      @default(0) // сколько списали баллами
  earnApplied   Int      @default(0) // сколько начислили
  createdAt     DateTime @default(now())

  @@unique([merchantId, orderId])
  @@index([merchantId, createdAt])
}

model Transaction {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  merchantId String
  merchant   Merchant @relation(fields: [merchantId], references: [id])
  type       TxnType
  amount     Int
  orderId    String?
  createdAt  DateTime @default(now())

  @@index([customerId, createdAt])
  @@index([merchantId, createdAt])
}

model QrNonce {
  jti        String   @id                  // уникальный ID токена (JTI)
  customerId String
  merchantId String?
  issuedAt   DateTime
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime @default(now())

  @@index([merchantId, usedAt])
}

model EventOutbox {
  id          String   @id @default(cuid())
  merchantId  String
  eventType   String
  payload     Json
  status      String   @default("PENDING")
  retries     Int      @default(0)
  nextRetryAt DateTime?
  lastError   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status, nextRetryAt])
  @@index([merchantId, createdAt])
}
