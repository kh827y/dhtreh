# Outbox event (admin)

Ниже — найденные проблемы по странице `admin/app/outbox/event/[id]/page.tsx` и endpoint `GET /merchants/:id/outbox/event/:eventId`. Список отсортирован по убыванию важности.

## P1 — Высокая важность

1. **Повторная отправка уже доставленных событий не ограничена на сервере**
   - **Что происходит:** `POST /merchants/:id/outbox/:eventId/retry` всегда переводит событие в `PENDING`, независимо от текущего `status`.
   - **Риск:** оператор может случайно ретраить событие со статусом `SENT` или `DEAD` и отправить webhook повторно → дублирование интеграционных действий (например, повторные начисления/уведомления) и рассинхрон.
   - **Где:** `api/src/merchants/merchants.service.ts` (`retryOutbox`).
   - **Что сделать:** на сервере блокировать повторный ретрай для `SENT` (и, возможно, `DEAD`) без явного подтверждения; возвращать ошибку или требовать отдельный флаг `force`.

## P2 — Средняя важность

2. **UI подтверждает успех ретрая/удаления без проверки ответа API**
   - **Что происходит:** на странице события `Retry`/`Delete` вызывают `fetch`, но не проверяют `response.ok` и не читают тело ошибки.
   - **Риск:** при 401/404/500 интерфейс всё равно показывает успех (`alert('Retry scheduled')`) или уводит на `/outbox`, создавая ложное ощущение, что действие выполнено.
   - **Где:** `admin/app/outbox/event/[id]/page.tsx` (`doRetry`, `doDelete`).
   - **Что сделать:** проверять `response.ok`, показывать текст ошибки, не перенаправлять пользователя при сбое.

## P3 — Низкая важность

3. **Нет защиты от очень больших payload/lastError → риск подвисания страницы**
   - **Что происходит:** payload и lastError выводятся в UI без ограничения размера и без ленивой подгрузки.
   - **Риск:** если payload содержит большой чек/массивы, рендер страницы может подвисать или «убивать» вкладку в браузере.
   - **Где:** `admin/app/outbox/event/[id]/page.tsx` (рендер `JSON.stringify(data.payload)`), `GET /merchants/:id/outbox/event/:eventId` (возвращает payload полностью).
   - **Что сделать:** ограничить размер отображаемого payload (например, первые N KB + кнопка «Показать полностью»), либо добавить server-side параметр `fields`/`includePayload=false`.
