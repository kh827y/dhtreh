# Портрет клиента — аудит

Ниже проблемы отсортированы по убыванию критичности.

## P1 — Высокая

- **[PERF] `/portal/analytics/portrait` грузит все чеки в память без лимитов периода**
  - **Риск**: при запросе большого периода (кастомный `from/to`) сервис вытягивает все чеки за период и агрегирует в JS. Это может приводить к долгим ответам/таймаутам и росту потребления памяти на проде (особенно если период задаётся произвольно через API).
  - **Где**: `api/src/analytics/analytics.service.ts` (`getCustomerPortrait` делает `receipt.findMany` и потом всю агрегацию в памяти).
  - **Что сделать**: ограничить максимальный период для портальных запросов (например, не более 12 месяцев) и/или перенести агрегации в БД (group by по полу/возрасту), чтобы не выгружать все чеки.

## P2 — Средняя

- **[DATA] Фильтрация по сегменту использует текущее членство, а не историческое состояние на момент покупки**
  - **Риск**: портрет за прошлые периоды будет «плавать» при пересчёте сегментов — один и тот же период покажет разные цифры, что делает аналитику недостоверной.
  - **Где**: `api/src/analytics/analytics.service.ts` (`getCustomerPortrait` фильтрует по `customer.segments` на момент запроса).
  - **Что сделать**: либо фиксировать сегмент на момент операции (снапшоты/лог), либо явно обозначить в UI, что сегмент — текущий, а не исторический (если это допустимо).

- **[DATA] Возвраты учитываются как «полное исключение заказа»**
  - **Риск**: если поддерживаются частичные возвраты, вся продажа исключается из портрета при наличии `REFUND` по `orderId`, что занижает выручку/кол-во покупок и искажает средний чек.
  - **Где**: `api/src/analytics/analytics.service.ts` (`getCustomerPortrait` исключает все чеки по `orderId`, если найден любой `REFUND`).
  - **Что сделать**: либо подтверждать, что возвраты всегда полные, либо учитывать частичные возвраты корректно (уменьшать сумму/транзакции вместо полного исключения).

- **[UI] В списке аудиторий для фильтра отображаются архивные сегменты**
  - **Риск**: пользователи могут фильтровать аналитику по архивным сегментам, которые не используются в текущем бизнес‑процессе, что создаёт путаницу и недоверие к данным.
  - **Где**: `api/src/customer-audiences/customer-audiences.service.ts` (`listSegments` возвращает все сегменты, включая архивные), `merchant-portal/app/analytics/portrait/page.tsx` (список берётся без фильтрации по `archivedAt`).
  - **Что сделать**: исключать архивные сегменты из ответа либо помечать/скрывать их в UI.

## P3 — Низкая

- **[UI] Жёстко задан период `month` без возможности выбора диапазона**
  - **Риск**: аналитика «Портрета клиента» ограничена одним периодом (текущий месяц), что мешает анализу сезонности/динамики; пользователи не понимают, за какой период показаны данные.
  - **Где**: `merchant-portal/app/analytics/portrait/page.tsx` (всегда отправляет `period=month`).
  - **Что сделать**: добавить выбор периода (день/неделя/месяц/квартал/кастом), либо хотя бы явно показать текущий период в UI.
