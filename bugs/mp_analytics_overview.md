# Merchant Portal — Analytics Overview (аудит)

Ниже проблемы отсортированы по убыванию критичности.

## P1 — Высокая важность

1. **Несоответствие KPI и графика выручки из-за разных фильтров чеков.**
   - В дашборде KPI считаются через `getDashboardAggregates`, где учитываются только чеки с `total > 0` (и без refund), а временной ряд для графика строится `getDailyRevenue`, где фильтра `total > 0` нет. В итоге график/сравнение периодов может включать нулевые/отрицательные чеки и показывать значения, не совпадающие с KPI «Выручка»/«Средний чек». Это ломает доверие к цифрам и усложняет сверку. 
   - **Где:** `api/src/analytics/analytics.service.ts` (`getDashboardAggregates`, `getDailyRevenue`), `merchant-portal/app/analytics/page.tsx`.

2. **«Структура продаж» считает не чеки, а клиентов (искажение долей).**
   - В `getCompositionStats` суммируются **клиенты** по первому визиту (new/repeat), а UI подписан как «чеков» и «доля покупок». В результате проценты и абсолютные значения показывают не продажи/чеки, а количество уникальных клиентов. Это неверная бизнес‑интерпретация и вводит мерчанта в заблуждение.
   - **Где:** `api/src/analytics/analytics.service.ts` (`getCompositionStats`), `merchant-portal/app/analytics/page.tsx` (блок «Структура продаж»).

## P2 — Средняя важность

3. **Пересечение текущего и прошлого периода в сравнении.**
   - `getPreviousPeriod` завершает прошлый период ровно в `period.from`, а выборки используют `<= period.to`. Из‑за этого чек/регистрация ровно на границе попадают **в оба периода**, что искажает дельты и «сравнение с предыдущим периодом».
   - **Где:** `api/src/analytics/analytics.service.ts` (`getPreviousPeriod`) + все запросы с `createdAt <= period.to`.

4. **Фильтр «Произвольный» показывает старые данные без явного состояния.**
   - При выборе «Произвольный» без нажатия подтверждения загрузка не выполняется, но UI оставляет предыдущие значения при активном фильтре «custom». Пользователь видит «выбранный период», хотя фактически применён старый диапазон — риск неверных выводов.
   - **Где:** `merchant-portal/app/analytics/page.tsx` (логика `load` и `appliedCustom`).

5. **Нет ограничения на диапазон custom‑периода → риск тяжёлых запросов.**
   - `/portal/analytics/*` принимает `from/to` без лимитов. Пользователь может запросить годы данных, что приводит к тяжёлым `GROUP BY` и длинным циклам построения рядов (особенно `getDailyRevenue`/`getRegistrationsByDay`). Это ухудшит отклик портала и может повесить БД на слабом железе.
   - **Где:** `api/src/portal/portal.controller.ts` (`computePeriod`), `api/src/analytics/analytics.service.ts` (тайм‑серии).

## P3 — Низкая важность

6. **Подписи графика выручки теряют точность для малых значений.**
   - `YAxis` в UI форматирует выручку как `Math.round(value/1000)k`, из-за чего значения меньше 1000 отображаются как `0k`, а точность теряется даже при небольших оборотах малого бизнеса. Это ухудшает читаемость и доверие к графику.
   - **Где:** `merchant-portal/app/analytics/page.tsx` (форматирование `YAxis` в графике выручки).
