# Аудит TTL (admin)

Ниже проблемы отсортированы по убыванию критичности.

## P1 — Высокая важность

1. **Сверка TTL считает «сгоревшие остатки» по другой логике, чем фактическое списание**
   - В `ttlReconciliation` в выборку попадают **все** лоты с `earnedAt < cutoff` без учета `status`/`orderId`, тогда как сгорание выполняется по другим правилам:
     - `PointsBurnWorker` сжигает только `status: 'ACTIVE'` и по клиентам с остатками.
     - `TtlBurnWorker` сжигает только лоты с `orderId != null` (покупочные начисления).
   - Итог: сверка показывает ложные расхождения (включает ручные/бонусные начисления или неактивные лоты), а итоговые diff не соответствуют реальным списаниям.
   - Рекомендация: использовать **одну** бизнес‑логику отбора лотов для burn и reconciliation (минимум — учитывать `status`/`orderId` и выбранный режим burn).

2. **Сверка зависит от «точного» совпадения `cutoff` до секунды, а UI отправляет только дату**
   - UI отправляет `cutoff` в формате `YYYY-MM-DD`, т.е. без времени.
   - В reconciliation сожженные суммы берутся из `eventOutbox` только при точном совпадении `payload.cutoff === cutoff.toISOString()`. В реальных burn‑воркерах `cutoff` содержит текущее время запуска воркера, а не `00:00:00Z`.
   - Итог: даже при корректной работе burn воркера сверка может показывать «burned=0», потому что `cutoff` не совпадает по времени.
   - Рекомендация: либо сравнивать по дате/диапазону, либо приводить `cutoff` к одному стандарту (например, начало дня в UTC) и использовать тот же стандарт в воркерах.

## P2 — Средняя важность

1. **Сверка без ограничений по объему: полная выборка лотов и событий может перегружать БД**
   - `ttlReconciliation` грузит все `earnLot` до cutoff и **все** `eventOutbox` типа `loyalty.points_ttl.burned` по мерчанту без пагинации/окна по времени.
   - На мерчантах с большой историей это может привести к долгим запросам, росту памяти и блокировкам при аудите/экспорте.
   - Рекомендация: фильтровать `eventOutbox` по дате (`createdAt`) и/или ограничивать период сверки; рассмотреть постраничную отдачу или фоновую агрегацию.
