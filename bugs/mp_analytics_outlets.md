# Аудит: аналитика по точкам (merchant-portal)

Ниже — найденные проблемы/недоработки, отсортированные по убыванию критичности.

## P1 — Недостоверные данные

1. **Операционные метрики по точкам считают только чеки с `customerId`, из-за чего выручка/кол-во чеков занижены.**
   - **Где**: `api/src/analytics/analytics.service.ts` → `getOutletMetrics` (SQL фильтры `r."customerId" IS NOT NULL` и `r."outletId" IS NOT NULL`).
   - **Почему это важно**: для офлайн SMB значимая доля продаж может проходить без привязки клиента (walk‑in). Такие чеки полностью выпадают из аналитики по точкам, что делает лидеры/итоги недостоверными и мешает принимать решения.
   - **Что проверить/как воспроизвести**: создать чеки без `customerId` и сравнить «Активность точек» с общей выручкой; показатели будут ниже.
   - **Ожидаемое поведение**: учитывать все чеки с `outletId` независимо от наличия `customerId`, а данные без `outletId` агрегировать в отдельную строку «Без точки» или хотя бы не терять в сумме.

## P2 — UX/логика отображения

2. **Карточки «Лидер по выручке/росту/трафику» показываются даже когда за период нет ни одной продажи.**
   - **Где**: `merchant-portal/app/analytics/outlets/page.tsx` (логика `leaders` строится из `rows`, которые всегда есть, т.к. backend добавляет все точки, даже с нулевыми значениями).
   - **Почему это важно**: на новых мерчантах/в пустых периодах интерфейс демонстрирует «лидеров» с нулевыми значениями, что выглядит как рабочая аналитика и вводит в заблуждение.
   - **Ожидаемое поведение**: если все ключевые показатели равны 0, показывать «Нет данных за выбранный период» и не выводить лидеров.

## P3 — Неполнота портальной аналитики

3. **В портале отсутствует `GET /portal/analytics/business`, хотя бизнес‑метрики реализованы в API.**
   - **Где**: `api/src/analytics/analytics.controller.ts` (`GET /analytics/business/:merchantId`) при отсутствии соответствующего портального маршрута/прокси в `merchant-portal`.
   - **Почему это важно**: если планируется вывод бизнес‑метрик для мерчанта, их нельзя получить из портала (нет `/portal/analytics/business` и нет `/app/api/portal/analytics/business`).
   - **Ожидаемое поведение**: либо добавить портальный endpoint/прокси, либо убрать/пометить как legacy, чтобы не держать «висящую» функциональность только в админском API.
