# Аудит воркера отложенных начислений (EarnActivationWorker)

Ниже перечислены проблемы по убыванию критичности.

## P1 — Высокая критичность

1. **Потеря баллов при отсутствии кошелька: лот активируется, но баланс/транзакции/событие не создаются.**
   - В транзакции статус лота переводится в `ACTIVE`, затем ищется кошелёк; если кошелёк не найден — происходит `return` без отката.
   - В результате лот считается активированным, но:
     - баланс не увеличен;
     - транзакция начисления не создана;
     - запись в `eventOutbox` не создана.
   - Это приводит к необратимой потере начислений и рассинхрону истории/аналитики.
   - Особенно критично при удалённых/битых кошельках или при миграциях.

2. **Гонка/потеря обновлений баланса из‑за неатомарного изменения кошелька.**
   - Баланс читается (`findUnique`) и затем перезаписывается новым значением `balance = old + points`.
   - При параллельных изменениях (например, списание/другие начисления) возможна потеря обновлений и некорректный итоговый баланс.
   - Нужен атомарный `increment` или блокировка строки кошелька.

3. **Активируются просроченные лоты.**
   - Воркёр проверяет только `maturesAt <= now` и игнорирует `expiresAt`.
   - Если система долго была недоступна и срок действия баллов истёк до запуска воркера, баллы всё равно будут начислены.
   - Это нарушает правила TTL и может приводить к неконтролируемой эмиссии баллов.

## P2 — Средняя критичность

4. **Неверная дата транзакции начисления (смещение аналитики/истории).**
   - `Transaction.createdAt` выставляется в `fresh.createdAt` (дата создания лота), а не в момент фактической активации.
   - В аналитике и истории клиента начисление будет отображаться “в прошлом”, хотя баланс увеличился только сейчас.
   - В итоге данные по периодам и мотивационные отчёты становятся недостоверными.

5. **Ошибки обработки батча глушатся и скрыты от логов.**
   - Ошибки `tick()` полностью подавляются (`catch(() => {})`), а при исключении внутри цикла весь батч прерывается.
   - В итоге один проблемный лот может блокировать обработку остальных, а причина останется незаметной (нет логов/метрик ошибок).
   - Для продакшна это риск “тихих” сбоев и накопления очереди.
