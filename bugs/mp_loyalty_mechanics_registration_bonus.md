# Аудит механики «Баллы за регистрацию» (merchant-portal)

Ниже перечислены найденные проблемы и недоработки по механике регистрации. Список отсортирован по убыванию важности устранения.

## Критично / P0

- **Отключение суммирования с рефералкой фактически не работает (риск двойной выдачи бонусов).**
  - **Где:** `api/src/loyalty/loyalty.service.ts` — метод `grantRegistrationBonus()`.
  - **Суть:** при наличии активной реферальной программы с `stackWithRegistration=false` метод должен запрещать выдачу регистрационного бонуса, но это правило обёрнуто в `try { ... } catch {}` и ошибка глушится. В итоге клиент, пришедший по рефералке, всё равно может получить регистрационный бонус, что приводит к абузу баллов и некорректной экономике.
  - **Рекомендация:** убрать глушение исключений и явно блокировать выдачу, если `stackWithRegistration=false`.

## Высокая / P1

- **Отключение “Срока действия” в UI не гарантирует бессрочные баллы.**
  - **Где:** `merchant-portal/app/loyalty/mechanics/registration-bonus/page.tsx`, `merchant-portal/app/api/portal/loyalty/registration-bonus/route.ts`, `api/src/loyalty/loyalty.service.ts`.
  - **Суть:** если в UI выключить “Срок действия”, API удаляет `rules.registration.ttlDays`, но сервис начисления подхватывает `settings.pointsTtlDays` как fallback. В результате приветственные баллы всё равно могут сгорать, несмотря на выключенную опцию на странице механики.
  - **Риск:** несоответствие ожиданий бизнеса и фактических сроков сгорания; споры с клиентами.
  - **Рекомендация:** при выключении `burnEnabled` явно сохранять “бессрочно” (например, `ttlDays=0` и трактовка 0 как «не сгорают») либо явно предупреждать о влиянии глобального TTL.

- **Отключение “Отложенного начисления” в UI не гарантирует мгновенное начисление.**
  - **Где:** `merchant-portal/app/loyalty/mechanics/registration-bonus/page.tsx`, `merchant-portal/app/api/portal/loyalty/registration-bonus/route.ts`, `api/src/loyalty/loyalty.service.ts`.
  - **Суть:** при выключенной опции `delayEnabled` API удаляет `delayDays/delayHours`, но сервис начисления подставляет `settings.earnDelayDays` как fallback. В итоге бонус может начислиться с задержкой, хотя UI показывает “задержка выключена”.
  - **Риск:** расхождение ожиданий мерчанта и фактических сроков начисления; недоверие к системе.
  - **Рекомендация:** аналогично — либо фиксировать «нет задержки» отдельным флагом, либо явно показывать, что действует глобальная задержка начисления.

## Средняя / P2

- **Отложенное начисление работает только при включённом `EARN_LOTS_FEATURE`, иначе задержка игнорируется.**
  - **Где:** `api/src/loyalty/loyalty.service.ts`.
  - **Суть:** при `delayMs > 0` начисление откладывается только если `EARN_LOTS_FEATURE=1`. Если фича отключена, бонус начисляется сразу, хотя в UI выставлена задержка. Это ломает обещания интерфейса и антифрод‑логику (“защита от фрода”).
  - **Рекомендация:** либо блокировать включение задержки без `EARN_LOTS_FEATURE`, либо реализовать отложенное начисление альтернативным механизмом, либо показывать явный warning.

- **Настройки Push‑уведомления в UI не связаны с фактической отправкой.**
  - **Где:** `merchant-portal/app/loyalty/mechanics/registration-bonus/page.tsx`, `api/src/loyalty/loyalty.service.ts`, `api/src/notification-dispatcher.worker.ts`.
  - **Суть:** UI позволяет включить push и задать текст с плейсхолдерами (`%username%`, `%bonus%`), но в backend нет обработчика событий `loyalty.registration.*` и нет отправки push при выдаче регистрационного бонуса. В результате настройки создают ложное ощущение работы.
  - **Рекомендация:** либо реализовать отправку push на события регистрации, либо удалить/скрыть настройку как legacy.

- **Несоответствие формата ответа по сроку сгорания в miniapp.**
  - **Где:** `miniapp/lib/api.ts`, `api/src/loyalty/loyalty.service.ts`.
  - **Суть:** miniapp ожидает поле `expiresInDays`, а сервис возвращает `pointsExpireInDays`. Если miniapp/клиентская логика ориентируется на `expiresInDays`, срок сгорания может не отображаться или трактоваться неверно.
  - **Рекомендация:** синхронизировать контракт (единое название поля) и/или добавить алиас в ответ.

