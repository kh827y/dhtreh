# Аудит реферальной программы (backend)

## Критично

1. **[SEC][TENANT] Рефералы можно активировать/создавать «между» мерчантами (нарушение изоляции данных)**
   - `POST /referral/activate` принимает `refereeId` и активирует код без проверки, что `refereeId` принадлежит тому же мерчанту, что и программа из `code`. Валидации по мерчанту нет ни в контроллере, ни в `ReferralService.activateReferral`.
   - `GET /referral/link/:customerId` полагается на `merchantId` из query. Если его не передать, `getCustomerReferralLink` ищет «первую активную» программу без фильтра по мерчанту и создаёт персональный код на чужого мерчанта.
   - Риск: перемешивание данных, начисления/кошельки на чужие мерчанты, утечки и невозможность корректного учёта.

## Высокий

2. **[ABUSE] Лимиты/сроки реферальной программы фактически не работают**
   - Поля `maxReferrals`, `expiryDays`/`validUntil`, `referral.expiresAt`, `personalReferralCode.isActive` есть в схеме/создании программы, но нигде не используются при активации/начислении.
   - Итог: бесконечные рефералы, невозможность выключить код, отсутствие срока жизни ссылок/программ.

3. **[LOGIC] Дублирование логики начислений: `POST /referral/complete` расходится с основным расчётом и может приводить к двойным/неполным выплатам**
   - Основные начисления рефералам делаются в `LoyaltyService.applyReferralRewards` (учёт `rewardTrigger=all`, multi-level, уровни/проценты) при коммите покупки.
   - `ReferralService.completeReferral` начисляет только базовый reward и всегда завершает связь, игнорируя multi-level и `rewardTrigger=all`.
   - Если интеграция использует `complete` параллельно с обычным `commit`, возможны двойные начисления; если использует только `complete`, multi-level и режим `all` просто не работают.

## Средний

4. **[ABUSE] Процентные награды не ограничены сверху для одноуровневых программ**
   - В `create/update` можно установить `rewardType=PERCENT` и `referrerReward > 100`, при этом при начислении процент берётся «как есть». Это позволяет выплачивать больше 100% от покупки.
   - Ограничение до 100% есть только в `normalizeLevels` для multi-level, но для одноуровневых программ оно не применяется.

5. **[ABUSE] `POST /referral/complete` принимает невалидные суммы (NaN/Infinity) и может выдать награду без реальной покупки**
   - Валидации `purchaseAmount` нет: при `NaN` проверка минимальной суммы фактически обходится, а фиксированная награда начисляется.
   - Это позволяет начислять бонусы без покупки при доступе к API.

