# Аудит наблюдаемости админки (admin/observability)

Ниже — найденные проблемы и недоработки, отсортированные по убыванию критичности.

## P1 — Высокий приоритет

### 1) [SEC] Публичный `NEXT_PUBLIC_API_KEY` фактически не нужен, но блокирует админку и может привести к утечке ключа
**Где:** `admin/lib/admin.ts`, `admin/app/api/admin/[...path]/route.ts`, `admin/app/api/_lib/session.ts`.

**Что не так:**
- Все запросы из `admin/lib/admin.ts` требуют `NEXT_PUBLIC_API_KEY` и прокидывают `x-api-key` в браузерных запросах.
- При этом реальный доступ к API происходит через серверный прокси `/api/admin/*`, который сам добавляет `x-admin-key` на сервере и проверяет cookie‑сессию (`requireSession`).

**Риск:**
- Админка не работает, если `NEXT_PUBLIC_API_KEY` не задан, хотя он не нужен для проксируемых запросов.
- Чтобы «починить», есть соблазн положить `ADMIN_KEY` в `NEXT_PUBLIC_API_KEY`, что **экспонирует админ‑ключ в браузер** (публичный env), давая возможность прямого доступа к API при утечке.

**Ожидание:** убрать требование `NEXT_PUBLIC_API_KEY` для `/api/admin/*` запросов (или заменить на серверный механизм), чтобы клиент не требовал/не раскрывал ключи.

## P2 — Средний приоритет

### 2) [OBS] Метрики 4xx/5xx/Rate‑Limited трактуются как «текущие», хотя это накопительные счётчики
**Где:** `admin/app/observability/page.tsx`, `api/src/metrics.parser.ts`, `api/src/metrics.service.ts`.

**Что не так:**
- UI показывает `HTTP 4xx/5xx/Rate limited` как моментальные значения и подсвечивает предупреждения по порогам.
- В `parsePromMetrics()` используется `http_requests_total` и другие **монотонные счётчики**, которые растут всё время жизни процесса.

**Риск:**
- После накопления первых сотен запросов UI будет **постоянно в красной зоне**, сигнал теряет ценность и реальная деградация может быть пропущена.

**Ожидание:** показывать метрики как rate/дельту за интервал (например, последние N минут) или выводить явный признак «с момента старта».

### 3) [OBS] История инцидентов хранится только в памяти процесса
**Где:** `api/src/alerts/alerts.service.ts`.

**Что не так:**
- `recent` хранится в памяти и обнуляется при рестарте сервиса.
- `/observability/summary` и `/alerts/state` показывают только память текущего процесса.

**Риск:**
- Нет устойчивого аудита инцидентов: после рестарта всё «чисто», и админка теряет историю важной информации.

**Ожидание:** хранить историю инцидентов минимум в БД/логах (или явно обозначить, что это «только runtime‑память» и не использовать для оперативной истории).

## P3 — Низкий приоритет

### 4) [SEC/UX] Эндпоинт тестового алерта можно дернуть через CSRF при открытой сессии
**Где:** `admin/app/observability/page.tsx`, `admin/app/api/admin/[...path]/route.ts`.

**Что не так:**
- Прокси‑роут `/api/admin/*` опирается только на cookie‑сессию и не защищён CSRF‑токеном.
- `POST /alerts/test` может быть вызван со стороннего сайта, если у админа открыта сессия.

**Риск:**
- Возможен спам тестовых алертов (или иных admin‑действий) без явного участия администратора.

**Ожидание:** добавить CSRF‑защиту/anti‑CSRF токен хотя бы для изменяющих операций (включая тестовые алерты).
