# Аудит backend лояльности (loyalty core)

Ниже — найденные проблемы по убыванию критичности. Дубликаты из `FIX.md` не включал.

## P1 — High

---

### 3) Потеря данных/баланса при мердже профиля по телефону
**Риск:** когда клиент с Telegram-аккаунтом вводит телефон, который уже есть у другого `Customer`, код переключает `targetCustomer` на найденную запись, но **не мигрирует** старые данные (кошелёк/транзакции/consent/промо-участия) из “временного” пользователя. Это может привести к «потере» баллов и истории, а также рассинхрону профиля/кошелька.

**Где видно:**
- В `saveProfile()` при совпадении телефона выбирается `existingByPhone` как `targetCustomer`, `tgId` переносится, но нет переноса баланса/транзакций/consent (обновляется только `targetCustomer`).【F:api/src/loyalty/loyalty.controller.ts†L2895-L2988】

**Что сделать:** при совпадении телефона переносить связанные сущности (wallet, transactions, consent, promotions/segments) на `targetCustomer` или жёстко запрещать мердж, если у текущего клиента уже есть начисления/история.

## P2 — Medium
