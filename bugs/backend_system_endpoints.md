# Аудит системных эндпоинтов backend

Проверены контроллеры: `api/src/app.controller.ts`, `api/src/health.controller.ts`, `api/src/metrics.controller.ts`, `api/src/admin-observability.controller.ts`.

Ниже — найденные проблемы по убыванию критичности (без дубликатов из `FIX.md`).

## P1 — High

### 1) Публичные health/ready эндпоинты раскрывают внутреннюю информацию о системе
**Где:** `GET /healthz`, `GET /readyz`.

**Что происходит:** ответы содержат внутренние флаги фич (`LEDGER_FEATURE`, `POINTS_TTL_FEATURE` и т.п.), версию приложения, статусы воркеров и их `lastTickAt`. Также на ошибках возвращается текст исключения (`error: String(e.message)`), что может раскрывать детали БД/инфраструктуры.

**Риск:** облегчение разведки для атакующего и утечки операционных деталей. В проде это часто считается чувствительной информацией.

**Что сделать (без overengineering):**
- либо ограничить доступ (например, IP allowlist/токен),
- либо урезать ответ до `ok/ready + timestamp` без флагов/worker‑метаданных и без сырых ошибок.

## P2 — Medium

### 3) Readiness может становиться `true` при сломанной схеме БД
**Где:** `GET /readyz`.

**Что происходит:** проверка миграций обёрнута в `try/catch` без обработки. Если таблицы `_prisma_migrations` нет или запрос падает, endpoint всё равно возвращает `ready: true`.

**Риск:** сервис будет считаться готовым при несовместимой/пустой схеме БД, что приводит к каскадным ошибкам уже под трафиком.

**Что сделать:** если проверка миграций падает — отдавать `ready:false` и соответствующий HTTP‑код (или явно указывать, что миграции неизвестны и снижать статус готовности).
