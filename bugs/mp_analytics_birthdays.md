# Аудит: /analytics/birthdays и /portal/analytics/birthdays

Ниже проблемы отсортированы по убыванию важности.

## P2 — Высокий приоритет

### 1) /portal/analytics/birthdays пропускает клиентов с днём рождения «сегодня»
**Где:** `api/src/analytics/analytics.service.ts` (`getBirthdays`).
**Что происходит:** логика `nextDate()` сравнивает дату рождения, выставленную на 00:00, с текущим временем. Если сейчас уже позже полуночи, дата считается «в прошлом» и переносится на следующий год. В результате клиенты, у которых день рождения сегодня, не попадают в список ближайших, даже при `withinDays >= 1`.
**Риск/эффект:** список ближайших дней рождений искажён — в день Х пользователи не увидят «сегодняшних» именинников, что ломает операционные процессы (прозвоны/поздравления).

### 2) Не учитывается таймзона мерчанта при вычислении ближайших дней рождения
**Где:** `api/src/analytics/analytics.service.ts` (`getBirthdays`).
**Что происходит:** используется системное время сервера (`new Date()`), границы `withinDays` вычисляются в этой таймзоне, а дата рождения сравнивается без нормализации под TZ мерчанта.
**Риск/эффект:** для мерчантов в другой таймзоне (особенно ±3–6 часов) клиенты могут попадать в список «ближайших» на день раньше/позже, что снижает доверие к аналитике.

### 3) Список ближайших дней рождения может быть неполным из‑за жёсткого `take: 5000`
**Где:** `api/src/analytics/analytics.service.ts` (`getBirthdays`).
**Что происходит:** выбираются максимум 5000 клиентов, затем фильтрация по дате и `limit`. Если клиентов с заполненной датой рождения больше, список становится случайно усечённым (порядок выборки не фиксируется).
**Риск/эффект:** аналитика показывает неполные данные для крупных баз, а выборка «прыгает» между запросами.

## P3 — Средний приоритет

### 4) Страница /analytics/birthdays не предоставляет функционал списка ближайших дней рождения
**Где:** `merchant-portal/app/analytics/birthdays/page.tsx`, `merchant-portal/app/loyalty/mechanics/birthday/page.tsx`.
**Что происходит:** путь `/analytics/birthdays` в портале просто редиректит на механику поздравлений (`/loyalty/mechanics/birthday?tab=stats`), где нет списка ближайших дней рождений и не используется `/portal/analytics/birthdays`.
**Риск/эффект:** эндпоинт `/portal/analytics/birthdays` не имеет UI‑потребителя; функциональность «ближайшие дни рождения» фактически недоступна пользователям портала.
