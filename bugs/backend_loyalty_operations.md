# Аудит: логи операций лояльности (GET /portal/loyalty/operations)

## P1 — High

### 1) Логи механик фактически никогда не пишутся → раздел `MECHANIC` всегда пустой
- **Почему это важно:** интерфейс/аналитика будут показывать отсутствие операций по механикам даже при реальных изменениях; аудит изменений механик невозможен.
- **Причина:** в коде есть таблица `LoyaltyMechanicLog` и чтение из неё в `operationsLog`, но отсутствуют любые записи в эту таблицу при создании/обновлении/смене статуса/удалении механик.
- **Где видно:** `operationsLog` читает `loyaltyMechanicLog`, а методы `createMechanic/updateMechanic/changeMechanicStatus/deleteMechanic` логируют только в `logger` и метрики, без записи в `LoyaltyMechanicLog`.
- **Риск:** неполный журнал действий + несоответствие ожиданиям “операций лояльности”.

### 2) Журнал обрезается до 200 записей на тип без пагинации/total → неполные данные без предупреждения
- **Почему это важно:** при активных акциях/промокодах журнал операций будет показывать лишь “хвост”, скрывая старые операции и создавая ложное ощущение отсутствия действий.
- **Причина:** в `operationsLog` используется `take: 200` для каждого типа, но нет параметров `limit/offset` и нет `total` для контроля полноты.
- **Риск:** менеджер видит неполную картину, а аналитика/проверка начислений становятся ненадёжными.

## P2 — Medium

### 3) Неверные временные метки для событий промокодов/акций
- **Почему это важно:** консистентность данных нарушается, фильтрация по `from/to` может показывать не те операции, что реально происходили в период.
- **Причина:**
  - Для `PromoCodeUsage` фильтрация идёт по `createdAt`, хотя реальное событие — `usedAt`.
  - Для `PromotionParticipant` фильтрация идёт по `createdAt`, хотя факт участия — `joinedAt`.
- **Риск:** при импорте/миграциях/асинхронных процессах время записи отличается от времени фактического события → смещение статистики и журналов.

### 4) Валидация входных параметров отсутствует → неочевидные ошибки и пустые ответы
- **Почему это важно:** неверные/пустые данные в ответе выглядят как “нет операций”, хотя фактически это ошибка запроса.
- **Причина:**
  - `type` принимается как строка без проверки допустимых значений; при опечатке лог просто пустой.
  - `from/to` напрямую преобразуются через `new Date()`, что при невалидной дате приводит к `Invalid Date` и потенциальным ошибкам Prisma.
- **Риск:** в проде это приводит к нестабильности и спорным данным при фильтрации.

## P3 — Low

### 5) Спецификация API не описывает параметры эндпоинта
- **Почему это важно:** интеграторам/фронтенду сложно корректно использовать фильтры.
- **Причина:** в `openapi.generated.json` у `/portal/loyalty/operations` нет описания параметров `type/from/to`, хотя они используются в контроллере.
- **Риск:** повышенная нагрузка на поддержку и ошибки использования.
