# Аудит админского дашборда

Ниже — проблемы и недоработки, отсортированные по убыванию критичности.

## P0 — критично

1. **Админский дашборд не сможет загрузить метрики и список мерчантов из-за неверного заголовка авторизации и CORS.**
   - `admin/lib/admin.ts` отправляет `x-api-key`, а `admin/lib/merchants.ts` вообще не отправляет админский ключ.
   - На API все админские эндпоинты защищены `AdminGuard`, который принимает только `x-admin-key`.
   - В `api/src/main.ts` CORS разрешает `x-admin-key`, но не `x-api-key`, поэтому браузерный запрос с `x-api-key` блокируется preflight’ом.
   - Итог: `admin/app/page.tsx` будет получать 401/ CORS при запросах `/observability/summary` и `/api/admin/merchants`.

2. **Админский ключ вынуждено утекать в браузер, иначе дашборд не работает.**
   - `admin/lib/admin.ts` берет ключ из `NEXT_PUBLIC_API_KEY` (публичная переменная), а `admin/app/page.tsx` — клиентский компонент.
   - Если положить туда настоящий `ADMIN_KEY`, любой пользователь, имеющий доступ к админке, получает этот секрет и может дергать любые админские API напрямую.
   - Это фактически делает админский ключ «публичным» и нивелирует защиту `AdminGuard`.

## P1 — высокий приоритет

3. **Часть админских запросов формируется с несуществующими/несовпадающими payload’ами.**
   - `admin/lib/merchants.ts` отправляет `{ name, email, password }`, а админ API ожидает `{ name, portalEmail, portalPassword }`.
   - Итог: создание/обновление мерчанта через UI, скорее всего, не установит email/пароль для портала.

4. **Обновление мерчанта всегда снимает архивность.**
   - В `AdminMerchantsController.updateMerchant()` поле `archived` задано как `body.archived ?? false`.
   - Любой PATCH/PUT без `archived` автоматически разархивирует мерчанта, что может включить доступы «по ошибке».

## P2 — средний приоритет

5. **UI ожидает поля в списке мерчантов, которых нет в admin API.**
   - `admin/lib/merchants.ts` ожидает `settings` (`earnBps`, `redeemLimitBps`, `qrTtlSec`, `requireBridgeSig`, `requireStaffKey`, `maxOutlets`) и «подкладывает» дефолты.
   - `admin/merchants` возвращает только базовые поля + subscription, без `settings`.
   - Итог: в админке могут отображаться фиктивные значения (не соответствующие фактическим настройкам мерчанта), что вводит оператора в заблуждение.
