# Аудит backend подписок

Ниже перечислены проблемы по убыванию критичности. Дубли из `FIX.md` не включались.

## P2 — Medium

### 3) Несогласованная логика лимитов между API, проверками и cron
- **Риск/эффект:** клиент/мерчант видит в статистике и предупреждениях разные значения, возможны ложные предупреждения/блокировки или их отсутствие.
- **Проявления:**
  - `getUsageStatistics` и `validatePlanLimits` считают транзакции за последние 30 дней, а cron‑предупреждения — с начала календарного месяца.
  - В cron‑проверке лимита клиентов используется `wallet.count`, что считает кошельки, а не уникальных клиентов; при нескольких типах кошельков это завышает использование.
- **Где:** `api/src/subscription/subscription.service.ts` (`getUsageStatistics`, `validatePlanLimits`), `api/src/subscription/subscription.cron.ts` (`checkUsageLimits`).

## P3 — Low

### 5) Эндпоинт проверки лимитов принимает произвольный план без валидации
- **Риск/эффект:** клиент может отправить «план без лимитов» и получить `valid: true`, что делает эндпоинт недостоверным для фронта/интеграций.
- **Причина:** если в body пришёл объект с `id`, то он используется напрямую, без `ensurePlan()` и без валидации структуры/ограничений.
- **Где:** `api/src/subscription/subscription.controller.ts` (`validatePlanLimits`).
