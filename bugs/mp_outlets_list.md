# Аудит merchant-portal: список торговых точек (/portal/outlets)

## P1 — Критично

### 1) Удаление торговой точки может ломаться или приводить к потере исторических данных
- **Где**: UI вызывает `DELETE /api/portal/outlets/:id` на странице списка (`merchant-portal/app/outlets/page.tsx`, `merchant-portal/app/api/portal/outlets/[id]/route.ts`).
- **Что не так**:
  - В API удаление выполняется через `MerchantsService.deleteOutlet()` и делает **жёсткое удаление** записи `outlet` (`prisma.outlet.delete`).
  - У `Outlet` есть множество связанных сущностей (чеки, транзакции, холды, начисления, staff‑доступы и т.д.) без каскадного удаления на стороне БД. При наличии истории такие связи **заблокируют удаление** и операция упадёт с 500/400.
  - Даже если удаление всё‑таки проходит, это уничтожает историю точки — риск для отчетности/аудита и последующих возвратов.
- **Риск**: пользователи видят кнопку «Удалить», но фактически не могут удалить рабочую точку, либо случайно теряют историю. Это критично для продакшна и поддержки.
- **Что делать** (без overengineering): вместо hard‑delete перевести точку в `INACTIVE`/`hidden` (soft‑delete) и/или показывать запрет удаления при наличии транзакций/чеков.

## P2 — Высокий приоритет

### 2) Дублируются контроллеры на одном и том же маршруте `/portal/outlets`
- **Где**: 
  - `api/src/portal/portal.controller.ts` (`@Controller('portal')` → `GET/POST/PUT/DELETE /portal/outlets`),
  - `api/src/merchant-panel/controllers/outlets.controller.ts` (`@Controller('portal/outlets')`).
- **Что не так**:
  - Два контроллера регистрируют **одни и те же URL**. В NestJS порядок обработки может быть неочевидным → на проде реально может отвечать «не тот» контроллер.
  - Контроллеры возвращают **разные форматы**: `PortalController` даёт `{ items, total }`, а `OutletsController` — `{ items, meta }` с пагинацией по умолчанию (pageSize=20). Порядок сортировки тоже разный (`asc` vs `desc`).
- **Риск**: список точек в портале может показывать не те данные, ограничиваться первой страницей или внезапно менять сортировку/количество без изменений в UI.
- **Что делать**: оставить один каноничный контроллер для `/portal/outlets`, второй убрать или переименовать под другой namespace.

### 3) UI не учитывает пагинацию и `total`, поэтому список и счётчики могут быть некорректными
- **Где**: `merchant-portal/app/outlets/page.tsx`.
- **Что не так**:
  - UI берёт счётчики только из `activeOutlets.length`/`inactiveOutlets.length`.
  - Если фактически отвечает `OutletsController` (или в будущем добавится пагинация), то возвращается **только первая страница** (20 элементов), а `total`/`meta.total` игнорируется.
- **Риск**: для мерчанта с большим числом точек UI показывает неполные списки и заниженные счётчики.
- **Что делать**: читать `total`/`meta.total` и либо запрашивать все страницы, либо реализовать пагинацию/«показать ещё».
