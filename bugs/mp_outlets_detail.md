# Аудит: карточка торговой точки (merchant-portal/outlets/[id])

Ниже проблемы отсортированы по убыванию критичности.

## P1 — Security/Integrity

1. **Bridge-secret генерируется через `Math.random()` → предсказуемые ключи для подписи.**
   - **Риск:** подпись Bridge (используется в кассовых/интеграционных запросах) опирается на этот секрет. Предсказуемая генерация снижает стойкость ключа и повышает риск подбора/подделки подписи.
   - **Где:** `api/src/merchants/merchants.service.ts` (`issueOutletBridgeSecret`, `issueOutletBridgeSecretNext`, `randToken`).
   - **Как исправить:** заменить генерацию на криптографически стойкую (`crypto.randomBytes`) и, при необходимости, ограничить/логировать выдачу секретов.

## P2 — Functional/Architecture

2. **Дублирующиеся контроллеры для `/portal/outlets/*` (PortalController и MerchantPanel OutletsController) создают неочевидное поведение и риск расхождения логики.**
   - **Риск:** в зависимости от порядка регистрации модулей фактическая логика обработки может отличаться (валидация ссылок на отзывы, формат расписания, сортировка/пагинация и структура ответа). Это усложняет сопровождение и приводит к нестабильным результатам и ошибкам при расширении функционала.
   - **Где:** `api/src/portal/portal.controller.ts` и `api/src/merchant-panel/controllers/outlets.controller.ts`.
   - **Как исправить:** оставить один «источник истины» для `/portal/outlets` (второй контроллер удалить как legacy или явно развести неймспейсами/версиями API).

3. **Отсутствует UI/прокси-роуты для управления `bridge-secret` в merchant-portal.**
   - **Риск:** мерчант не может выпускать/отзывать/ротировать `bridge-secret` из портала, хотя в API это предусмотрено. Это делает интеграцию с Bridge неполной и завязанной на ручные/админские операции.
   - **Где:** есть backend-роуты `/portal/outlets/:outletId/bridge-secret` и `/portal/outlets/:outletId/bridge-secret/next` в `api/src/portal/portal.controller.ts`, но в `merchant-portal` отсутствуют соответствующие UI/API-роуты.
   - **Как исправить:** добавить управление секретами в карточку торговой точки или отдельный раздел интеграций (без излишней сложности — хотя бы кнопки «выпустить/отозвать/сгенерировать следующий»).

## P3 — UX/Data completeness

4. **Список сотрудников на карточке точки жёстко ограничен `pageSize=100` без пагинации или предупреждения.**
   - **Риск:** при 100+ сотрудниках список неполный, пользователь не понимает, что часть данных скрыта.
   - **Где:** `merchant-portal/app/outlets/[id]/page.tsx` (запрос `/api/portal/staff?outletId=...&pageSize=100`).
   - **Как исправить:** добавить пагинацию/индикатор «показаны первые N» или кнопку дозагрузки.
