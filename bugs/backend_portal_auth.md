# Аудит portal-auth (backend)

Ниже — найденные проблемы в `POST /portal/auth/login`, `POST /portal/auth/refresh`, `GET /portal/auth/me` и связанной логике JWT/refresh. Проблемы отсортированы по убыванию критичности.

## P1 — Высокая

### 1) Ротация refresh-токенов не работает: старые refresh остаются валидными до истечения TTL
**Риск:** при утечке refresh-токена злоумышленник сможет бесконечно обновлять доступ (в рамках TTL), даже если пользователь выполняет «обновление» и получает новый токен. Фактически «ротация» не отключает старый токен и не защищает от повторного использования.

**Причина:** refresh-токены нигде не хранятся/не отслеживаются (нет `jti`/семейства токенов, нет blacklist/whitelist). `POST /portal/auth/refresh` просто подписывает новый refresh, но не инвалидирует старый и не проверяет повторное использование.

**Где смотреть:**
- `api/src/portal-auth/portal-auth.controller.ts` (`refresh`)
- `api/src/portal-auth/portal-jwt.util.ts` (refresh JWT — нет `jti`, нет привязки к сессии)

**Что сделать (без overengineering):**
- добавить в refresh JWT `jti` и хранить хэш последнего валидного refresh токена у пользователя (merchant/staff) или в отдельной таблице;
- при `refresh` проверять, что текущий refresh совпадает с последним сохранённым, и сразу заменять его новым (одноразовость);
- при повторном использовании старого refresh — отклонять запрос и по возможности инвалидировать сессию.

### 2) Refresh не проверяет актуальный статус аккаунта (staff/merchant)
**Риск:** блокировка или отзыв доступа не остановит выпуск новых access-токенов по уже выданному refresh. Например, уволенный сотрудник сможет обновлять access-токен до конца срока refresh (по умолчанию 30 дней), что усложняет «мгновенное» отключение доступа.

**Причина:** `POST /portal/auth/refresh` доверяет только подписи refresh-токена и не проверяет, что staff активен, `portalAccessEnabled`/`canAccessPortal` включены, а merchant не отключён.

**Где смотреть:**
- `api/src/portal-auth/portal-auth.controller.ts` (`refresh`)

**Что сделать (без overengineering):**
- при refresh подтянуть запись staff/merchant и повторить ключевые проверки статуса и доступа (как в `login`/`PortalGuard`), иначе возвращать 401.

## P2 — Средняя

### 3) Нет механизма отзыва JWT при смене пароля/сбросе доступов
**Риск:** при компрометации access/refresh пользователь не может «мгновенно» отозвать токены. Даже после смены пароля или отключения доступа у staff refresh может оставаться валидным, а access живёт до 24 часов.

**Причина:** в claims нет «версии токенов пользователя», и она не сверяется с БД. `PortalGuard` для staff проверяет статус/доступ, но для merchant нет ревокации или проверки флага `portalLoginEnabled`/аналогичных настроек.

**Где смотреть:**
- `api/src/portal-auth/portal-jwt.util.ts`
- `api/src/portal-auth/portal-auth.controller.ts`
- `api/src/portal-auth/portal.guard.ts`

**Что сделать (без overengineering):**
- добавить `tokenVersion` (или `passwordChangedAt`) в БД и проверять его при `verifyPortalJwt`/`PortalGuard`;
- либо хранить минимальный «revokedBefore` timestamp в merchant/staff и сравнивать с `iat` токена.

### 4) /portal/auth/me не проверяет актуальность staff-статуса
**Риск:** endpoint выдаёт сведения из токена даже если staff уже отключён/удалён. Это упрощает проверку валидности украденных токенов и может вводить в заблуждение админов (пользователь «ещё жив»).

**Причина:** `GET /portal/auth/me` делает только `verifyPortalJwt`, без обращений к БД и без `PortalGuard`.

**Где смотреть:**
- `api/src/portal-auth/portal-auth.controller.ts` (`me`)

**Что сделать (без overengineering):**
- для staff повторять проверку статуса (минимум `ACTIVE`, `portalAccessEnabled`, `canAccessPortal`), либо завернуть endpoint в `PortalGuard`.

## P3 — Низкая

### 5) Нет ограничений на попытки входа (bruteforce)
**Риск:** при отсутствии rate‑limit злоумышленник может перебрать пароли к staff/merchant (особенно если email известен из публичных источников). Для небольшого числа клиентов это всё ещё реалистичный риск.

**Причина:** в `POST /portal/auth/login` отсутствуют лимиты на количество попыток, нет блокировок по IP/email, нет задержек.

**Где смотреть:**
- `api/src/portal-auth/portal-auth.controller.ts` (`login`)

**Что сделать (без overengineering):**
- базовый rate‑limit по IP и по email (например, 5–10 попыток / 10 минут),
- простая временная блокировка на 15–30 минут при превышении лимита.
