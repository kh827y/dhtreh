# Аудит отзывов (merchant-portal /portal/reviews /loyalty/reviews)

## P1 — Высокий приоритет

1) **Можно привязать отзыв к «чужому» orderId при валидном transactionId (несоответствие заказа и транзакции).**
   - **Где:** `api/src/reviews/review.service.ts` (формирование `finalOrderId`), `api/src/loyalty/loyalty.controller.ts` (`submitReview`).
   - **Как проявляется:** если клиент отправит `transactionId` своей покупки и подставит другой `orderId`, сервис возьмёт `orderId` из запроса без проверки соответствия транзакции. В результате отзыв будет связан с чужим заказом/торговой точкой, что искажает отчёты и фильтры в портале.
   - **Риск:** некорректная аналитика и привязка отзывов к не тем точкам/сотрудникам; возможны злоупотребления (фиктивные отзывы на нужную точку).
   - **Что проверить/исправить:** при наличии `transactionId` сравнивать `orderId` с `anchorTransaction.orderId` и отклонять несовпадения; либо игнорировать входной `orderId` и брать только из транзакции.

## P2 — Средний приоритет

2) **Фильтр “Только с комментарием” включает отзывы без комментария.**
   - **Где:** `api/src/portal/services/reviews.service.ts` (`where.comment = { not: '' }`).
   - **Как проявляется:** фильтр пропускает записи с `comment = null` (и потенциально с пробельными строками), поэтому в списке могут отображаться отзывы “Без комментария”, хотя фильтр выбран.
   - **Риск:** некорректная выдача в портале, вводит в заблуждение сотрудников.
   - **Что проверить/исправить:** фильтровать по `comment` одновременно `not: null` и `not: ''` (или `comment: { notIn: [null, ''] }`).

## P3 — Низкий приоритет

3) **В фильтре устройств отображается “(undefined)” вместо названия точки.**
   - **Где:** `merchant-portal/app/reviews/page.tsx` (формирование `deviceOptions`), `api/src/portal/catalog.service.ts` (`mapDevices` не возвращает `outletName`).
   - **Как проявляется:** в UI подписи устройств строятся как `CODE (outletName)`, но `outletName` не приходит из API, поэтому в списке видно “CODE (undefined)”.
   - **Риск:** ухудшение UX и путаница при выборе устройства.
   - **Что проверить/исправить:** либо передавать `outletName` вместе с устройством в ответе `/portal/outlets`, либо собирать подпись на фронте из имени точки, которая уже есть в объекте `outlet`.
