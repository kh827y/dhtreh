# Аудит: admin exports / import-export / merchants CSV

Ниже перечислены проблемы и недоработки, найденные при проверке:
- `admin/app/exports/page.tsx`
- `/import-export/*`
- `/merchants/:id/*.csv`

Проблемы отсортированы по убыванию критичности.

## P1 — Высокая

### 1) Импорт транзакций может привязать запись к произвольному клиенту при пустом телефоне/email
**Риск:** если в CSV/Excel строке нет телефона и email, импорт всё равно создаёт транзакцию, а поиск клиента выполняется по пустым критериям. В результате запись может быть привязана к «первому попавшемуся» клиенту мерчанта → порча данных, неверные списания/начисления, споры с клиентами.  
**Где:** `ImportExportService.findCustomerByRow()` использует OR с `{ phone: undefined }` / `{ email: undefined }`, что для Prisma превращается в пустые фильтры.  
**Что сделать:** если телефон и email отсутствуют — сразу возвращать ошибку по строке импорта (обязательные поля), не выполнять поиск.  

### 2) Экспорт клиентов по умолчанию собирает все данные в память (Excel) и может упасть на объёмах
**Риск:** `GET /import-export/export/customers` по умолчанию формирует Excel (не потоково) и делает `findMany` без пагинации. На 50–100 мерчантов это быстро превращается в OOM/долгий ответ и блокировки.  
**Где:** `ImportExportController.exportCustomers()` (format default = `excel`) + `ImportExportService.exportCustomers()`.  
**Что сделать:** либо сделать потоковую выгрузку по умолчанию, либо обязать `format=csv` для больших объёмов (или лимитировать экспорт).  

### 3) Нет ограничений на размер загружаемых файлов в import/export
**Риск:** `FileInterceptor` без лимитов позволяет грузить большие файлы в память → риск DoS по памяти/процессу API.  
**Где:** `ImportExportController` (`import/customers`, `import/transactions`, `bulk-update/customers`, `portal/customers/import`).  
**Что сделать:** добавить лимиты размера файла и/или стриминг, плюс раннюю проверку размера.  

## P2 — Средняя

### 4) Лимит в админском UI экспорта не влияет на CSV (используется другой параметр)
**Риск:** админ меняет `Лимит`, но бэкенд этот параметр не использует → ожидания не совпадают, выгрузки могут быть слишком большими или всегда по умолчанию.  
**Где:** `admin/app/exports/page.tsx` формирует `?limit=...`, а эндпоинты `/merchants/:id/*.csv` используют `batch` (см. `MerchantsController.exportTxCsv/exportReceiptsCsv/exportLedgerCsv`).  
**Что сделать:** синхронизировать параметр (`batch` vs `limit`) или унифицировать название на всех слоях.  

### 5) `/import-export/bulk-update/customers` игнорирует `operation` и `value`
**Риск:** заявленный массовый апдейт фактически делает только обычный импорт клиентов, без применения выбранной операции (add_points / set_balance / add_tags / update_fields). Пользователь думает, что массово обновил данные, но изменения не применились.  
**Где:** `ImportExportController.bulkUpdateCustomers()` всегда вызывает `importCustomers()` с `updateExisting: true`, без обработки `operation/value`.  
**Что сделать:** реализовать конкретные операции или убрать endpoint/поля как legacy, чтобы не вводить в заблуждение.  

### 6) `GET /import-export/stats/:merchantId` не использует параметр пути
**Риск:** endpoint возвращает «заглушку» и игнорирует `:merchantId`, потому что читает его из query. Это ломает корректную интеграцию и не позволяет получать статистику по мерчанту.  
**Где:** `ImportExportController.getImportExportStats()` использует `@Query('merchantId')` вместо `@Param('merchantId')`.  
**Что сделать:** использовать path-параметр или убрать `:merchantId` из маршрута.  

### 7) CSV-экспорт уязвим к формульной инъекции (CSV injection)
**Риск:** если данные клиента содержат значения, начинающиеся с `=`, `+`, `-`, `@`, то при открытии в Excel возможны формульные инъекции (запросы на внешние ресурсы, подмена данных).  
**Где:** CSV-экспорт в `MerchantsController` и `ImportExportService` пишет поля напрямую без нейтрализации формул.  
**Что сделать:** экранировать такие значения (например, префикс `'` или пробел) перед экспортом.  
