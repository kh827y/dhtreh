# Аудит: backend + UI по группам доступа (portal)

Ниже — найденные проблемы, отсортированные по убыванию критичности.

## P1 — Security / доступы

- **[Portal][SEC] Возможна привязка сотрудников другого мерчанта к группам доступа (межтенантное расширение прав)**
  - **Риск:** пользователь мерчанта А может добавить в группу доступа `staffId` мерчанта Б. В `PortalGuard` при расчёте прав у сотрудника Б учитываются все его членства без фильтрации по `merchantId`, поэтому сотрудник Б получает права группы мерчанта А в своём портале. Это приводит к некорректному повышению прав и нарушению изоляции мерчантов.
  - **Где:**
    - `MerchantPanelService.setGroupMembers()` принимает `staffIds` без проверки принадлежности сотрудника мерчанту.【F:api/src/merchant-panel/merchant-panel.service.ts†L1763-L1820】
    - `PortalGuard` подгружает `accessGroupMemberships` только по `scope`, без фильтра по `group.merchantId`。【F:api/src/portal-auth/portal.guard.ts†L52-L95】
  - **Что сделать:** при установке участников проверять, что все `staffIds` принадлежат `merchantId`; дополнительно фильтровать `accessGroupMemberships` по `group.merchantId`.

## P2 — Функциональные ошибки UI/portal

- **[Portal][UI] Управление составом группы работает только для первых 20 сотрудников — остальные теряются**
  - **Проявление:** страница групп доступа берет список сотрудников через `/api/portal/staff` без пагинации, а дефолтная пагинация в API — `pageSize=20`. В результате в UI отображаются и редактируются только первые 20 сотрудников, а при сохранении состава группы остальные участники **будут удалены** (т.к. `staffIds` формируются только из подгруженной страницы).
  - **Где:**
    - UI загружает сотрудников без `pageSize`, используется для вычисления `staffIds` группы.【F:merchant-portal/app/settings/access/page.tsx†L85-L207】
    - Дефолтный `pageSize=20` в `PaginationQueryDto`.【F:api/src/common/dto/pagination.dto.ts†L8-L28】
  - **Что сделать:** запрашивать всех сотрудников (например, `pageSize=200` + пагинация/поиск), либо получить участников группы через отдельный endpoint и отображать/изменять их без опоры на общий список.

## P3 — Низкий приоритет / legacy

- **[Portal][DX] API-прокси для списка групп доступа игнорирует query-параметры и содержит некорректный fallback**
  - **Проявление:** `/api/portal/access-groups` не прокидывает `search/page/pageSize` в backend и, при 404, пытается построить группы из `/portal/staff`, ожидая массив, хотя API отдаёт пагинированный объект. Это ломает фильтрацию/пагинацию и может показывать «фейковые» группы, если backend-роут недоступен.
  - **Где:** `merchant-portal/app/api/portal/access-groups/route.ts`.【F:merchant-portal/app/api/portal/access-groups/route.ts†L1-L55】
  - **Что сделать:** прокидывать `req.nextUrl.search` в backend и либо удалить legacy-fallback, либо корректно обрабатывать пагинированный ответ `/portal/staff`.
