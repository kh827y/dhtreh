# Аудит: Telegram‑рассылки и Telegram Mini App (merchant-portal)

Ниже проблемы отсортированы по убыванию критичности. Дубликаты из `FIX.md` не включал.

## Высокая критичность

### 1) Некорректный Mini App URL при отсутствии `MINIAPP_BASE_URL`
- **Где**: `api/src/telegram/telegram-bot.service.ts` (регистрация бота).
- **Что происходит**: при регистрации бота `miniappBaseUrl` записывается как `${MINIAPP_BASE_URL}/?merchant=...` без проверки наличия `MINIAPP_BASE_URL`. Если env не задан, в БД попадёт строка вида `undefined/?merchant=...`. Такой URL затем используется в кнопках/сообщениях бота.
- **Риск**: клиентам приходит нерабочая кнопка Mini App; Telegram может отклонять сообщения/кнопки с невалидным URL. Проблема заметна сразу в проде при ошибке конфигурации.
- **Доказательство в коде**: установка `miniappBaseUrl` без валидации и нормализации базового URL в `registerBot`.【F:api/src/telegram/telegram-bot.service.ts†L95-L122】

### 2) Ложноположительный статус «подключено/здорово» после ошибки вебхука
- **Где**: `api/src/telegram/telegram-bot.service.ts`, `api/src/portal/services/telegram-integration.service.ts`.
- **Что происходит**: `registerBot()` создаёт/обновляет `telegramBot` с `isActive: true`, даже если установка webhook завершилась ошибкой. В `getState()` признак `connectionHealthy` рассчитывается как `telegramBotEnabled && telegramBot.isActive`, поэтому UI может показывать «подключено», хотя webhook не установлен.
- **Риск**: рассылки и события не дойдут до бота, а в интерфейсе это выглядит как «всё ок», что мешает диагностике.
- **Доказательство в коде**: `isActive: true` при upsert и отсутствие отката при ошибке; `connectionHealthy` завязан на `telegramBot.isActive`.【F:api/src/telegram/telegram-bot.service.ts†L104-L159】【F:api/src/portal/services/telegram-integration.service.ts†L93-L107】

## Средняя критичность

### 3) Потеря рассылки при ошибке сохранения в режиме редактирования
- **Где**: `merchant-portal/app/loyalty/telegram/page.tsx`.
- **Что происходит**: при редактировании рассылки сначала вызывается `cancel` старой кампании, затем создаётся новая. Если создание новой рассылки падает (сеть/валидация/лимиты), исходная уже отменена — пользователь теряет кампанию.
- **Риск**: потеря запланированных коммуникаций без возможности быстрого отката.
- **Доказательство в коде**: последовательность `cancel` → `POST` без транзакции/rollback и без предупреждения пользователя.【F:merchant-portal/app/loyalty/telegram/page.tsx†L421-L465】

### 4) UI вводит в заблуждение по установке Menu Button
- **Где**: `merchant-portal/app/integrations/telegram-mini-app/page.tsx`.
- **Что происходит**: в интерфейсе постоянно отображается текст «Не требуется устанавливать Menu Button — это делается автоматически после подключения токена бота». При этом бэкенд может вернуть сообщение об ошибке установки меню, но UI всё равно показывает уверенное утверждение.
- **Риск**: мерчант не выполнит ручную настройку, если автоматическая установка упала; Mini App не запускается у клиентов.
- **Доказательство в коде**: статичный текст без учёта статуса установки меню и сообщений backend.【F:merchant-portal/app/integrations/telegram-mini-app/page.tsx†L396-L401】

## Низкая критичность

### 5) Тихий провал загрузки аудиторий в Telegram‑рассылках
- **Где**: `merchant-portal/app/loyalty/telegram/page.tsx`.
- **Что происходит**: при ошибке загрузки `/api/portal/audiences` исключение глушится, интерфейс остаётся без списка аудиторий и без сообщения об ошибке. Итог — форма выглядит «пустой», пользователь не понимает, что случилось.
- **Риск**: невозможность отправить рассылку и лишние обращения в поддержку.
- **Доказательство в коде**: `catch` в `loadAudiences` просто выставляет `audiencesLoaded` и не показывает ошибку.【F:merchant-portal/app/loyalty/telegram/page.tsx†L182-L207】
