# Аудит: аналитика по времени (merchant-portal)

Ниже — найденные проблемы по странице `/analytics/time` и эндпоинтам `/portal/analytics/time/*`, отсортированы по убыванию критичности.

## P2 — High

1) **Показываются устаревшие данные при смене периода/глубины анализа.**
   - В UI при смене `period` или `group/limit` данные не сбрасываются, и пока идёт загрузка, отображаются прошлые значения без явного индикатора. Это может вводить в заблуждение и приводить к неверным решениям по аналитике.
   - Где: `merchant-portal/app/analytics/time/page.tsx` (эффекты загрузки `recency/activity`, отрисовка `activityLoading/recencyLoading`).

2) **Некорректные подписи недель/месяцев в давности покупок.**
   - Бакет `0` для недель/месяцев (0–6 дней / 0–29 дней) маркируется как `1 неделя`/`1 месяц`, а в tooltip показывается «1 неделю назад» — то есть покупки, сделанные сегодня/вчера, визуально считаются «неделю/месяц назад».
   - Это искажает интерпретацию свежих покупок.
   - Где: `api/src/analytics/analytics.service.ts` (формирование `label` и `value` для недель/месяцев), `merchant-portal/app/analytics/time/page.tsx` (tooltip по `value`).

3) **Распределение давности не учитывает таймзону мерчанта.**
   - `getPurchaseRecencyDistribution` считает разницу от `NOW()` на стороне БД без учёта `portalTimezone`, в отличие от `time/activity`, где таймзона учитывается.
   - В результате возможен сдвиг на 1 день для мерчантов в отличной от сервера зоне (особенно возле границы суток), что влияет на бакеты day/week/month.
   - Где: `api/src/analytics/analytics.service.ts` (использование `NOW()` без таймзоны), `api/src/portal/portal.controller.ts` (`analytics/time/recency` не передаёт таймзону).

## P3 — Low

4) **Исключение нулевых чеков может занижать активность.**
   - В `time/activity` фильтр `r.total > 0` исключает чеки с нулевой суммой (например, 100% скидка/комплимент), из-за чего «Продажи/Выручка/Ср. чек» по времени занижены.
   - Где: `api/src/analytics/analytics.service.ts` (`getTimeActivityMetrics`, фильтр `r.total > 0`).
