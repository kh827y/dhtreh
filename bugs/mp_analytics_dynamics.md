# Аудит: MP аналитика «Динамика» + /portal/analytics (revenue|operations|customers)

Ниже — проблемы, отсортированные по убыванию критичности.

## P1 — Несогласованная фильтрация чеков между totals и сериями → графики и «средний чек» не сходятся с общей выручкой

**Где:**
- `api/src/analytics/analytics.service.ts` → `getRevenueMetrics()` (фильтрует `Receipt.total > 0` и исключает чеки с REFUND).
- `api/src/analytics/analytics.service.ts` → `getDailyRevenue()` и `getHourlyDistribution()` (не фильтруют `total > 0`).

**Что происходит:**
- Общая выручка (`totalRevenue`) и количество транзакций (`transactionCount`) рассчитываются **только по чекам с `total > 0`**, а дневные/почасовые серии включают чеки с `total <= 0`.
- На странице `merchant-portal/app/analytics/dynamics/page.tsx` график среднего чека строится по `dailyRevenue.averageCheck`, то есть по серии, которая может включать «нулевые» или отрицательные чеки.

**Риск для достоверности:**
- Сумма по графикам и агрегаты могут расходиться, «средний чек» на графике занижается относительно `totalRevenue/transactionCount`.
- В периоды с возвратами/нулевыми чеками динамика выглядит хуже, чем агрегат на сервере.

**Как исправить (минимально):**
- Привести фильтрацию в `getDailyRevenue()` и `getHourlyDistribution()` к тем же условиям, что и в `getRevenueMetrics()` (например, `total > 0` + исключение REFUND).
- Либо, если нужно учитывать нулевые/отрицательные чеки везде — убрать фильтр `total > 0` из totals и честно показывать эту логику в UI.

## P2 — Метрики клиентов считают «активность» по всем транзакциям, включая ручные начисления/списания и рефанды

**Где:**
- `api/src/analytics/analytics.service.ts` → `getCustomerMetrics()`.

**Что происходит:**
- `activeCustomers` и `averageVisitsPerCustomer` считаются по таблице `Transaction` **без фильтра по типу** (`EARN/REDEEM/REFUND/ADJUST/...`) и **без фильтра по `canceledAt`**.
- Любые ручные корректировки баланса, кампании, рефанды и т.п. будут «делать клиента активным» и увеличивать число «визитов».

**Риск для достоверности:**
- Аналитика «активных клиентов» и «частоты визитов» завышена, особенно если есть ручные корректировки или частые возвраты.
- Руководитель видит рост активности, которого фактически нет в покупках.

**Как исправить (минимально):**
- Считать активность по валидным покупкам: либо по `Receipt` (как в `getRevenueMetrics()`), либо по `Transaction` c фильтром `type = 'EARN'` (или списком типов, соответствующих реальным покупкам) + `canceledAt IS NULL`.

## P2 — Операционные метрики «использование точек» считают любые транзакции (включая корректировки/рефанды)

**Где:**
- `api/src/analytics/analytics.service.ts` → `getOutletUsage()` (использует `Transaction.groupBy` без фильтра типов и без `canceledAt`).

**Что происходит:**
- Количество операций и «последняя активность» на точке строятся из любых транзакций (включая `ADJUST`, `REFUND`, ручные начисления), поэтому точка может выглядеть «активной» даже без реальных продаж.

**Риск для достоверности:**
- Неверная оценка активности точек в `/portal/analytics/operations`, особенно если есть частые ручные корректировки или тестовые операции.

**Как исправить (минимально):**
- Перейти на `Receipt` (валидные продажи), либо фильтровать `Transaction` по релевантным типам (`EARN`, исключая `REFUND/ADJUST`) и `canceledAt IS NULL`.
