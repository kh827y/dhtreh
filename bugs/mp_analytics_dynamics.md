# Аудит: MP аналитика «Динамика» + /portal/analytics (revenue|operations|customers)

Ниже — проблемы, отсортированные по убыванию критичности.

## P1 — Несогласованная фильтрация чеков между totals и сериями → графики и «средний чек» не сходятся с общей выручкой

Нет актуальных пунктов.

## P2 — Метрики клиентов считают «активность» по всем транзакциям, включая ручные начисления/списания и рефанды

**Где:**
- `api/src/analytics/analytics.service.ts` → `getCustomerMetrics()`.

**Что происходит:**
- `activeCustomers` и `averageVisitsPerCustomer` считаются по таблице `Transaction` **без фильтра по типу** (`EARN/REDEEM/REFUND/ADJUST/...`) и **без фильтра по `canceledAt`**.
- Любые ручные корректировки баланса, кампании, рефанды и т.п. будут «делать клиента активным» и увеличивать число «визитов».

**Риск для достоверности:**
- Аналитика «активных клиентов» и «частоты визитов» завышена, особенно если есть ручные корректировки или частые возвраты.
- Руководитель видит рост активности, которого фактически нет в покупках.

**Как исправить (минимально):**
- Считать активность по валидным покупкам: либо по `Receipt` (как в `getRevenueMetrics()`), либо по `Transaction` c фильтром `type = 'EARN'` (или списком типов, соответствующих реальным покупкам) + `canceledAt IS NULL`.

## P2 — Операционные метрики «использование точек» считают любые транзакции (включая корректировки/рефанды)

**Где:**
- `api/src/analytics/analytics.service.ts` → `getOutletUsage()` (использует `Transaction.groupBy` без фильтра типов и без `canceledAt`).

**Что происходит:**
- Количество операций и «последняя активность» на точке строятся из любых транзакций (включая `ADJUST`, `REFUND`, ручные начисления), поэтому точка может выглядеть «активной» даже без реальных продаж.

**Риск для достоверности:**
- Неверная оценка активности точек в `/portal/analytics/operations`, особенно если есть частые ручные корректировки или тестовые операции.

**Как исправить (минимально):**
- Перейти на `Receipt` (валидные продажи), либо фильтровать `Transaction` по релевантным типам (`EARN`, исключая `REFUND/ADJUST`) и `canceledAt IS NULL`.
