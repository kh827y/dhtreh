# Аудит POS Bridge (bridge/src) и соответствие API_DOCUMENTATION.md

Ниже — проблемы и несоответствия, отсортированные по убыванию критичности.

## P1 — High (существенные риски/блокеры стабильной эксплуатации)

1. **Bridge не доступен при запуске в Docker из-за bind на 127.0.0.1**
   - **Риск/эффект:** контейнер экспонирует порт 18080, но приложение слушает только `127.0.0.1`, из‑за чего доступ с хоста/сети невозможен. Документация и Dockerfile подразумевают доступность порта, но фактически сервис «невидим».
   - **Где:** `bridge/src/index.js` (`app.listen(PORT, '127.0.0.1')`), `bridge/Dockerfile` (`EXPOSE 18080`).
   - **Что проверить сквозняком:** реальные сценарии запуска Bridge в Docker/Compose — должно быть подтверждено, что POS‑ПО может подключиться (или официально закрепить, что Bridge **только** для локального запуска без контейнера).

2. **Отсутствует защита от CSRF/локальных веб‑атаки (Bridge принимает запросы от любых origin)**
   - **Риск/эффект:** если Bridge запущен на POS‑машине, любая веб‑страница (в том числе вредоносная) может отправлять запросы на `http://127.0.0.1:18080/*` из браузера и инициировать `quote/commit/refund` с учётом `STAFF_KEY`/`BRIDGE_SECRET` (подписанные запросы, автоматические операции). Это реальный сценарий атак на локальные сервисы.
   - **Где:** `bridge/src/index.js` (`app.use(cors({ origin: true }))`, отсутствие любой аутентификации на `/quote`, `/commit`, `/refund`).
   - **Что проверить сквозняком:** POS‑клиенты, которые используют браузер/веб‑вью, и возможность доступа к локальному порту из них.

3. **Нет таймаута на запросы к API → зависшие запросы блокируют кассу и не попадают в оффлайн‑очередь**
   - **Риск/эффект:** `fetch` без таймаута может зависнуть на неопределённое время (TCP зависания/проблемы DNS). Для `commit/refund` это означает «вечный» запрос и отсутствие fallback‑очереди, что критично для кассы.
   - **Где:** `bridge/src/index.js` (`callApi` без AbortController/timeout).
   - **Что проверить сквозняком:** сценарии с нестабильной сетью, потерей DNS или «полу‑живым» соединением.

## P2 — Medium (серьёзные недоработки/риски для эксплуатации)

4. **Документация POS Bridge не соответствует фактическому функционалу сервиса**
   - **Несоответствия:**
     - В Bridge есть `POST /refund`, `POST /queue/flush`, `GET /queue/status`, `GET /config`, `GET /metrics`, но в `API_DOCUMENTATION.md` описаны только `/quote` и `/commit`.
     - В Bridge поддерживается `receiptNumber` для `/commit`, `refundTotal/refundEligibleTotal` для `/refund`, но это не описано.
   - **Риск/эффект:** интеграторы и поддержка работают по неполной/устаревшей документации → ошибки внедрения и лишняя нагрузка на поддержку.
   - **Где:** `API_DOCUMENTATION.md` (раздел “POS Bridge”), `bridge/src/index.js`.

5. **Не ограничен рост оффлайн‑очереди и нет управления “битым” payload**
   - **Риск/эффект:** при постоянных ошибках API (4xx из‑за невалидных данных) очередь будет расти бесконечно и ретраиться без конца; это может заполнить диск и остановить сервис.
   - **Где:** `bridge/src/index.js` (`flushQueue` без лимитов по ретраям/TTL), `bridge/src/queue.js` (нет max size/TTL).
   - **Что проверить сквозняком:** сценарии ошибки данных (`holdId` не найден, `orderId` дубль) и то, как POS‑оператор решает «зависшие» записи.

6. **Валидация входных данных минимальна (нет защиты от NaN/отрицательных значений)**
   - **Риск/эффект:** `total`, `refundTotal` и `refundEligibleTotal` приводятся к `Number` без проверки; можно отправить `NaN`, отрицательные значения или слишком большие числа. Это создаёт нестабильность и непредсказуемое поведение в API.
   - **Где:** `bridge/src/index.js` (`/quote`, `/refund`).

## P3 — Low (гигиена/удобство эксплуатации)

7. **Не документированы/не разделены режимы запуска (локально vs контейнер)**
   - **Риск/эффект:** из README неясно, что Bridge слушает только `127.0.0.1`. В контейнере это приводит к «молчаливой» недоступности. Требуется либо явное описание, либо параметризация host binding.
   - **Где:** `bridge/README.md`, `bridge/src/index.js`.
