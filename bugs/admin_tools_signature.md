# Аудит: admin/tools/signature и Bridge signature

Ниже перечислены проблемы и недоработки, отсортированные по убыванию критичности.

## Высокий приоритет

1. **Инструмент подписи не соответствует реальной канонизации тела запроса, из‑за чего выдаёт неверные подписи**
   - **Где**: `admin/app/tools/signature/page.tsx`, серверные проверки в `api/src/loyalty/loyalty.controller.ts`, `api/src/integrations/integrations-loyalty.controller.ts`.
   - **Проблема**: инструмент подписывает *сырую строку* из textarea, а backend проверяет подпись на `JSON.stringify(...)` (с удалением `undefined`, фиксированным порядком ключей и без форматирования). Любые пробелы, отличающийся порядок ключей или значения `null` вместо отсутствующих полей приводят к расхождению подписи.
   - **Риск/эффект**: админ‑инструмент становится «ложным» источником правды — пользователи будут получать подпись, которая не валидируется на сервере, и наоборот. Это затрудняет интеграции и приводит к массовым ошибкам валидации.
   - **Что нужно**: либо реализовать в инструменте ту же канонизацию, что на backend (строгое `JSON.stringify` конкретных DTO/полей), либо явно предупреждать, что подпись зависит от *точного* body, и подсказать формат (minified JSON, порядок ключей, поля с `undefined` отсутствуют).

## Средний приоритет

2. **Проверка подписи в инструменте ломается на base64 с паддингом `=`**
   - **Где**: `admin/app/tools/signature/page.tsx` (`verifyHeaderHmac`).
   - **Проблема**: разбор заголовка выполняется через `split('=')`, из‑за чего значение `sig` обрезается при наличии `=` в base64 (типично для HMAC). В итоге валидная подпись почти всегда становится невалидной при проверке в инструменте.
   - **Риск/эффект**: пользователь получает ложный результат “Подпись НЕ валидна”, даже если подпись корректна и принимается backend.
   - **Что нужно**: парсить `sig` по первой `=` (как на backend), либо использовать более надёжный парсер `key=value` с сохранением остатка.

## Низкий приоритет

3. **Нет подсказок/валидации по допустимому timestamp и источнику истины**
   - **Где**: `admin/app/tools/signature/page.tsx`.
   - **Проблема**: поле `Timestamp` принимает любую строку, но сервер отклоняет подписи при skew > 300 секунд и при нечисловом `ts` (фактически всегда “не валидна”, без понятной причины). Инструмент не объясняет это поведение.
   - **Риск/эффект**: пользователи тратят время на отладку “несовпадений”, хотя проблема в некорректном/устаревшем `ts`.
   - **Что нужно**: добавить простую валидацию `ts` и подсказку про допустимое окно времени (+/‑ 5 минут).
