# Аудит: merchant-portal / операции

Ниже перечислены найденные проблемы по убыванию критичности.

## P1 — High

### 1) Неверная пагинация журнала операций: `total` считается по усечённой выборке
**Где:** `api/src/portal/services/operations-log.service.ts`.
**Что происходит:** сервис считает `receiptCount`/`transactionCount`, но не использует их. В ответ отдаётся `total = normalizedItems.length`, при этом `items` собираются из ограниченной выборки `take: fetchLimit` (limit+offset+20, максимум 500). В результате UI считает неверное число страниц и может «заканчивать» список раньше реального объёма данных.
**Риск:** пользователи не видят часть операций и считают, что данных меньше, чем есть на самом деле (ошибочные решения, жалобы на «пропажу операций»).

### 2) Флаг `allowEarnRedeemSameReceipt` из настроек мерчанта игнорируется
**Где:** `api/src/portal/services/operations-log.service.ts`.
**Что происходит:** переменная `allowSameReceipt` жёстко задана как `true`, при этом метод `isAllowSameReceipt()` (читающий настройки мерчанта) вообще не используется. Это приводит к постоянному скрытию earn/redeem транзакций, если есть связанный receipt, даже когда настройка должна показывать всё.
**Риск:** операции начисления/списания могут пропадать из журнала, ломается аудит и сверка по кассе.
