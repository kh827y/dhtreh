# Аудит: merchant-portal / операции

Ниже перечислены найденные проблемы по убыванию критичности.

## P1 — High

### 1) Неверная пагинация журнала операций: `total` считается по усечённой выборке
**Где:** `api/src/portal/services/operations-log.service.ts`.
**Что происходит:** сервис считает `receiptCount`/`transactionCount`, но не использует их. В ответ отдаётся `total = normalizedItems.length`, при этом `items` собираются из ограниченной выборки `take: fetchLimit` (limit+offset+20, максимум 500). В результате UI считает неверное число страниц и может «заканчивать» список раньше реального объёма данных.
**Риск:** пользователи не видят часть операций и считают, что данных меньше, чем есть на самом деле (ошибочные решения, жалобы на «пропажу операций»).

### 2) Флаг `allowEarnRedeemSameReceipt` из настроек мерчанта игнорируется
**Где:** `api/src/portal/services/operations-log.service.ts`.
**Что происходит:** переменная `allowSameReceipt` жёстко задана как `true`, при этом метод `isAllowSameReceipt()` (читающий настройки мерчанта) вообще не используется. Это приводит к постоянному скрытию earn/redeem транзакций, если есть связанный receipt, даже когда настройка должна показывать всё.
**Риск:** операции начисления/списания могут пропадать из журнала, ломается аудит и сверка по кассе.

## P2 — Medium

### 3) Поиск по номеру чека не находит транзакции, где номер лежит в `metadata`
**Где:** `api/src/portal/services/operations-log.service.ts`.
**Что происходит:** при фильтре `receiptNumber` для транзакций используется поиск только по `orderId`. Но `receiptNumber` часто хранится в `metadata.receiptNumber` (используется в `mapTransaction`), из-за чего поиск по номеру чека не находит такие операции.
**Риск:** пользователь получает неполные результаты поиска и может считать, что операции отсутствуют.

### 4) Фильтры сотрудников/точек/устройств в UI строятся только из текущей страницы
**Где:** `merchant-portal/app/operations/page.tsx`.
**Что происходит:** списки `staffOptions`, `outletOptions`, `deviceOptions` формируются только из загруженных `items` текущей страницы. Если нужный сотрудник/точка/устройство отсутствуют на первой странице, их невозможно выбрать для фильтрации.
**Риск:** фильтры работают некорректно и вводят пользователя в заблуждение («такого сотрудника нет»).

### 5) Несогласованность таймзоны в /portal/transactions и /portal/receipts
**Где:** `api/src/portal/portal.controller.ts` и `api/src/merchants/merchants.service.ts`.
**Что происходит:** в `/portal/transactions` и `/portal/receipts` параметры `from/to/before` парсятся через `new Date()` без учёта таймзоны мерчанта. В журнале операций таймзона учитывается (через offset и parseLocalDate), но в этих эндпоинтах — нет.
**Риск:** отчёты по датам смещаются (особенно на границах суток), что влияет на аналитические выводы.

## P3 — Low

### 6) `/portal/receipts` обходит ролевые права портала
**Где:** `api/src/portal-auth/portal.guard.ts`.
**Что происходит:** в `resolvePermissionTarget` есть проверка для `/portal/transactions`, но нет для `/portal/receipts`. В итоге endpoint не проходит проверку прав доступа для staff‑пользователей.
**Риск:** сотрудники с ограниченными правами могут получить доступ к данным чеков, даже если им запрещена работа с клиентскими/финансовыми данными.
