# Аудит: merchant-portal / loyalty cashier

Ниже проблемы отсортированы по убыванию критичности.

## High

### 1) PIN-коды сотрудников раскрываются целиком через portal API
- **Где:** `api/src/merchant-panel/merchant-panel.service.ts` (`listCashierPins` возвращает `pinCode`), `api/src/merchant-panel/controllers/cashier.controller.ts` (эндпоинт `/portal/cashier/pins`), `merchant-portal/app/loyalty/cashier/page.tsx` (UI скрывает PIN только визуально).
- **Проблема:** даже если PIN скрыт в интерфейсе, полный PIN каждого сотрудника уходит на фронт и может быть извлечён из сетевого ответа/DOM любым пользователем с доступом к панели кассира.
- **Риск:** компрометация PIN → несанкционированный доступ к кассовым операциям (начисление/списание баллов).

### 2) Нет механизма для принудительного отзыва активированных устройств кассира
- **Где:** `api/src/merchants/merchants.service.ts` (создание `cashierDeviceSession`, отзыв возможен только по токену устройства), `api/src/loyalty/loyalty.controller.ts` (`DELETE /loyalty/cashier/device` требует cookie устройства), `merchant-portal/app/loyalty/cashier/page.tsx` (в UI только коды активации и PIN-ы, без списка/отзыва устройств).
- **Проблема:** отзыв кода активации работает только для **неиспользованных** кодов (`revokeCashierActivationCode` фильтрует `usedAt: null`), а уже активированное устройство остаётся валидным до ~180 дней и не может быть отозвано со стороны мерчанта.
- **Риск:** потеря/кража устройства = длительный неуправляемый доступ к кассовым операциям.

## Medium

### 3) Выпуск кодов активации не транзакционный — возможны «потерянные» активные коды
- **Где:** `api/src/merchants/merchants.service.ts` (`issueCashierActivationCodes`).
- **Проблема:** если в процессе выпуска произойдёт ошибка, метод бросит `Unable to issue activation codes`, но уже созданные коды останутся в БД активными. В ответе они не возвращаются, а в интерфейсе не отображаются (виден только `tokenHint`).
- **Риск:** появляются «теневые» активные коды, которыми можно воспользоваться при утечке/угадывании, плюс путаница при повторном выпуске.

## Low

### 4) Кассовый UI имеет небезопасный дефолт мерчанта (`M-1`)
- **Где:** `cashier/src/app/page.tsx` (`const MERCHANT = process.env.NEXT_PUBLIC_MERCHANT_ID || 'M-1'`).
- **Проблема:** при отсутствующей/ошибочной конфигурации фронт по умолчанию обращается к мерчанту `M-1`.
- **Риск:** в продакшене возможны запросы к «чужому» мерчанту, некорректные метрики/данные, сложность диагностики ошибок.
