# Аудит: аналитика реферальной программы (merchant-portal/app/analytics/referrals/page.tsx, /portal/analytics/referral)

Ниже — найденные проблемы, отсортированные по убыванию критичности.

## P1 — Высокая критичность

### 1) `bonusesIssued` в аналитике не соответствует фактически начисленным/отменённым бонусам
**Где:** `api/src/analytics/analytics.service.ts` (метод `computeReferralPeriodStats`, расчёт `bonusesIssued`).

**Что происходит:**
- `bonusesIssued` рассчитывается из данных `Referral` + настроек программы и учитывает только:
  - бонус другу за активацию;
  - бонус пригласителю за **первую** покупку (по `completedAt/purchaseAmount`).
- Реальные начисления выполняются через транзакции `Transaction` в `loyalty.service.ts` и могут происходить:
  - **на каждой покупке**, если `rewardTrigger=all`;
  - **по нескольким уровням** при `multiLevel`;
  - **с откатом** при возвратах (rollback реферальных бонусов).

**Риск:** аналитика показывает искажённые данные по выданным бонусам (особенно при `rewardTrigger=all` и `multiLevel`), плюс не учитывает откаты — это ломает доверие к отчётности и мешает контролю расходов на бонусы.

**Ожидаемо:** `bonusesIssued` должен строиться по фактическим транзакциям `Transaction` типа `REFERRAL` за период (с учётом откатов/возвратов) или эквивалентной агрегирующей таблице.

## P2 — Средняя критичность

### 2) Кнопка «Полный отчёт» вводит в заблуждение: показывается тот же top‑20, а не полный список
**Где:** `merchant-portal/app/analytics/referrals/page.tsx` (кнопка «Полный отчёт» и модальное окно), `api/src/analytics/analytics.service.ts` (формирование `topReferrers` с `.slice(0, 20)`).

**Что происходит:**
- На странице и в модальном окне используется один и тот же массив `topReferrers`, который на backend жёстко ограничен 20 записями.
- Пользователь видит «Полный отчёт», но в реальности получает тот же top‑20 без возможности загрузить полный список.

**Риск:** вводит в заблуждение владельцев бизнеса и затрудняет реальный анализ (например, при большом числе рефералов невозможно увидеть «длинный хвост»).

**Ожидаемо:** либо изменить текст на «Топ‑20», либо добавить отдельный endpoint/пагинацию для полного списка.

## P3 — Низкая критичность

### 3) Кнопка «Настроить» видна без проверки прав на механику рефералов
**Где:** `merchant-portal/app/analytics/referrals/page.tsx` (кнопка «Настроить»), `merchant-portal/app/layout.tsx` (права на `/referrals/program`).

**Что происходит:**
- Доступ к аналитике может быть выдан ролям без прав на настройку механики (`mechanic_referral`).
- Кнопка «Настроить» отображается всем и ведёт на страницу, где будет отказ в доступе.

**Риск:** лишние «битые» переходы и путаница для сотрудников с ограниченными правами.

**Ожидаемо:** скрывать/дизейблить кнопку при отсутствии `mechanic_referral:read` или показывать пояснение.
