# Аудит: настройки бонусов (merchant-portal)

## P1 — Critical

- **Пересохранение настроек бонусов может стереть legacy-правила начисления/списания**
  - **Риск**: если у мерчанта ещё используется старый формат `rulesJson` (массив правил), то любое сохранение настроек бонусов заменяет массив на объект с одним ключом `allowEarnRedeemSameReceipt`. Это удаляет все остальные правила и может полностью изменить логику начислений/списаний, антифрода и других механик.
  - **Где**:
    - `api/src/loyalty-program/controllers/redeem-limits.controller.ts` — `ensureObject()` превращает массив в `{}` и затем обновляет `rulesJson`.
    - `merchant-portal/app/api/portal/loyalty/redeem-limits/route.ts` — при `rulesJson` в виде массива берёт `{}` и записывает обратно только `allowEarnRedeemSameReceipt`.
  - **Как исправить**: при обновлении `allowEarnRedeemSameReceipt` сохранять исходный формат `rulesJson` (если это массив — модифицировать без перезаписи), либо привести правила через общий `normalizeRulesJson()` и обновлять только нужное поле без удаления остальных правил.

## P2 — Medium

Нет актуальных пунктов.
