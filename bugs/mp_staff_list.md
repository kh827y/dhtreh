# Аудит: список сотрудников (merchant-portal/app/staff/page.tsx, /portal/staff)

Ниже — найденные проблемы, отсортированные по убыванию критичности.

## Высокий приоритет

### 1) Колонка «Активность» вводит в заблуждение: входы в портал не учитываются
**Где:** `merchant-portal/app/staff/page.tsx` (tooltip «Время последней операции с баллами или входа в панель управления»), `api/src/merchant-panel/merchant-panel.service.ts` (`listStaff`, поле `lastActivityAt`).

**Суть:** UI обещает учитывать «операции с баллами или вход в панель», но в списке берётся только максимум по транзакциям (и `staff.lastActivityAt`) — `lastPortalLoginAt` в выдачу списка не попадает. В результате сотрудник, который активно входит в портал без операций с баллами, выглядит как «неактивный».

**Риск:** неверные управленческие решения и снижение доверия к данным аналитики (особенно при контроле активности персонала).

**Что проверить/исправить:** либо изменить текст подсказки, либо включать `lastPortalLoginAt` в расчёт `lastActivityAt` при формировании списка.

### 2) Статус/фильтр «Доступ в панель» не соответствует реальным правилам авторизации
**Где:**
- UI: `merchant-portal/app/staff/page.tsx` (`hasPortalAccess`, фильтр `onlyPortal`).
- Backend: `api/src/portal-auth/portal.guard.ts` (условия допуска сотрудника в портал), `api/src/merchant-panel/merchant-panel.service.ts` (`listStaff` фильтр `portalOnly`).

**Суть:**
- В UI доступ считается как `isOwner || portalAccessEnabled || canAccessPortal`, а фильтр «С доступом в панель» передаёт только `portalOnly=true` (то есть `portalAccessEnabled`).
- В backend реальный доступ требует одновременно `portalAccessEnabled`, `canAccessPortal` и наличия `hash` (пароля). 

**Риск:**
- В списке могут отображаться «имеющие доступ», хотя вход в портал реально невозможен (например, `canAccessPortal=true`, но `portalAccessEnabled=false` или нет пароля).
- Фильтр «С доступом в панель» может скрыть сотрудников, которых UI сам же маркирует как имеющих доступ (несоответствие фильтра и бейджа).

**Что проверить/исправить:** выровнять логику отображения/фильтрации со строгими правилами `PortalGuard` (минимум `portalAccessEnabled && canAccessPortal && hash`).

## Средний приоритет

### 3) Жёсткий лимит `pageSize=100` без пагинации/«загрузить ещё» скрывает сотрудников
**Где:** `merchant-portal/app/staff/page.tsx` (в `load()` всегда `page=1`, `pageSize=100`, UI навигации по страницам нет), `api/src/merchant-panel/merchant-panel.service.ts` (`listStaff` с пагинацией).

**Суть:** при количестве сотрудников > 100 часть списка никогда не отображается и не управляется через интерфейс.

**Риск:** невозможность найти/уволить/изменить сотрудника; визуально кажется, что людей меньше, чем есть — ошибки в учёте.

**Что проверить/исправить:** добавить пагинацию/инфинит‑скролл или пересмотреть лимит и явный UX для больших списков.

### 4) Поиск в UI и на сервере не совпадает → пропуски при поиске логина/должности
**Где:**
- UI: `merchant-portal/app/staff/page.tsx` (клиентский фильтр по `firstName`, `lastName`, `login`, `email`, `phone`, `position`).
- Backend: `api/src/merchant-panel/merchant-panel.service.ts` (`listStaff` ищет только по `firstName/lastName/email/phone`).

**Суть:** UI отправляет `search` на сервер, но сервер не ищет по `login` и `position`. При наличии >100 записей поиск по логину/должности может вернуть пусто, потому что сервер отдал первую страницу без нужного совпадения, а клиент фильтрует только её.

**Риск:** сотрудники не находятся через поиск, даже если реально существуют (особенно при больших списках).

**Что проверить/исправить:** синхронизировать поля поиска между UI и backend или перенести поиск полностью на сервер.

## Низкий приоритет

### 5) Фолбэк групп доступа может ломать фильтр/создание сотрудников при отсутствии `/portal/access-groups`
**Где:** `merchant-portal/app/api/portal/access-groups/route.ts` (фолбэк через `/portal/staff`).

**Суть:** если `/portal/access-groups` вернул 404, фолбэк делает `GET /portal/staff` и ожидает массив, хотя API возвращает объект `{ items, counters }`. В итоге всегда возвращаются дефолтные роли (MERCHANT/MANAGER/ANALYST/CASHIER), которые не являются реальными `accessGroupIds`. При попытке фильтрации по группе или создании сотрудника с выбранной «ролью» возможны ошибки или нулевые результаты.

**Риск:** в среде со старым/нестабильным API фильтр по группам и выдача списков могут быть некорректными.

**Что проверить/исправить:** корректно обрабатывать формат `/portal/staff` (извлекать `items`) или убрать фолбэк, если `access-groups` обязательно.
