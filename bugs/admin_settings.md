# Аудит админских настроек (admin/app/settings/page.tsx)

Ниже перечислены проблемы по убыванию критичности. Дубликаты из `FIX.md` не включал.

## P1 — Высокий риск

1. **Админка не может сохранять `rulesJson` в новом формате (объект с `rules/af/reviewsShare`), из‑за чего блокируется сохранение любых настроек**
   - **Проявление:** `admin/app/settings/page.tsx` валидирует правила только как массив, а при формате объекта показывает ошибку “Правила должны быть массивом объектов” и блокирует сохранение. Сервер же принимает объектный формат (normalize + validate). В итоге админка не даёт править настройки мерчанта, если `rulesJson` уже в новом формате.
   - **Риск:** админ не сможет изменить критичные настройки (например, лимиты/TTL/вебхуки), пока не удалит/перепишет правила в старом формате.
   - **Где смотреть:** `admin/app/settings/page.tsx` (`validateRules`, `computeRules`, `save`), `api/src/merchants/merchants.service.ts` (`normalizeRulesJson`, `validateRules`).

2. **В UI отсутствуют переключатели ключевых защитных флагов (`requireBridgeSig`, `requireStaffKey`, `requireJwtForQuote`)**
   - **Проявление:** страница настроек не отображает и не даёт менять флаги, хотя API их поддерживает. Админ может задать секреты Bridge/Webhook, но не может включить обязательность подписи/ключа.
   - **Риск:** настройки безопасности остаются в дефолтном состоянии (false), админка не позволяет включить обязательную подпись/ключ даже если бизнесу это нужно.
   - **Где смотреть:** `admin/app/settings/page.tsx` (нет полей), `api/src/merchants/dto.ts` и `api/src/merchants/merchants.service.ts` (поддержка флагов).

3. **Админский фронтенд требует `NEXT_PUBLIC_API_KEY`, хотя прокси сам добавляет `x-admin-key`**
   - **Проявление:** `admin/lib/admin.ts` бросает ошибку, если `NEXT_PUBLIC_API_KEY` не задан, но `admin/app/api/admin/[...path]/route.ts` не использует этот ключ и авторизует запрос по сессии + `ADMIN_KEY`.
   - **Риск:** либо админка не работает без публичного ключа, либо команду вынуждают пробрасывать в `NEXT_PUBLIC_*` секреты (утечка ключей). Это против продакшн‑практик.
   - **Где смотреть:** `admin/lib/admin.ts`, `admin/app/api/admin/[...path]/route.ts`.

## P2 — Средний риск

4. **Нельзя “очистить” настройки через UI (webhook/bridge/мини‑аппа/правила)**
   - **Проявление:** при очистке поля UI отправляет `undefined`, а не `null`/пустое значение. Сервер в этом случае не обновляет поле → старое значение остаётся. Аналогично с `rulesJson`: пустое поле не сбрасывает правила.
   - **Риск:** админ не может отключить вебхук, удалить мини‑аппу, сбросить правила. Это мешает реальным операциям и может приводить к некорректной работе интеграций.
   - **Где смотреть:** `admin/app/settings/page.tsx` (формирование `dto`), `api/src/merchants/merchants.service.ts` (update через `undefined` не обновляет поле).

5. **Часть важных настроек вообще недоступна в админке**
   - **Проявление:** отсутствуют поля для `redeemDailyCap`, `earnDailyCap`, `pointsTtlDays`, `earnDelayDays`, `maxOutlets`, `timezone`, а также `telegramStartParamRequired` (значение подгружается, но UI для изменения нет).
   - **Риск:** админ не может управлять ключевыми лимитами и параметрами программы лояльности; в проде это приводит к ручным правкам через API/БД.
   - **Где смотреть:** `admin/app/settings/page.tsx` vs. `api/src/merchants/dto.ts`.

