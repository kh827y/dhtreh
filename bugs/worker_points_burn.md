# Аудит воркеров Points TTL/Burn

Ниже проблемы отсортированы по убыванию критичности. Дубли из `FIX.md` не включались.

## P1 — High (критично для корректности списаний/уведомлений)

Нет актуальных пунктов.

- **[TTL Reminder] Дедупликация не работает — напоминания будут рассылаться повторно каждый запуск**
  - **Риск**: клиенты будут получать повторные уведомления о сгорании баллов (каждый тик воркера), что раздражает пользователей и выглядит как спам.
  - **Причина**: проверка дубликатов ищет `pushNotification` с `type = 'TTL_REMINDER'`, но отправка идёт через `PushService` с `type = 'SYSTEM'`. Записи с типом `TTL_REMINDER` не создаются, поэтому дедупликация всегда считает, что дубликатов нет.
  - **Где**: `api/src/points-ttl-reminder.worker.ts` (`isDuplicate` ищет `type: 'TTL_REMINDER'`), `api/src/notifications/push/push.service.ts` (`sendPush` пишет `type: 'SYSTEM'`).
  - **Что сделать**: синхронизировать тип (либо писать `TTL_REMINDER` в `PushService`, либо проверять дубликаты по `type: 'SYSTEM'` + `data.type='ttl_reminder'`).

## P2 — Medium (риски деградации/некорректной бизнес-логики)

- **[TTL Burn] Фактическое сгорание баллов целиком зависит от `EARN_LOTS_FEATURE`**
  - **Риск**: если `POINTS_TTL_BURN=1`, но `EARN_LOTS_FEATURE` выключен, воркер **полностью пропускает** сгорание баллов — TTL настраивается, но ничего не списывается. В итоге TTL в проде не работает и баллы могут храниться бесконечно.
  - **Причина**: в `PointsBurnWorker` есть ранний выход, если `EARN_LOTS_FEATURE !== '1'`.
  - **Где**: `api/src/points-burn.worker.ts` (early return).
  - **Что сделать**: либо явно запрещать включать TTL без `EARN_LOTS_FEATURE` (и отражать это в настройках/UI), либо реализовать fallback-логику сгорания без lot-ов (минимально — по кошельку и транзакциям).

- **[TTL Preview] Превью генерирует события без дедупликации и может раздувать outbox**
  - **Риск**: каждое срабатывание воркера создаёт новый `eventOutbox` для одних и тех же клиентов. При доставке событий это может приводить к повторным уведомлениям/аналитике и росту таблицы outbox.
  - **Причина**: `PointsTtlWorker` на каждом тике создаёт `eventOutbox` без проверки существующих событий по `customerId/ttlDays/date`.
  - **Где**: `api/src/points-ttl.worker.ts` (создание `eventOutbox` в циклах по клиентам).
  - **Что сделать**: добавить дедупликацию (например, unique-key на `(merchantId, customerId, eventType, date)` или проверку существования события за текущий период) либо «оконный» режим, когда событие пишется только при первом попадании в окно.

- **[TTL Reminder] Нет fallback-логики, если `EARN_LOTS_FEATURE` выключен**
  - **Риск**: при выключенных `earnLot` напоминания о сгорании не отправляются совсем, хотя TTL на стороне настроек включён. Это приводит к несоответствию ожиданиям и снижает прозрачность для клиентов.
  - **Причина**: воркер строит напоминания **только** по `earnLot` и не учитывает сценарий без lot-ов.
  - **Где**: `api/src/points-ttl-reminder.worker.ts` (`earnLot.findMany` без альтернативы).
  - **Что сделать**: либо блокировать включение напоминаний, если `EARN_LOTS_FEATURE` выключен, либо реализовать approximate-логику (как в `PointsTtlWorker`).

## P3 — Low (наблюдения/качество данных)

- **[Metrics] Метрика суммы сгоревших баллов может быть завышена**
  - **Риск**: мониторинг/отчётность показывают некорректные цифры (например, при недостатке баланса или гонках).
  - **Причина**: `loyalty_points_ttl_burned_amount_total` увеличивается на `burnReq` (сумма из карты лотов), а не на фактически списанный `burnAmount`.
  - **Где**: `api/src/points-burn.worker.ts` (инкремент метрики после транзакции).
  - **Что сделать**: использовать фактическую сумму списания (`burnAmount`) для метрик и payload’ов.
