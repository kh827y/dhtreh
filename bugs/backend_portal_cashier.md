# Аудит backend portal cashier

Ниже — найденные проблемы по эндпоинтам `portal/cashier` и сквозной проверке с cashier UI.
Недоработки отсортированы по убыванию важности.

## P1 — High

1. **В портале показываются PIN-коды, которые касса не примет (EXPIRED / неактивный сотрудник).**
   - `GET /portal/cashier/pins` возвращает все доступы сотрудника без фильтра по статусу доступа или статусу сотрудника.
   - UI фильтрует только `REVOKED`, поэтому PIN со статусом `EXPIRED` отображается как рабочий.
   - В cashier backend вход по PIN разрешён только при `status=ACTIVE`, а также при активном статусе сотрудника.
   - Итог: менеджер видит PIN и пытается использовать, но касса отдаёт ошибку «PIN не найден»/«сотрудник не активен».
   - **Что сделать:** фильтровать список на backend по `ACTIVE` и `staff.status=ACTIVE`, либо отображать статус в UI и скрывать/помечать нерабочие PIN.

## P2 — Medium

2. **Нет управления активированными устройствами кассы из портала (сброс/отзыв), хотя устройство живёт до ~180 дней.**
   - После активации по одноразовому коду выдается `cashier_device` токен на ~180 дней.
   - Деактивация возможна только при наличии токена (с самого устройства).
   - В портале нет списка активных устройств и кнопки «отозвать» на случай утери/компрометации планшета/телефона.
   - **Что сделать:** добавить в portal endpoints список активных устройств и revoke для выбранного устройства (минимум — ручной сброс всех устройств мерчанта).

## P3 — Low

3. **Отзыв кода активации всегда возвращает успех, даже если код уже использован/истёк/не найден.**
   - `POST /portal/cashier/activation-codes/revoke` обновляет запись через `updateMany`, но не проверяет `count`.
   - В результате UI показывает «успешно», хотя статус может не измениться.
   - **Что сделать:** вернуть ошибку при `count=0` или явно сообщать «код не найден/уже неактивен».
