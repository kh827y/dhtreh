# Аудит: admin outbox monitor

Ниже перечислены проблемы по убыванию критичности.

## P1 — High

1. **Экспорт CSV может зависать/дублировать строки при больших объёмах**
   - **Сценарий**: админ делает экспорт `outbox.csv` при объёме > batch (по умолчанию 1000).
   - **Почему это баг**: пагинация строится на `createdAt >= cursor` при сортировке `createdAt desc`, поэтому следующая страница включает уже выгруженные записи. При полном batch цикл не сдвигается и может уйти в бесконечную выгрузку/дубликаты.
   - **Где**: `api/src/merchants/merchants.controller.ts` (цикл `outboxCsv` с `cursorSince`), `api/src/merchants/merchants.service.ts` (`listOutbox` сортировка `createdAt: 'desc'`).
   - **Риск**: зависание экспорта, рост нагрузки и неверные данные для расследований.

## P2 — Medium

2. **`outboxStats` падает на невалидном `since`**
   - **Сценарий**: в UI вводится некорректная строка даты или локальный формат.
   - **Почему это баг**: контроллер всегда передаёт `new Date(sinceStr)` без валидации; `Invalid Date` приводит к ошибкам Prisma на фильтре `createdAt`.
   - **Где**: `api/src/merchants/merchants.controller.ts` (`outboxStats`), UI ввод в `admin/app/outbox/monitor/page.tsx` допускает произвольную строку.
   - **Риск**: 500 в админке, невозможность проверить статистику по периоду.

3. **`outbox/by-order` может возвращать пусто, даже если события есть**
   - **Сценарий**: заказ старше последних N записей (limit), либо событий по заказу немного.
   - **Почему это баг**: сервис берёт последние `limit` событий по мерчанту и фильтрует в памяти по `payload.orderId`, не делая фильтра на уровне БД. В итоге нужный заказ может оказаться за пределами выборки.
   - **Где**: `api/src/merchants/merchants.service.ts` (`listOutboxByOrder`).
   - **Риск**: админ видит «нет данных по заказу», хотя события реально есть → неправильные решения/диагностика.

## P3 — Low

4. **Смешение глобальных метрик и мерчант‑статистики на одной странице**
   - **Сценарий**: админ смотрит `Outbox Monitor` для конкретного merchantId и ожидает, что все цифры относятся к нему.
   - **Почему это баг/недоработка**: `outboxStats` считается по мерчанту, а `/api/metrics` возвращает глобальные Prometheus‑метрики без фильтра по merchantId/периоду. UI не помечает это явно, из‑за чего возможны неверные выводы.
   - **Где**: `admin/app/outbox/monitor/page.tsx`, `admin/app/api/metrics/route.ts`.
   - **Риск**: путаница в диагностике и приоритизации проблем.
