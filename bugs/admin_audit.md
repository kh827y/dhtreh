# Аудит страницы /admin/audit

Ниже перечислены выявленные проблемы по убыванию важности.

## P1 — критичные/блокирующие

1. **Экспорт CSV фактически не работает из‑за конфликта роутов в API.**
   - В `AdminAuditController` обработчик `@Get(':id')` объявлен выше `@Get('csv')`. В NestJS (Express) статический путь `/admin/audit/csv` попадает в `:id`, поэтому экспорт CSV не вызывается и вместо файла возвращается запись с `id="csv"` (или `null`).
   - В результате ссылка «Export CSV» в админке не выполняет свою задачу.

## P2 — значимые

2. **Даже если CSV‑эндпоинт починить, прокси не распознаёт его как CSV.**
   - Прокси `/api/admin/*` добавляет заголовки загрузки только если путь оканчивается на `.csv`, но экспорт аудита имеет путь `/admin/audit/csv` без расширения.
   - Из‑за этого браузер открывает текст в новой вкладке, а не скачивает файл; также не ставится `Content-Disposition`.

3. **Фильтр по merchantId не применяется автоматически.**
   - `usePreferredMerchantId` может подставить сохранённый `merchantId` из `localStorage`, но страница аудита делает `load()` только один раз при маунте и не перезагружает список при изменении `merchantId/limit/before`.
   - Итог: сначала показывается аудит **всех** мерчантов, и администратор может не заметить, что работает не с тем фильтром; требуется ручной клик «Обновить».

## P3 — умеренные/низкие

4. **Некорректный формат даты приводит к серверной ошибке.**
   - Поле «До (ISO)» никак не валидируется, а API пытается сделать `new Date(beforeStr)` без проверки. Невалидное значение вызывает ошибку Prisma/500 без понятного сообщения пользователю.
   - Стоит валидировать дату на фронте и отдавать понятную ошибку (или игнорировать фильтр при неверном формате).
