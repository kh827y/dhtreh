# Автовозврат клиентов (auto-return.worker) — найденные проблемы

Ниже проблемы отсортированы по убыванию критичности.

## P1 — Высокая

1) **Подарочные баллы начисляются даже если пуш не доставлен (и попытка помечается FAILED)**
   - **Риск:** раздача баллов без фактической коммуникации с клиентом и без подтверждения доставки; финансовые потери и искажение аналитики (инвайты с FAILED не учитываются, хотя баллы уже выданы).
   - **Где:**
     - `AutoReturnWorker.createAttempt()` сначала начисляет баллы и фиксирует транзакцию, затем отправляет пуш и при ошибке переводит попытку в `FAILED`.
     - `AnalyticsService.getAutoReturnMetrics()` исключает `FAILED` попытки из статистики.
   - **Почему важно:** при временных сбоях push/отсутствии получателей баллы уже на кошельке, а повторной отправки нет.

2) **FAILED попытки не ретраятся и блокируют повторные попытки для той же последней покупки**
   - **Риск:** временный сбой отправки навсегда отключает автосценарий для клиента (пока не будет новой покупки).
   - **Где:**
     - Ретраи есть только для `PENDING` (resume), но `FAILED` игнорируются.
     - При поиске новых клиентов для приглашения стоит проверка `alreadyAttempted` по `lastPurchaseAt`, из-за чего новая попытка не создаётся.
   - **Следствие:** при любой ошибке/отсутствии push токенов клиент «теряется» для механики.

## P2 — Средняя

3) **Отменённые чеки учитываются как покупки**
   - **Риск:**
     - клиент может считаться «активным» из-за отменённых чеков → не попадёт в выборку авто‑возврата;
     - попытка может перейти в `RETURNED`, хотя покупка была отменена.
     - аналитика использует `canceledAt = null`, поэтому механика и статистика расходятся.
   - **Где:**
     - выборка неактивных клиентов (`Receipt` без фильтра `canceledAt`);
     - проверка «возврата» после приглашения также без фильтра `canceledAt`.

4) **Повторные попытки могут бесконечно начислять баллы без покупки (особенно при `giftTtlDays = 0`)**
   - **Риск:** клиент получает подарочные баллы каждые `repeatDays`, даже если не возвращается (нет покупки). Это создаёт возможность «фарминга» баллов без активности.
   - **Где:** при повторе сценария предыдущая попытка просто переводится в `EXPIRED`, и создаётся новая с начислением `giftPoints`, без проверки остатка/использования подарка и без лимита повторов.

