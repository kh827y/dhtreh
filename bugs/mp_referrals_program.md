# Реферальная программа (merchant-portal /referrals/program, /portal/referrals/program, /referral/*)

Недоработки отсортированы по убыванию критичности.

## P1 — критичные для продакшена

- **[Бонусы/абуз] Запрет на суммирование реферального бонуса с регистрационным фактически не работает**
  - В настройках портала есть переключатель `stackWithRegistration`, но при выдаче регистрационного бонуса ошибка намеренно бросается и тут же глушится `catch {}`.
  - В итоге приглашённый клиент всегда получает регистрационные баллы даже при выключенном суммировании — прямой абуз баллов и рассинхрон настроек.
  - Где: `api/src/loyalty/loyalty.service.ts` (блок проверки реферала в `registrationBonus`).

## P2 — функциональные сбои/несоответствия настроек

Нет актуальных пунктов.

## P3 — несоответствия интерфейса/данных

- **[UX/данные] Плейсхолдер `{bonusamount}` в сообщении другу подставляет бонус приглашающему**
  - В настройках портала подсказки говорят, что `{bonusamount}` в тексте «Сообщение другу» — это награда другу, однако miniapp подставляет `inviterReward` (бонус приглашающему). Итог — пользователю показывается неверная сумма вознаграждения.
  - Где: `merchant-portal/app/referrals/program/page.tsx` (подсказки для плейсхолдеров), `miniapp/app/page.tsx` (подстановка `bonusAmount: inviterReward`).
