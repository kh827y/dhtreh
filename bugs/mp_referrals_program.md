# Реферальная программа (merchant-portal /referrals/program, /portal/referrals/program, /referral/*)

Недоработки отсортированы по убыванию критичности.

## P1 — критичные для продакшена

- **[Бонусы/абуз] Запрет на суммирование реферального бонуса с регистрационным фактически не работает**
  - В настройках портала есть переключатель `stackWithRegistration`, но при выдаче регистрационного бонуса ошибка намеренно бросается и тут же глушится `catch {}`.
  - В итоге приглашённый клиент всегда получает регистрационные баллы даже при выключенном суммировании — прямой абуз баллов и рассинхрон настроек.
  - Где: `api/src/loyalty/loyalty.service.ts` (блок проверки реферала в `registrationBonus`).

- **[SEC/данные] `POST /referral/activate` позволяет активировать код на чужого клиента**
  - Контроллер принимает `refereeId` напрямую, а `TelegramMiniappGuard` сверяет только `customerId` (поле `refereeId` игнорируется), поэтому можно отправить `refereeId` другого пользователя и активировать реферал не для себя.
  - Это даёт возможность создавать рефералов на «левые» аккаунты и некорректно начислять бонусы.
  - Где: `api/src/referral/referral.controller.ts` (логика выбора `refereeId`), `api/src/guards/telegram-miniapp.guard.ts` (проверка только `customerId`).

## P2 — функциональные сбои/несоответствия настроек

- **[Функционал] Настройка «За все покупки друга» не реализована**
  - В портале доступен выбор `rewardTrigger = all`, но в бэкенде награда приглашающему начисляется только один раз при `completeReferral`, после чего статус становится `COMPLETED` и повторных начислений не происходит.
  - Где: `merchant-portal/app/referrals/program/page.tsx`, `api/src/referral/referral.service.ts` (`completeReferral`).

- **[Функционал] Многоуровневая система в UI есть, но в расчётах не используется**
  - Портал позволяет включить multi-level и заполнить уровни, но бэкенд всегда начисляет бонус только пригласившему (уровень 1). Логики выплаты уровням 2–3 нет.
  - Где: `merchant-portal/app/referrals/program/page.tsx`, `api/src/referral/referral.service.ts` (`completeReferral`, `computeReferrerReward`).

- **[Ограничения] `maxReferrals` в программе не применяется**
  - Поле `maxReferrals` записывается при создании программы, но нигде не проверяется при `activateReferral`. Клиенты могут приглашать бесконечно, независимо от лимитов.
  - Где: `api/src/referral/referral.service.ts` (`createReferralProgram`, `activateReferral`).

## P3 — несоответствия интерфейса/данных

- **[UX/данные] Плейсхолдер `{bonusamount}` в сообщении другу подставляет бонус приглашающему**
  - В настройках портала подсказки говорят, что `{bonusamount}` в тексте «Сообщение другу» — это награда другу, однако miniapp подставляет `inviterReward` (бонус приглашающему). Итог — пользователю показывается неверная сумма вознаграждения.
  - Где: `merchant-portal/app/referrals/program/page.tsx` (подсказки для плейсхолдеров), `miniapp/app/page.tsx` (подстановка `bonusAmount: inviterReward`).
