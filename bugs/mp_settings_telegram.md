# Аудит: настройки Telegram уведомлений (merchant-portal)

Ниже перечислены проблемы и недоработки, отсортированные по убыванию важности устранения.

## Критично / безопасность

### 1) Генерация инвайт‑токена небезопасна (Math.random)
- **Где**: `PortalTelegramNotifyService.genToken()`.
- **Проблема**: токен для подключения Telegram‑уведомлений создаётся через `Math.random()`. Это не криптостойкий источник случайности, токен можно угадать/перебрать быстрее, чем ожидается.
- **Риск**: атакующий может подобрать токен и подписать свой чат/группу на уведомления мерчанта → утечка данных о заказах, отзывах и антифроде.
- **Как исправить**: использовать криптостойкий генератор (например, `crypto.randomBytes`) и хранить токены с достаточной энтропией.

### 2) Инвайт‑токен многоразовый и не привязан к первому чату
- **Где**: `issueInvite()` и `handleStartToken()`.
- **Проблема**: токен действует до 30 дней и может использоваться неограниченным числом чатов/групп; он не помечается «использованным» и не привязывается к конкретному chatId. Даже после генерации нового токена уже подписанные чаты остаются активными.
- **Риск**: при утечке токена можно массово подключить посторонние чаты и получать уведомления; ревокация затруднена (нужно вручную искать и отключать подписчиков).
- **Как исправить**: сделать токен одноразовым (или ограничить число подключений), либо сразу после первого использования ротацией гасить токен; добавить понятный механизм глобальной ревокации всех активных подписок для мерчанта/сотрудника.

## Высокий приоритет

### 3) Групповые подписки наследуют настройки конкретного сотрудника
- **Где**: `handleStartToken()` сохраняет `staffId` даже для групп; `actorKeyFromSubscriber()` выбирает настройки по `staffId` раньше типа чата.
- **Проблема**: если сотрудник подключает группу через свой инвайт, группа получает `staffId` и дальше использует **персональные** настройки сотрудника. Отключив/изменив свои уведомления, сотрудник непреднамеренно выключит уведомления в группе.
- **Риск**: потеря критичных уведомлений в общих каналах и неконсистентность настроек.
- **Как исправить**: для групп не сохранять `staffId` и всегда применять «общие» (merchant‑уровня) настройки; либо завести отдельные групповые настройки.

## Средний приоритет

### 4) Ошибки API по состоянию/подписчикам скрываются на фронте
- **Где**: `merchant-portal/app/settings/telegram/page.tsx`.
- **Проблема**: ответы `/state` и `/subscribers` не проверяются на `res.ok`. При 401/403/500 страница может молча показать пустые данные (например «Нет подключенных пользователей») без сообщения об ошибке.
- **Риск**: администратор считает, что уведомления отключены/подписчиков нет, хотя это сбой доступа/сервера → некорректные решения.
- **Как исправить**: проверять `res.ok`, корректно отображать ошибку и не затирать существующее состояние «пустыми» данными.
