# Аудит redeem-limits (backend)

Ниже — найденные проблемы по эндпоинтам `GET/PUT /portal/loyalty/redeem-limits`, отсортированные по убыванию важности.

## P1 — High

1. **Отложенное начисление может полностью «съедать» баллы, если `EARN_LOTS_FEATURE` выключен.**
   - В `loyalty.service` при `delayDays > 0` начисление переводится в режим отложенного начисления и не попадает в баланс сразу. Создание `earnLot` выполняется только при `EARN_LOTS_FEATURE=1`. Если флаг выключен, лоты не создаются, а немедленное начисление не делается — баллы фактически теряются.
   - Эндпоинт `PUT /portal/loyalty/redeem-limits` позволяет включить задержку без проверки feature-flag, поэтому в проде можно включить режим, который не работает и приводит к «тишинному» обнулению начислений.

## P2 — Medium

2. **PUT-запросы не являются частичными: отсутствие `ttlEnabled`/`delayEnabled` приводит к сбросу настроек.**
   - В `updateSettings` значения `ttlEnabled`/`delayEnabled` приводятся к `false`, если поле не передано. Это приводит к тому, что частичный апдейт (например, только `allowSameReceipt`) сбрасывает `pointsTtlDays`/`earnDelayDays` в `0`.
   - Для интеграторов/скриптов это легко превращается в неожиданное отключение сгорания или задержки начисления.

## P3 — Low

3. **Нет верхних границ для `ttlDays`/`delayDays`, что может приводить к некорректным датам и нагрузке.**
   - Сейчас принимаются любые значения (с округлением вниз и минимумом 1), без валидации «разумного» диапазона. Слишком большие значения могут порождать некорректные даты (overflow при `Date`) и тяжёлые вычисления в воркерах/хранилище.
   - Для SMB-сценария достаточно жесткого лимита (например, 1–3650 дней) — это защитит от ошибок интеграций и случайных «вечных» задержек.
