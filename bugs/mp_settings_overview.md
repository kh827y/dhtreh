# Аудит: merchant-portal /settings и /portal/settings

## P1 (высокий риск)

1. **[SEC][Access] `/portal/settings` отдаёт весь набор настроек любому staff с любыми правами из списка (system_settings или любой mechanic/antifraud/integrations)**
   - **Почему важно:** достаточно иметь доступ, например, только к механике TTL/рефералам, чтобы прочитать все системные настройки целиком. Это нарушает принцип наименьших привилегий и повышает риск утечки конфигурации интеграций/системных параметров в командах с разграничением ролей.
   - **Где видно:** `PortalController.assertSettingsReadAccess` разрешает чтение при наличии **любого** из ресурсов, а `PortalGuard` пропускает `GET /portal/settings` без явного ресурса. 

## P2 (средний риск)

2. **[DATA][QR] Смена типа QR может сбрасывать базовые ставки/лимиты на 0**
   - **Почему важно:** обработчик `/api/portal/settings/qr` собирает полный payload из `/portal/settings` и принудительно подставляет `earnBps`/`redeemLimitBps` как `0`, если сервер их не вернул. При переключении QR режима это может незаметно обнулить базовые ставки/лимиты (особенно если у мерчанта ещё используется legacy-логика ставок).
   - **Где видно:** `merchant-portal/app/api/portal/settings/qr/route.ts`.

## P3 (низкий/средний риск)

3. **[UX][Timezone] Список таймзон в /settings/system не синхронизирован с сервером и содержит несоответствия**
   - **Почему важно:** фронт использует статический список и собственные подписи городов (например, `MSK+4` подписан как «Красноярск»), тогда как серверный источник истины называет другой регион (`Барнаул/Алтай и Красноярский край`) и отдаёт полный набор options через `/portal/settings/timezone`. В итоге пользователь видит не ту зону, что реально сохранена, а аналитика/уведомления могут интерпретироваться неверно.
   - **Где видно:** `merchant-portal/app/settings/system/page.tsx` (статический список) и `api/src/timezone/russia-timezones.ts` (источник истины).

4. **[UX][Prod] В обзоре настроек жестко прописан URL админ‑панели `http://localhost:3001/merchants`**
   - **Почему важно:** в продакшене ссылка ведёт на localhost и не открывается, а также использует HTTP. Это ломает навигацию на ключевую часть настройки (админ‑панель) и создаёт ощущение «заглушки».
   - **Где видно:** `merchant-portal/app/settings/page.tsx`.
