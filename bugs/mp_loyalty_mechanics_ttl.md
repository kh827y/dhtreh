# Аудит механики TTL: напоминания о сгорании баллов

## Критично

1. **Дублирующая логика списания TTL и риск двойного сгорания баллов.**
   - В проекте одновременно существуют два воркера сгорания: `PointsBurnWorker` (флаг `POINTS_TTL_BURN`) и `TtlBurnWorker` (флаг `TTL_BURN_ENABLED`).
   - Оба воркера проходят по `pointsTtlDays`, но работают по разным правилам (один сжигает все lot'ы до cutoff, второй — только purchase lot'ы с `orderId`).
   - Если оба флага включены, возможно двойное списание и расхождение учёта. Дополнительно `TtlBurnWorker` не использует advisory lock — при нескольких инстансах может сработать параллельно.
   - Файлы: `api/src/points-burn.worker.ts`, `api/src/ttl-burn.worker.ts`.

2. **Дедупликация напоминаний не работает → повторная рассылка при каждом запуске воркера.**
   - В `PointsTtlReminderWorker` проверка дублей ищет `pushNotification.type = 'TTL_REMINDER'`, но отправка делается через `PushService` с типом `SYSTEM`.
   - Из-за несовпадения типов запись дубля не находится и напоминание уходит повторно при каждом тике воркера.
   - Файлы: `api/src/points-ttl-reminder.worker.ts`, `api/src/notifications/push/push.service.ts`.

## Высокая важность

3. **Механика “Напоминание о сгорании” может быть включена при выключенном TTL баллов.**
   - UI на странице `/loyalty/mechanics/ttl` не проверяет `pointsTtlDays` и не блокирует включение напоминаний.
   - Воркеры напоминаний строго требуют `pointsTtlDays > 0` → при выключенном TTL уведомления никогда не будут отправлены, но в UI всё выглядит активным.
   - Файлы: `merchant-portal/app/loyalty/mechanics/ttl/page.tsx`, `merchant-portal/app/api/portal/loyalty/ttl/route.ts`, `api/src/points-ttl-reminder.worker.ts`.

4. **UI показывает фиксированное расписание “ежедневно в 10:00”, которое не соответствует реальной работе воркера.**
   - На странице указан жёсткий график, но воркер запускается по интервалу `POINTS_TTL_REMINDER_INTERVAL_MS` (по умолчанию каждые 6 часов) и не привязан к конкретному времени/часовому поясу.
   - Риск: неверные ожидания у бизнеса, вопросы к саппорту при несоответствии факту.
   - Файлы: `merchant-portal/app/loyalty/mechanics/ttl/page.tsx`, `api/src/points-ttl-reminder.worker.ts`.

## Средняя важность

5. **Блок “Прогноз охвата” — статичная заглушка, выдаёт фиктивные цифры.**
   - Значения `~142` и прогресс 35% захардкожены и не связаны с аналитикой/данными.
   - Риск: менеджер принимает решения на недостоверных данных.
   - Файл: `merchant-portal/app/loyalty/mechanics/ttl/page.tsx`.

6. **Backend не ограничивает `daysBefore` и длину текста, что может привести к неоправданной нагрузке.**
   - `PUT /api/portal/loyalty/ttl` принимает любое положительное значение и текст без верхней границы.
   - При слишком большом `daysBefore` окно выборки lot'ов в воркере раздувается, что увеличивает нагрузку на БД.
   - Файлы: `merchant-portal/app/api/portal/loyalty/ttl/route.ts`, `api/src/points-ttl-reminder.worker.ts`.
