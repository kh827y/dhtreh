# Аудит: merchant-portal/app/loyalty/actions-earn/page.tsx

Ниже — найденные проблемы и несоответствия, отсортированные по убыванию важности.

## P1 — критично для корректной работы/доверия

1. **PUSH-уведомления «при старте/перед окончанием» фактически не отправляются в PUSH-канал.**
   - **Симптом**: в UI можно включить «PUSH при старте» и «Напомнить об окончании», но в payload нет `pushTemplateStartId`/`pushTemplateReminderId`. В backend `schedulePromotionNotifications()` создаёт PUSH-задачи **только** если задан templateId. В результате задачи для PUSH не создаются — фактически сработают только Telegram-уведомления (если бот включён), а PUSH — нет.
   - **Риск**: мерчант уверен, что уведомления уходят всем клиентам, но в реальности они не отправляются, что бьёт по эффективности и репутации.
   - **Где**: `merchant-portal/app/loyalty/actions-earn/page.tsx` (формирует payload с `pushOnStart/pushReminderEnabled/metadata`), `api/src/loyalty-program/loyalty-program.service.ts` (PUSH создаётся только при `pushTemplateStartId`/`pushTemplateReminderId`).

2. **«Сгорают после окончания акции» не работает для бессрочных акций и никак не сигнализируется.**
   - **Симптом**: пользователь может включить флаг «Сгорают после окончания акции» и одновременно поставить «Бессрочно». В backend расчёт срока сгорания опирается на `endAt`: если `endAt` отсутствует, срок сгорания становится `null` → баллы **никогда не сгорают**.
   - **Риск**: мерчант думает, что баллы «сгорят», но они остаются навсегда → прямые финансовые потери и риск абуза.
   - **Где**: `merchant-portal/app/loyalty/actions-earn/page.tsx` (нет блокировки/предупреждения), `api/src/loyalty/loyalty.controller.ts` (`resolvePromotionExpireDays()` возвращает `null` без `endAt`).

## P2 — важные UX/логические несоответствия

3. **Тумблер «Начисление баллов» в UI не работает и вводит в заблуждение.**
   - **Симптом**: если выключить тумблер `accruePoints`, `handleSave` всё равно блокирует сохранение («Укажите количество баллов»). В списке промо `accruePoints` насильно выставляется в `true`.
   - **Риск**: лишний/legacy‑контрол, который создаёт ложные ожидания и может ломать сценарии (пользователь думает, что можно создать акцию без начисления, но система не позволяет).
   - **Где**: `merchant-portal/app/loyalty/actions-earn/page.tsx` (валидация и маппинг списка).

4. **Статус «сгораемости» в карточке может показываться неверно, если TTL задан через `pointsExpireInDays`.**
   - **Симптом**: UI определяет сгораемость только по `rewardMetadata.pointsExpire/pointsExpireAfterEnd`. Если акция создана/изменена через другие интерфейсы/скрипты с `pointsExpireInDays`, UI покажет «Баллы не сгорают» и при редактировании не отразит реальную настройку.
   - **Риск**: неверная информация для мерчанта и ошибки в управлении сроками баллов.
   - **Где**: `merchant-portal/app/loyalty/actions-earn/page.tsx` (функция `extractPointsExpireFlag`), `api/src/loyalty-program/controllers/promotions.controller.ts` (в ответе есть `pointsExpireInDays`).

## P3 — несоответствия в поведении/логике

5. **Статус «Активная» в портале не различает «запланирована» (SCHEDULED).**
   - **Симптом**: если выставить будущую дату старта и поставить «Активная», в backend статус сохраняется как `ACTIVE`, а в портале промо показывается как активное. При этом в miniapp промо не появляется до наступления `startAt`.
   - **Риск**: несостыковка ожиданий (в портале «активна», но в приложении клиент её не видит).
   - **Где**: `merchant-portal/app/loyalty/actions-earn/page.tsx` (payload всегда `ACTIVE`/`DRAFT`, нет `SCHEDULED`), `api/src/loyalty/loyalty.controller.ts` (листинг в miniapp фильтруется по `startAt`).
