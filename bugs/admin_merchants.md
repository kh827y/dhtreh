# Аудит admin/merchants

Ниже проблемы отсортированы по убыванию критичности.

## P1 — Высокая критичность

### 1) Любое обновление мерчанта в `/admin/merchants/:id` снимает архивирование
**Где:** `api/src/admin-panel/admin-merchants.controller.ts` → `updateMerchant()`.

**Что происходит:** `archived` по умолчанию принудительно ставится в `false` (`archived: body.archived ?? false`). В сервисе это приводит к `archivedAt = null`. То есть любое обновление имени/email/пароля автоматически «разархивирует» мерчанта.

**Риск/влияние:** скрытые или отключённые мерчанты могут неожиданно стать активными, что нарушает административные ограничения и может привести к ошибкам в продакшене.

**Что проверить/исправить:** не менять `archived` при апдейте, если поле не передано; обновлять архивирование только при явном запросе.

## P2 — Средняя критичность

### 2) `/admin/merchants` позволяет создавать мерчанта без portal‑логина и без валидации пароля
**Где:** `api/src/admin-panel/admin-merchants.controller.ts` → `createMerchant()`, `api/src/admin-panel/admin-merchants.service.ts` → `createMerchant()`.

**Что происходит:** `portalEmail` и `portalPassword` необязательны, длина пароля не проверяется. В итоге создаётся мерчант с `portalLoginEnabled = true`, но без `portalEmail` и/или без `portalPasswordHash`.

**Риск/влияние:** мерчант в базе формально «включён» для портала, но зайти в портал невозможно (нет email/пароля), что приводит к непредсказуемым ошибкам и ручным разбирательствам.

**Что проверить/исправить:** либо требовать `portalEmail + portalPassword` (с минимальной длиной) при создании через `/admin/merchants`, либо при отсутствии данных автоматически отключать портал (`portalLoginEnabled = false`) и явно маркировать «портал не настроен».

## P3 — Низкая критичность

### 3) TOTP‑инициализация в UI «размазывается» по всем мерчантам
**Где:** `admin/app/merchants/page.tsx`.

**Что происходит:** состояние `totp` и `code` глобальные для всей страницы, а блок подтверждения TOTP рендерится внутри каждой карточки мерчанта. При инициализации TOTP у одного мерчанта секрет/QR отображается во всех строках, а поле ввода кода дублируется.

**Риск/влияние:** админ может подтвердить TOTP не там, где ожидал, или случайно «спутать» мерчанта. Это создаёт риск ошибок настройки 2FA.

**Что проверить/исправить:** привязать `totp`/`code` к конкретному `merchantId`, показывать блок только в карточке инициированного мерчанта.

### 4) Статистика «Активные» включает мерчантов без подписки
**Где:** `admin/app/merchants/page.tsx`, `admin/lib/merchants.ts`.

**Что происходит:** `active` вычисляется как `total - expired`, а `subscriptionExpired` для мерчантов без подписки приходит как `false`. В результате мерчант без подписки считается «активным».

**Риск/влияние:** админ‑аналитика и фильтры вводят в заблуждение (мерчанты без подписки учитываются как активные), что усложняет поддержку и управление доступом.

**Что проверить/исправить:** считать «активным» только мерчанта со статусом подписки `active` (или явно учитывать `missing` как неактивный).
