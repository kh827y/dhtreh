# Аудит категорий (merchant-portal)

## Высокий приоритет

1. **Можно создать циклическую иерархию категорий (parent = descendant), что ломает дерево и может уронить страницу.**
   - В UI при выборе родительской категории исключается только текущая категория, но не её потомки. Это позволяет назначить родителя вглубь дерева.
   - В бекенде нет проверки на циклы — запрещён только `parentId === categoryId`, поэтому цикл сохраняется в БД.
   - На странице `/categories` рекурсивный расчёт `getDescendantIds` будет зацикливаться и может привести к переполнению стека/крашу, а дерево категорий исчезнет или отрисуется некорректно.
   - Файлы: `merchant-portal/app/categories/page.tsx` (выбор родителя, `getDescendantIds`), `api/src/portal/catalog.service.ts` (`updateCategory`, проверка родителя).

2. **Удаление категории с подкатегориями разрешено через API, что оставляет «висячие» подкатегории.**
   - UI блокирует удаление, если есть дети, но бекенд `deleteCategory` не проверяет наличие подкатегорий и просто помечает категорию как `deletedAt`.
   - Подкатегории остаются с `parentId`, указывающим на удалённую запись. Это ломает структуру каталога, отчёты по категориям и навигацию в UI (дети неожиданно становятся корневыми).
   - Файлы: `merchant-portal/app/categories/page.tsx` (проверка только на фронте), `api/src/portal/catalog.service.ts` (`deleteCategory`).

## Средний приоритет

3. **Частичное сохранение изменений при редактировании категории: обновление товаров и категории не атомарно.**
   - При сохранении категории UI сначала создаёт/обновляет категорию, затем отдельными запросами обновляет товары. Если часть запросов на товары упадёт — категория уже сохранена, а товары обновлены частично.
   - В результате пользователь видит ошибку, но данные в системе уже изменены; состояние каталога становится неочевидным и требует ручной проверки.
   - Файлы: `merchant-portal/app/categories/page.tsx` (`handleSaveCategory`, последовательные запросы `PUT /catalog/products/:id`).
