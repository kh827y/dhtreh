# Аудит admin/merchants (backend)

Ниже проблемы, отсортированные по убыванию важности.

## P1 — Высокая

- **[SEC] Админ‑IP whitelist можно обойти через подмену `X-Forwarded-For`.**
  - **Где**: `AdminIpGuard` берёт IP из `x-forwarded-for` без проверки доверенного прокси и использует его для белого списка.
  - **Риск**: если `ADMIN_KEY` утечёт, атакующий сможет обходить IP‑ограничение, подставляя нужный IP в заголовок.
  - **Связанные эндпоинты**: все `admin/merchants/*`, т.к. guard висит на контроллере.

## P2 — Средняя

- **`PUT /admin/merchants/:id` всегда разархивирует мерчанта при любом апдейте.**
  - **Причина**: в контроллере `archived` по умолчанию = `false`, и сервис получает `archived: false`, если поле не передано.
  - **Риск**: любое обновление (например, смена имени) случайно делает мерчанта активным.

- **Проверка уникальности `portalEmail` выполняется без нормализации (lowercase/trim), что приводит к 500 вместо понятной ошибки.**
  - **Где**: `createMerchant` и `updateMerchant` сравнивают email «как есть», но сохраняют `trim().toLowerCase()`.
  - **Риск**: при вводе `Test@Mail.com` при наличии `test@mail.com` проверка не сработает, а сохранение упадёт на уникальном индексе (ошибка 500), что ухудшает UX админки.

## P3 — Низкая

- **Нельзя очистить `portalEmail`/`portalPassword` через `PUT /admin/merchants/:id`.**
  - **Причина**: контроллер переводит `null` в `undefined`, из‑за чего сервис не может сбросить значения.
  - **Риск**: админ не может «отвязать» email/пароль при деактивации портала или исправлении ошибки.

- **`POST /admin/merchants` включает `portalLoginEnabled` даже если email/пароль не заданы.**
  - **Риск**: в списке админки мерчант выглядит как «логин включён», но вход невозможен (нет пароля), что путает поддержку/админа.
