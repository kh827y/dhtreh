# Аудит: статус админки и system status endpoints

Ниже проблемы отсортированы по убыванию критичности для продакшена.

## P1 — Critical/High

1) **Админ‑страница «Состояние API» может показывать «здоровый» статус при фактическом падении API/БД**
   - **Почему критично**: мониторинг в админке не сигнализирует о проблеме → операторы видят «всё ок», хотя API уже не отвечает/БД недоступна.
   - **Причина**:
     - `/api/health` возвращает JSON с `ok: false`, но статус HTTP остаётся `200`, поэтому `fetch` считает ответ успешным и `err` не выводится.
     - UI не проверяет `data.ok`/`ready` и всегда отображает `version/flags/workers`, даже если `ok: false`.
   - **Где**: `admin/app/status/page.tsx` (логика `load` + отображение), `admin/app/api/health/route.ts`, `api/src/health.controller.ts` (`healthz` всегда 200).
   - **Риск/эффект**: ложное ощущение «всё работает», позднее обнаружение инцидентов.

## P2 — Medium

2) **Набор health‑эндпоинтов дублируется и частично даёт «успех» без реальных проверок**
   - **Почему важно**: разные endpoints (`/health`, `/ready`, `/live`, `/healthz`, `/readyz`) ведут себя по‑разному; легко подключить не тот и получить «зелёный» статус при реальном падении зависимостей.
   - **Причина**:
     - `/health` всегда возвращает `status: ok`, не проверяя БД/воркеры.
     - `/ready` возвращает JSON `status: not_ready`, но HTTP‑статус остаётся 200.
     - `/healthz`/`readyz` возвращают `ok/ready: false`, но тоже всегда 200.
   - **Где**: `api/src/app.controller.ts` (`/health`, `/ready`, `/live`), `api/src/health.controller.ts` (`/healthz`, `/readyz`).
   - **Риск/эффект**: неправильная интеграция в мониторинг/балансировщик, ложные green‑checks.

3) **Статус воркеров отображается недостоверно (часть всегда `alive: true`)**
   - **Почему важно**: UI показывает, что фоновые задачи живы, даже если они не запускались или выключены флагами.
   - **Причина**: `holdGc`/`idemGc` в `healthz/readyz` всегда `alive: true` без фактической проверки; `ttl*` и `outbox` показываются только по `startedAt`, но на странице нет объяснения, что это «не стартовали».
   - **Где**: `api/src/health.controller.ts` (блок `workers`), `admin/app/status/page.tsx` (без интерпретации статуса).
   - **Риск/эффект**: оператор принимает неверные решения (считает, что outbox/GC/TTL работают, когда они остановлены).

## P3 — Low

4) **Админ‑страница не показывает ключевые readiness‑сигналы (миграции/БД), хотя они есть**
   - **Почему важно**: для продакшена важно видеть `ready`/состояние миграций; сейчас админка дергает только `/healthz` и не показывает `readyz`.
   - **Где**: `admin/app/status/page.tsx` (используется только `/api/health`), `api/src/health.controller.ts` (`readyz` возвращает `migrations`).
   - **Риск/эффект**: ошибки миграций или незапущенная БД могут остаться незамеченными в админке.
