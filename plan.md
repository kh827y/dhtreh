# Planning Mode — Long Run (2025-09-15)  
## Новая целевая структура панелей (договорились)

### Админ‑панель (Owner Admin)
- **Мерчанты**
  - CRUD + удаление. POST `/merchants` требует `ownerName`, автоматически создаёт сотрудника‑владельца (роль `MERCHANT_OWNER`, canAccessPortal=true, доступ запрещён отключать).
  - Таблица мерчантов в админке поддерживает имперсонацию «Открыть как мерчант», редактирование владельца, архивирование и soft-delete.
- **Настройки мерчанта**
  - Перенос флагов: QR TTL, «Требовать подпись Bridge», «Требовать Staff‑ключ» из портала в админку.
  - Настройка кассового логина: slug от имени мерчанта + генерация/регенерация 9‑значного пароля, просмотр только в админке.
- **Интеграции и наблюдаемость**
  - Настройка общесистемного Telegram‑бота (BotFather token), валидация и сохранение.
  - Метрики `/metrics`, Outbox, SyncLog, интеграции POS/ERP, health чек листов.

### Мерчант‑панель (Merchant Portal)
- **Мастер настройки** — включается при первом входе, проверяет заполненность профиля, точек, кассиров, интеграций.
- **Настройки** (вкладки): Торговые точки, Сотрудники, Права доступа, Интеграции, Уведомления в Telegram, Системные настройки, Панель кассира (логин/пароль + таблица пинкодов сотрудников и их торговых точек).
- **Сотрудники**
  - Табы «Работает» и «Уволен» с подсветкой активного, счётчик «Найдено: * записей».
  - Фильтры: роли (по умолчанию «Все роли»), торговые точки («Все торговые точки»), тумблер «Только с доступом в панель», поиск по имени/email.
  - Таблица: аватар/имя (для владельца бейдж «А»), торговые точки, активность (tooltip «Дата последней транзакции или входа в панель управления»), доступ в панель (✔/✖).
  - Клик по строке → карточка сотрудника (аватар с edit, модалки редактирования/смены пароля/увольнения, просмотр транзакций, управление доступами, связка торговых точек с пинкодами, обновление/отзыв пинов).
  - Создание сотрудника: модальное окно с обязательным именем, опциональными полями, тумблером доступа в панель (подсказка), выбором/созданием групп доступа, email+пароль при включении доступа, авто‑выдача уникального 4‑значного пинкода.
- **Торговые точки**
  - Полный CRUD вместо «Устройств», вкладки «Работают»/«Не работают», карточки точек, создание с вкладками «Основное», «Режим работы», «Интеграции».
  - Интеграция ссылок на карточку точки для отзывов (Яндекс/2ГИС/Google).
- **Права доступа**
  - Страница групп доступа с таблицей (№, название, участников, R/U/D), создание/редактирование группы с чекбоксами CRUD прав и подбором сотрудников.
- **Программа лояльности**
  - Механики: карточки (уровни, ограничения, автовозврат, ДР, баллы за регистрацию, напоминание о сгорании, рефералка) + страницы по детальному ТЗ.
  - Акции: вкладки Предстоящие/Текущие/Прошедшие, карточки с KPI и графиками, модальное создание (2 шага, типы акций, настройки).
  - Акции с начислением баллов: модалка создания (название, период, аудитория, начисления, push‑уведомления, запуск).
  - Промокоды: вкладки Активные/Архивные, таблица (код, описание, баллы, группы, срок, использовано, R/U/D), модальное создание с ограничениями/сгоранием/повторным использованием.
  - Push‑ и Telegram‑рассылки: вкладки Активные/Архивные, модалки создания по ТЗ (лимиты символов, загрузка изображений, даты).
  - Мотивация персонала, Защита от мошенничества — страницы с настройками/полями согласно ТЗ.
- **Клиенты и аудитории**
  - Список клиентов (таблица + фильтры, модалки добавления/импорта, карточка клиента с историей/отзывами/операциями).
  - Аудитории: таблица, поиск, модалка создания/редактирования с сегментами/фильтрами, вкладка «Состав аудитории».
- **Отзывы**
  - Сбор отзывов после начисления/списания баллов в миниаппе (звёзды 1–5, комментарий). Раздел «Отзывы» в портале с фильтрами (только с комментариями, торговая точка, сотрудник), таблица отзывов, модалка настроек уведомлений/телеграм/внешние сервисы.
- **Аналитика**
  - Раздел «Аналитика»: Сводный отчёт, По времени, Портрет клиента, Повторные продажи, Динамика, RFM‑анализ, Активность точек, Активность сотрудников, Реферальная программа, Дни рождения, Автовозврат клиентов — графики ECharts, экспорт, фильтры, карточки KPI, поддержка тёмной темы.
- **Инструменты**
  - Импорт данных (CSV) — страница, соответствующая текущему описанию.

> Конечное меню портала (слева): Мастер настройки → Аналитика (Сводный отчёт, По времени, Портрет клиента, Повторные продажи, Динамика, RFM-анализ, Активность торговых точек, Активность сотрудников, Реферальная программа, Дни рождения, Автовозврат клиентов) → Программа лояльности (Механики, Акции, Акции с начислением баллов, Push-рассылки, Telegram-рассылки, Промокоды, Мотивация персонала, Защита от мошенничества, Панель кассира) → Отзывы (Обратная связь) → Клиенты и аудитории (Клиенты, Аудитории) → Товары и категории (Товары, Категории) → Карта Wallet (заглушка) → Настройки (Торговые точки, Сотрудники, Права доступа, Интеграции, Уведомления в Telegram, Системные настройки) → Инструменты (Импорт данных).

### Cashier / Miniapp
- Авторизация кассира: логин (slug мерчанта, lowercase, без пробелов/символов), пароль 9 цифр (UI с 9 ячейками, формат XXX-XXX-XXX), затем ввод 4‑значного пинкода сотрудника.
- Виртуальный терминал отображает привязанные торговые точки, операции проводят по выбранной точке.
- Miniapp после каждой покупки показывает модалку отзывов.

### Прочее
- «Устройства» — полностью удалить (бэкенд/фронтенд/Prisma).
- План по дизайну: единая дизайн‑система (Radix + shadcn/ui или @loyalty/ui), токены темы, light/dark, glassmorphism, анимации (Framer Motion), иконки Lucide, шрифты (Inter/Manrope + JetBrains Mono). Все новые экраны соблюдают радиусы/spacing/hover/focus.

## Батчи внедрения (план)

1) **Админ + базовые сущности**
   - Расширить Admin API для CRUD мерчантов с ownerName и авто‑созданием владельца.
   - Миграции: `Staff` (личные поля, pinCode, canAccessPortal, isOwner), `Merchant` (cashierLogin/password9, archivedAt), `AccessGroup`, `StaffOutletAccess`, `StaffAccessLog` (активность), `Outlet` (кастомные поля отзывов/адрес/времена), `PromoCode`, `LoyaltyCampaign`, `Audience`, `Review` и вспомогательные таблицы.
   - Перенос системных настроек (QR TTL, BridgeSig, StaffKey) в Admin UI, портальные убрать.
   - Генерация и хранение кассовых учётных данных + API/CLI для сброса.

2) **Настройки / Торговые точки / Права доступа**
   - Удалить «Устройства» везде (Prisma модели, API, фронты, тесты).
   - CRUD торговых точек с вкладками, интеграциями (ID внешних систем), ссылками на отзывы, расписанием, координатами.
   - Группы доступа: модели прав, административный UI, портальные модалки, синхронизация со `Staff`.
   - Панель кассира: API выдачи пинов, обновление/отзыв, лог активности, экспорт.

3) **Сотрудники и кассовый флоу**
   - Портал: раздел сотрудников по ТЗ (табы, фильтры, карточки, модалки, таблица пинов, просмотр транзакций).
   - API: CRUD сотрудников, смена пароля (owner only), увольнение (soft delete), восстановление, выдача пинкодов, привязка к точкам, лог активности.
   - Cashier UI: новая авторизация (мерчант логин + 9 цифр, затем пин), современный дизайн, поддержка тёмной темы.

4) **Программа лояльности и механики**
   - Механики: страницы по каждому сценарию (уровни, ограничения, автовозврат, ДР, баллы за регистрацию, напоминания, рефералка) с настройками и статистикой.
   - Акции: список/карточки/модалки создания (типы, правила, аудитории, push), архивирование, дубль.
   - Промокоды: полный CRUD, начисление баллов, ограничения использования, сгорание, изменение уровня.
   - Push/Telegram рассылки: модалки создания с ограничениями, превью, загрузкой изображений.
   - Мотивация персонала, Антифрод, Панель кассира — UI/бэкенд по ТЗ.

5) **Аналитика, отзывы, аудитории, клиенты**
   - Аналитика: все разделы из ТЗ, ECharts, экспорты, фильтры, KPI, поддержка reduce‑motion.
   - Отзывы: миниаппа модалка, запись в API, портал список + фильтры + настройки уведомлений + интеграция со ссылками точек.
   - Аудитории: гибкий конструктор фильтров, состав аудитории, экспорт/импорт, связи с акциями/рассылками.
   - Клиенты: обновить список/карточку/модалки (добавление, комплиментарные баллы), импорт CSV.

6) **Интеграции и API паритет**
   - Провести аудит API vs `gmb_api.pdf` и `gmb_catalog_api.pdf`, закрыть пробелы, добавить тесты/документацию.
   - Реализовать/обновить адаптеры: 1C (UNF/UT/Розница), r_keeper (plug/kassir), iiko (delivery/kassir/waiter), Evotor, Poster, Frontol, МойСклад, CommerceML. Обеспечить логирование, валидацию, dry‑run, метрики.
   - Документировать шаги интеграции, обновить `API_DOCUMENTATION.md`, `PROJECT_DOCUMENTATION.md`, `DEPLOYMENT_GUIDE.md`.

Каждый батч → тестовый ритуал: `pnpm -C api test && pnpm -C api test:e2e`. Обновлять README/Docs и этот план.

Обновлённый рабочий план доведения проекта лояльности до стабильного и надёжного состояния с современным UI. План синхронизирован с Memories (dev/test ритуал, бэкенд гарантий, Prisma‑правила, фичефлаги/воркеры, интеграции/bridge, фронтенды, DoD).

## Волны работ

- Волна 0 — Префлайт (завершена)
  - Пересмотр плана.
  - Строгий TS/ESLint/Prettier, базовый `tsconfig.base.json`. Скрипты: `typecheck`, `lint`, `lint:fix`, `test`.
  - Глобальная защита API: Helmet, CORS из `CORS_ORIGINS`, Nest Throttler/Redis, JSON‑логирование (pino). Валидация ENV (fail‑fast).
  - Прогон тестов: `pnpm -C api test && pnpm -C api test:e2e`.

- Волна 1 — Устойчивость и надёжность бэкенда
  - Идемпотентность commit/refund через `Idempotency-Key`, ретраи безопасны.
  - Транзакционные границы в денежных сценариях; инварианты Wallet/Transaction/Hold покрыты тестами.
  - Фичефлаги: `EARN_LOTS_FEATURE`, `POINTS_TTL_FEATURE`, `POINTS_TTL_BURN`, переключатель `WORKERS_ENABLED` — тесты сценариев TTL/отложенных начислений.
  - Алерты на 5xx/аномалии; базовые метрики latency/RPS/errors.

- Волна 2 — Функции лояльности (ядро)
  - Уровни (CustomerLevel): правила перехода и выгоды.
  - TTL/сгорание баллов: безопасный расчёт; тесты.
  - Промокоды/ваучеры: выпуск/активация/ограничения; анти‑фрод капы.
  - Рефералка многоуровневая; защита от саморефералки/дубликатов.
  - Акции: buy‑N‑get‑1, спеццены, бонусные коэффициенты.
  - Подарки за баллы и «Подарок на ДР».

- Волна 3 — Коммуникации и CRM/аналитика
  - Email/push через адаптеры, сегментация; outbox + ретраи.
  - Отчёты LTV/ретеншен/ARPU, сегменты и выгрузки.

- Волна 4 — Интеграции и Bridge
  - Единый интерфейс адаптеров: POS/Payments/ERP/Shipper; dry‑run, валидация конфигов, подписанные webhooks.
  - Минимальные коннекторы (iiko/r_keeper/frontol/Evotor/1C/CommerceML/robokassa/ecommpay/DPD и др.) с записями `Integration`.
  - Встроить в Bridge; подпись `BRIDGE_SECRET`.

- Волна 5 — Фронтенды (Owner Admin / Merchant Portal / Cashier / Miniapp)
  - Современный UI: единая дизайн‑система, i18n, доступность, skeletons/загрузки.
  - Owner Admin (админ‑консоль): глобальные настройки и наблюдаемость системы (страница Metrics, воркеры, Outbox/вебхуки, POS‑метрики, интеграции), управление мерчантами и ролями; режим «Просмотр как мерчант» с правом редактирования.
  - Merchant Portal (личный кабинет бизнеса): аналитика и CRM, механики/акции, аудитории, промокоды, отзывы; настройки перенесены в админку.
  - Cashier: QR → quote → commit, возвраты, безопасные повторы. Авторизация кассира: login = slug от имени мерчанта, пароль = 9 цифр; у сотрудников — пинкод 4 цифры (по точкам).
  - Miniapp (Telegram): баланс/история/QR, промо/подарки/ДР, уведомления; рефералка через deep‑link t.me/<bot>?start=ref_<code> и активацию при первом визите мини‑аппы.

## Definition of Done (общие)
- Строгий TS, валидируемые ENV; глобальные фильтры ошибок и логирование; Helmet/CORS/rate‑limit включены.
- Все тесты зелёные: `pnpm -C api test && pnpm -C api test:e2e`.
- Миграции Prisma — атомарны; без потерь денежных данных; тесты на миграции и инварианты.
- Современный UI и понятные UX‑флоу на фронтендах.
- Документация обновлена: README/DEPLOYMENT_GUIDE/API_DOCUMENTATION; краткий итог в `plan.md`.

## Риски и блокеры
- Отсутствующая dev‑БД → поднять Docker Compose.
- Долгие агрегации аналитики → кеш Redis + индексы.
- Интеграции с внешними API → мок/фичефлаги, dry‑run.

## Выполнено недавно
- Модернизация admin analytics: единый `TopBar`/`Card`/`Skeleton`, улучшенные графики (`SimpleLineChart` с tooltip/hover/линейкой).
- Инициализирован `merchant-portal` (Next.js) — базовый дашборд, подключение дизайн‑системы.
- Создан пакет `@loyalty/ui` (токены темы, базовые компоненты: Button/Card/Skeleton/Chart; иконки Lucide; анимации Framer Motion). Обновлён `pnpm-workspace.yaml`.
- Merchant Portal: реализована аутентификация по email+паролю (+ TOTP опц.), добавлена страница `/login`, middleware защиты, server routes `/api/session/*`.
- API: модуль `PortalAuth` (`POST /portal/auth/login`, `GET /portal/auth/me`), CORS для `authorization`, `PORTAL_JWT_SECRET` в ENV и `infra/env-examples/api.env.example`.
- Prisma: у `Merchant` добавлены `portalEmail` (unique), `portalPasswordHash`, а также `portalKeyHash/portalTotpSecret/portalTotpEnabled/portalLoginEnabled/portalLastLoginAt`; миграции применены.
- Admin: «Мерчанты» — список/создание (Name/Email/Password), включение/выключение входа, TOTP (init/verify/disable), «Открыть как мерчант» (имперсонация в портал).
- Merchant Portal: подключены данные — `Настройки` (GET/PUT), `Сотрудники` (список/создать), `Точки` (список/создать), `Устройства` (список/создать), `Клиенты` (поиск по телефону), `Операции` (транзакции/чеки); добавлены `Ваучеры` (список/выпуск/деактивация), `Рассылки` (dry-run/enqueue), `Интеграции` (список); аналитика подключена: `Дашборд`, `RFM`, `Портрет`, `Повторы`, `Время`, `ДР` (через портальные прокси `/portal/analytics/*`).
 - PortalAuth: добавлены e2e-тесты `login` (email+пароль), ветвь `TOTP`, `me` и админская имперсонация; внедрён jose-wrapper `getJose()` для стабильных тестов (используется в `PortalAuthController`, `PortalGuard`, `MerchantsService.signPortalJwt`); добавлен smoke‑тест портальной аналитики; обновлён `README` (раздел PortalAuth/имперсонация); все тесты зелёные.
- RBAC: переименована роль `MANAGER` → `MERCHANT` во фронтах/admin‑proxy и Prisma enum (миграция).
- Аналитика backend: заменены сырые SQL ($queryRaw) на Prisma в `getTopCustomers/getTopOutlets/getTopStaff/getDeviceUsage`.
- Включён строгий TS на уровне монорепо: обновлён `tsconfig.base.json` (`strict`, `noUncheckedIndexedAccess`).
- Настроены ESLint/Prettier во всех пакетах (`api`, `admin`, `cashier`, `miniapp`, `bridge`); добавлены корневые `.prettierrc`, `.prettierignore`, `.eslintignore`, `.editorconfig`.
- Корневой `package.json`: добавлены скрипты `format`/`format:check` и унифицированные `typecheck/lint`.
- API hardening: подтверждены Helmet/CORS/Throttler/Pino; добавлена schema‑валидация ENV через Ajv (fail‑fast в `api/src/main.ts`).
- Поднята dev‑БД (`docker compose -f infra/docker-compose.yml up -d`), применены миграции (`prisma migrate deploy`).
- Тестовый ритуал выполнен: `pnpm -C api test && pnpm -C api test:e2e` — зелёные.

- 5xx алерты: `AlertsService` интегрирован в `HttpMetricsInterceptor`, сэмплинг по `ALERTS_5XX_SAMPLE_RATE`; добавлены переменные для Telegram в `api/.env.example`.
- Идемпотентность commit: `merchantId` выводится из `hold`, кэшируемый ответ нормализован (устранён дрейф `alreadyCommitted`), повторные вызовы стабильно детерминированы.
- Антифрод: `dailyCap` переведён на скользящее 24‑часовое окно, чтобы избежать TZ/полуночных артефактов.
- E2E: добавлен тест идемпотентности `refund` (повтор по одному `Idempotency-Key`).
- Wave 1: углублённые e2e по идемпотентности и инвариантам — коллизии `orderId`, конкурентные `commit`, многошаговые частичные `refund` для `EARN/REDEEM`, идемпотентность `refund`.
- Воркеры/флаги: добавлены unit‑тесты `PointsTtlWorker`, `PointsBurnWorker`, `EarnActivationWorker`; документированы фичефлаги и интервалы, примеры `.env` обновлены (локальный/infra).
- Тестовая инфраструктура: устранены «залипающие» open handles в Jest. Во всех воркерах таймеры `unref()`, таймауты очищаются; Prometheus default timers выключены в тестах (`METRICS_DEFAULTS=0`), e2e запускаются `--runInBand --detectOpenHandles`.
- Интеграции: Evotor — AJV‑валидация конфигурации, журнал `SyncLog` (IN ok/error), контроллер инкрементирует `pos_webhooks_total`. ModulKassa/Poster — `POST /register` с OAuthGuard, валидация и upsert `Integration`, вебхуки пишут `SyncLog`, стандартизированы лейблы метрик; добавлены e2e тесты (включая проверку `pos_webhooks_total`).

## Волна 1 — Завершена (2025-09-15)
- Идемпотентность денежных операций: `commit/refund` с `Idempotency-Key`, эмулированы повторы/гонки; стабильные e2e на коллизии `orderId` и повторные вызовы.
- Транзакционные инварианты: активное использование Prisma‑транзакций; тесты на баланс и атомарность `Wallet/Transaction/Hold` под конкуренцией — зелёные.
- Безопасность по умолчанию: Helmet, CORS из `CORS_ORIGINS`, rate‑limit (порог по умолчанию), централизованные фильтры ошибок и структурные логи.
- Воркеры/фичефлаги: `WORKERS_ENABLED`, TTL‑воркеры и earn‑активации — покрыты unit‑тестами; таймеры размечены `unref()` для чистоты тестов.
- Наблюдаемость: ключевые метрики (RPS/latency/errors, outbox) экспортируются на `/metrics`; алерты 5xx интегрированы; дефолтные пром‑метрики отключаются в тестах.
- ENV‑валидация: Ajv‑schema для API, fail‑fast при некорректных значениях; примеры `.env` обновлены.

— Следующий шаг: оформить PR (conventional commits) с DoD, финальный смоук: `docker compose -f infra/docker-compose.yml up -d` → `pnpm -C api test && pnpm -C api test:e2e`; затем приступить к Wave 2 (ядро лояльности: уровни/TTL/промо).

## Волна 2 — Прогресс (2025-09-15)

- Выполнено:
  - Levels: применяются бонусы уровня к `earnBps`/`redeemLimitBps` в `quote()` по `rulesJson.levelsCfg` + `levelBenefits`; добавлены unit/e2e тесты.
  - Admin: добавлены редакторы `levelsCfg`/`levelBenefits` и страница предпросмотра уровня клиента (`admin/src/app/levels/page.tsx`).
  - UI-качество: заменены внутренние `<a>` на `Link` в Admin и безопасная типизация `catch (unknown)`.
  - Тестовый ритуал: исправлен «зависон» после e2e — в `api/package.json` скрипт `test:e2e` дополнен `--forceExit`.
  - E2E комбо: Levels + Voucher + Promo — добавлены кейсы на EARN (59 баллов после ваучера/промо и бонуса уровня) и REDEEM (лимит 510) в `api/test/loyalty.e2e-spec.ts`.
  - TTL: усилены unit‑тесты `PointsBurnWorker` (явные проверки суммы сгорания/баланса/события), превью TTL (`PointsTtlWorker`) и активация лотов — зелёные.
  - Документация: `API_DOCUMENTATION.md` — разделы «Уровни и бонусы» и «TTL/Сгорание баллов» (флаги, события, настройки в админке).
  - Admin: добавлены проверки валидности JSON для `levelsCfg` и `levelBenefits` (кнопки «Проверить уровни/бонусы» на странице настроек).
  - Подключён `PromosModule` (prev. этап) и добавлены превью‑правила (категория, minEligible), e2e `promos.e2e-spec.ts` — зелёные.
  - Реализованы `Vouchers`: `preview`, `issue`, `redeem` в `api/src/vouchers/*`. В `redeem` — идемпотентность по `(voucherId, customerId, orderId)` и проверка лимитов/валидности.
  - Интеграция в денежный флоу: `loyalty.controller.quote()` сначала уменьшаем `eligibleTotal` ваучером → промо, затем считаем. В `commit()` при наличии `voucherCode` выполняется идемпотентный `redeem` по `orderId`.
  - Добавлены e2e в `api/test/loyalty.e2e-spec.ts`: применение ваучера в quote и идемпотентность `commit` с ваучером.
  - Дополнительные e2e: комбо ваучер+промо (REDEEM) влияет на лимит, проверка `redeemApplied` на `commit`, `redeem` идемпотентен при достижении `maxUses`, `issue` создаёт код и работает в `preview`.
  - Prisma: добавлен уникальный индекс `@@unique([voucherId, customerId, orderId])` для `VoucherUsage` (идемпотентность на уровне БД, миграция будет сгенерирована).
  - SDK TS: добавлены `vouchers.preview/issue/redeem/status/deactivate` и поддержка `voucherCode` в `quote/commit`.
  - README дополнен разделом «Vouchers» (эндпоинты, порядок применения скидок).
  - Все тесты зелёные: `pnpm -C api test && pnpm -C api test:e2e`.
  - Admin UI: добавлен раздел «Ваучеры» — список/поиск/выпуск/деактивация/экспорт (admin/app/vouchers), клиентские методы (admin/lib/vouchers.ts).
  - API: админские эндпоинты для ваучеров: `GET /vouchers/list`, `GET /vouchers/export.csv` (защищены AdminGuard/AdminIpGuard).
  - Admin (CRM): мини‑карточка уровня на странице клиентов, автозагрузка уровня, ссылка «Подробнее», бейдж уровня в транзакциях/чеках с tooltip «эффективные ставки» (base rules + level bonus).
  - Admin (Levels): автозагрузка по query `merchantId/customerId`, прогресс‑бар, расчёт «эффективных ставок» на странице уровней и в настройках мерчанта.
  - TTL e2e: полный флоу PENDING→ACTIVE→preview→burn (`ttl.flow.e2e-spec.ts`) и FIFO‑сгорание с проверкой `consumedPoints` (`ttl.fifo.e2e-spec.ts`).
  - Levels x TTL interplay: при metric=earn активация PENDING(120) поднимает уровень до Silver; quote на 1000 даёт 70 баллов (700 bps) — `levels.ttl.interplay.e2e-spec.ts`.
  - Метрики: e2e проверки /metrics после превью и burn (`metrics.workers.e2e-spec.ts`), gauge `loyalty_worker_last_tick_seconds`, счётчики burn.
  - Referrals: e2e‑заглушки контроллера с mock Prisma (`referral.e2e-spec.ts`); подключён `ReferralModule`, экспортирован `LoyaltyService` из `LoyaltyModule`.
  - Docs: `API_DOCUMENTATION.md` — добавлены примеры конфигов уровней и раздел «Порядок применения» (Voucher → Promo → Rules + Levels) с формулами и примерами.
  - Admin: единый поповер «эффективные ставки» (`admin/components/EffectiveRatesPopover.tsx`) подключён на страницах `customers` и `levels`.
  - E2E REDEEM: пер‑заказный cap — `redeem.order.cap.e2e-spec.ts` (учёт `receipt.redeemApplied`), дневной cap — `redeem.daily.cap.e2e-spec.ts` (rolling 24h) — оба зелёные.
  - Docs: `README.md` дополнен Quickstart «Levels + TTL». `API_DOCUMENTATION.md` — раздел «Referrals (beta/preview)» и примечания к REDEEM (per‑order cap и daily cap).
  - E2E EARN: дневной cap — `earn.daily.cap.e2e-spec.ts` — зелёный.
  - Referrals: позитивный флоу create→activate→complete — `referral.flow.e2e-spec.ts` — зелёный; API docs — добавлен `/referral/complete`.
  - Idempotency: конкурентные commit по одному `orderId` — `redeem.concurrent.order.commit.e2e-spec.ts` — второй commit идемпотентен.
  - Admin UX: поповер — закрытие по клику вне и по Esc, скелетон‑состояние загрузки.

 - Следующий шаг (Wave 2):
  - E2E: «ваучер+промо+уровень+commit → повторный quote (per‑order cap)», расширение TTL‑кейсов, нагрузочные sanity‑чек‑тесты.
  - Referrals: e2e без моков на dev‑БД (идемпотентность, самореферал), SDK методы и примеры.
  - Admin: типографика/отступы/тени поповера (унификация с дизайн‑системой), быстрые подсказки на списках.
  - Ритуал: держать `pnpm -C api test && pnpm -C api test:e2e` зелёным на каждом батче; фиксировать прогресс в `plan.md`.

## Волна 3 — Завершена (2025-09-15)

- Выполнено:
  - Заготовка уведомлений: `NotificationsService.broadcast/test` — постановка задач в Outbox (`eventType=notify.*`), метрика `notifications_enqueued_total`.
  - Подключён `NotificationsModule` в `AppModule` (используем существующие Email/Push/SMS контроллеры для дальнейшей интеграции).
  - Admin UI: добавлена страница `admin/app/notifications` с формой рассылки (канал, сегмент, шаблон), поддержкой `dry-run`, выводом оценки получателей, выпадающим списком сегментов (`getSegmentsAdmin`).
  - Worker: создан `NotificationDispatcherWorker` (обработка `notify.broadcast`/`notify.test`), исключены `notify.*` из `OutboxDispatcherWorker`. Метрики `notifications_processed_total` и liveness.
  - Worker: добавлены per‑channel метрики (`notifications_channel_attempts_total/sent_total/failed_total` с label `channel`) и запись аудита в `AdminAudit` для событий broadcast.
  - Worker: внедрён per‑merchant RPS‑троттлинг (`NOTIFY_RPS_DEFAULT`, `NOTIFY_RPS_BY_MERCHANT`), события при ограничении переносятся на +1s; покрыто unit‑тестом `notification-dispatcher.worker.spec.ts`.
  - README и `infra/env-examples/api.env.example`: добавлены раздел и переменные для SMTP/SMS/FCM и настроек воркера уведомлений.
  - Dry-run: `NotificationsService.broadcast()` возвращает `estimated` по сегменту или каналам (email/sms/push) на основе Prisma счётчиков и consent’ов.
  - Admin UI: i18n (RU/EN), a11y‑лейблы, skeleton‑лоадеры для сегментов; предпросмотр шаблонов с `{{var}}`.
  - Метрики: пер‑канальные метрики дополнены лейблом `merchantId` для разреза по мерчанту.
  - Тесты: добавлены unit‑тесты воркера на троттлинг и ветви ошибок/ретраев (`notification-dispatcher.worker.spec.ts`, `notification-dispatcher.errors.spec.ts`).

- Итог: функционал рассылок завершён — воркер уведомлений с метриками/аудитом, dry‑run и сегментами; Admin UI с предпросмотром/валидацией; документация и env‑пример обновлены; покрыто unit/e2e тестами; все тесты зелёные.

## Волна 4 — Старт (2025-09-15)

- Задачи:
  - Адаптеры интеграций: унифицировать интерфейсы (`POSAdapter`/`PaymentProvider`/`ERPAdapter`/`Shipper`), описать контракты.
  - Валидация конфигов интеграций (AJV): схемы для Evotor/ModulKassa/Poster, ошибки — fail‑fast.
  - Подписанные вебхуки провайдеров: проверка подписи, окно времени; логирование входа/выхода, ретраи.
  - Журнал `SyncLog`: IN/OUT события, статус/ошибка, payload, план ретраев.
  - Bridge: обновить README/пример `.env`, описать подпись `BRIDGE_SECRET`, офлайн‑очередь.
  - Тесты: unit для валидаторов/подписей, e2e флоу интеграций (моки провайдеров), метрики `pos_*`.

## Волна 4 — Прогресс (2025-09-15)

- Выполнено:
  - Evotor: валидация конфигов (AJV), `SyncLog` входящих вебхуков, метрики `pos_webhooks_total` и `pos_requests_total`/`pos_errors_total` в контроллере.
  - ModulKassa/Poster: реализованы `POST /register` (OAuthGuard) с валидацией и upsert `Integration`; вебхуки пишут `SyncLog`; стандартизированы лейблы провайдера в метриках; e2e на вебхуки и метрики.
  - E2E инфраструктура стабилизирована без open handles.
  - Централизация POS‑метрик: `pos_requests_total`/`pos_errors_total`/`pos_webhooks_total` перенесены в prom‑client (`MetricsService`), роутинг через `inc()` без дублей.
  - Негативные e2e: Evotor — неверная подпись вебхука → `SyncLog.status=error` и метрики; ModulKassa/Poster — `POST /register` с некорректным конфигом → 400 и `pos_requests_total{result="error"}`.
  - DRY: общий helper `upsertIntegration()` для регистрации интеграций, используется в ModulKassa/Poster.
  - Bridge: README дополнен (формат `X-Bridge-Signature`, заголовки, офлайн‑очередь/бэкенды, метрики/эндпоинты); `infra/env-examples/bridge.env.example` обновлён (переменные очереди).

- Следующие шаги:
  - Расширить общий helper для ERP/Shipper и перевести оставшиеся адаптеры.
  - Добавить Admin‑виджеты по POS‑метрикам (`pos_*`) и краткий раздел API Docs о верификации `X-Bridge-Signature` в `loyalty.controller`.
  - Покрыть негативные сценарии вебхуков прочих провайдеров (assert `pos_errors_total`, `SyncLog.status=error`).
