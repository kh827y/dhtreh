# Planning Mode — Long Run (2025-09-15)  
## Новая структура панелей (договорились)

- Админ‑панель (Owner Admin):
  - Мерчанты: список/создание/редактирование/удаление. При создании ОБЯЗАТЕЛЬНО ownerName; автоматически создаётся сотрудник‑владелец.
  - Настройки мерчанта (перенос): QR TTL, Требовать подпись Bridge, Требовать Staff‑ключ; логин кассира (slug) и пароль из 9 цифр (регенерация).
  - Интеграции и POS‑настройки, Telegram‑бот (токен), наблюдаемость (Metrics/Outbox/SyncLog).

- Мерчант‑панель (Merchant Portal):
  - Сотрудники: табы Работает/Уволен, фильтры (Роли/Точки/«Только с доступом в панель»), поиск, карточка сотрудника (доступы/связанные точки/пин‑коды/уволить/сменить пароль и т.п.).
  - Торговые точки (вместо устройств): список/создание/редактирование.
  - Программа лояльности: Механики, Акции, Промокоды (взамен Ваучеров), Push/Telegram‑рассылки, Мотивация персонала, Антифрод, Панель кассира (логин/пароль, таблица пинкодов сотрудников по точкам).
  - Клиенты и аудитории; Товары и категории; Отзывы; Аналитика (Сводный, По времени, Портрет, Повторы, Динамика, RFM, Активность точек/сотрудников, Рефералы, ДР, Автовозврат).

— Устройства: депрекация. UI/роуты удаляем, опираемся на Торговые точки.
  - [x] Бэкенд-агрегации/выгрузки перевёл на `outletId`: аналитика (Top Devices → Outlet usage c `posLastSeenAt`), воркер активации начислений, CRM-таймлайн, push-устройства (реестр по `outletId`), интеграционные DTO и CSV/SDK.
- [x] DTO/ответы merchants/loyalty и клиенты (admin/bridge/cashier) очищены от `deviceId`, добавлены поля POS-агрегации (`outletPosType`, `outletLastSeenAt`).
- [x] Staff DTO/SDK/doc: `allowedDeviceId` убран, публичные схемы и коллекции пересобраны под `allowedOutletId`/`outletId`.
- [x] OpenAPI/документация и e2e/контрактные тесты приведены к схеме без `deviceId`; зафиксированы outlet-секреты.
  - [x] LoyaltyController окончательно отказался от `deviceId`: подпись Bridge/hold кешируются только по `outletId`, публичные DTO и роуты очищены.
- [x] LoyaltyService: расчёт/commit/refund и outbox работают только с `outletId`, записи `deviceId` прекращены.
- [x] Guard'ы: троттлер, антифрод и кассир работают без `deviceId`, опираются на `outletId` и роли сотрудников.
- [x] AntiFraud конфиг: UI/сервис переименовали `af.device` → `af.outlet`, добавлена миграция по rulesJson.
- [x] Device-модель убрана окончательно: миграция добрала `bridgeSecret`/`lastSeen`, ограничение сотрудников переведено на точки, Prisma очищена от `deviceId`.

## Батчи внедрения (план)

## Хотфикс 2025-09-15 — Группы доступа (в работе)
- [x] Диагностировать `/portal/access-groups`: выяснил отсутствие дефолтных групп и отсутствие UX-обработки ошибок в портале.
- [x] Исправить сервис `MerchantPanelService`: автосоздание дефолтных групп, структурные логи/метрики, проверка сохранения участников.
- [x] Обновить фронт `/settings/access`: устойчивый фетч, обработка ошибок, синхронизация после CRUD.
- [ ] Покрыть тестами (юнит/интеграция) сценарии листинга/создания/назначения, чтобы зафиксировать регрессию.
- [ ] Задокументировать поведение (README/PAGES) и проверить `/metrics` после изменений.
- [x] Карточка сотрудника: подтянул реальные данные через `/portal/staff/:id`, починил загрузку точек/групп и совместимость с `React.use(params)`.
- [x] Портал: очистил разделы «Сотрудники»/«Торговые точки»/«Группы доступа» от моков, использую реальные группы при выдаче доступа и убрал системного владельца из списка.
- [x] Портал: при сохранении портальной роли сохраняю ранее назначенные группы доступа (не очищаю кассовые/аналитические права).
- [x] Механика «Ограничения в баллах»: подключил TTL, запрет одновременного начисления/списания и задержку использования к /portal/settings и обновил UI.
- [x] Telegram Mini App: подчистил UI (состояние кнопки, skeleton для блоков, скрытие данных после отключения — и на карточке интеграций тоже) и учёл предупреждение о webhook без падения подключения.
- [x] Реферальная программа: перенёс настройки на реальные данные (проксирование через портал, Prisma-миграция, расчёт вознаграждений в процентах/баллах), подключил аналитику и отдал в miniapp кнопку «Пригласить друга» с рабочими плейсхолдерами и вводом кода приглашения.
- [x] Реферальная программа: поправил типизацию под Prisma v6 (используем `ReferralProgram` из клиента и корректно формируем payload create/update), чтобы `tsc` не падал на сервисе.
- [x] PortalModule импортирует ReferralModule, чтобы `ReferralService` в портале резолвился без ошибок DI.
- [x] Коммуникации: Push/Telegram кампании перевёл на CommunicationTask (миграция данных, единый сервис/контроллеры, чистка тестов и прокси).
- [x] Push-реестр и антифрод очищены от `deviceId`: скоринг, уведомления и миграции опираются на `outletId`.
- [x] Проверил миграции `backfill_device_outlet`, `push_outlet_id`, `remove_device_table`, `referral_program_enhancements`: добавил проверки схемы и гарантировал совместимость со старыми/новыми базами.
- [x] Починил сборку после апдейта Prisma/Nest: удалил лишний декоратор, привёл типы JSON и переписал подсчёт уникальных участников акций через groupBy.

1) Бэкенд — мерчанты/владелец/CRUD (минимальная версия, обратная совместимость)
- Добавить в админ‑API: PUT/DELETE мерчанта; POST /merchants принимать ownerName и авто‑создавать сотрудника‑владельца (роль MERCHANT). До миграции — без новых полей, только `login`.
- Перенос настроек в админку: использовать существующие поля `MerchantSettings` (qrTtlSec, requireBridgeSig, requireStaffKey); портальную страницу настроек позже очистить.
- Прогнать тесты, починить до зелёного.

2) Prisma‑миграции (расширение моделей)
- Staff: firstName/lastName/position/phone/comment/avatarUrl, pinCode(4), canAccessPortal(bool), isOwner(bool).
- Merchant: cashierLogin(unique), cashierPassword9, archivedAt.
- AccessGroup/AccessGroupMember; StaffOutletAccess (staff↔outlet + pinCode, lastTxnAt).
- Методы Admin/Portal для управления пинкодами и доступами.
- LoyaltyPromotion: вынесена отдельная таблица `loyalty_promotions`, миграция и сиды обновлены.

3) Портал/Админ — фронтенд
- Удалить «Устройства», усилить «Торговые точки».
- Перенести UI настроек (QR TTL/BridgeSig/StaffKey) в админку; в портале убрать эти поля.
- ✅ Реализованы «Сотрудники» по ТЗ: табы «Работает»/«Уволен», фильтры (роли/точки/только с доступом), поиск, новая таблица с аватарами/иконкой владельца, карточка сотрудника (доступы, связанные точки, PIN‑коды, увольнение, смена пароля, просмотр транзакций), модалки создания/редактирования.
- ✅ Добавлен клиентский UI управления группами доступа (таблица RUD, модалка CRUD‑прав, локальное хранение и интеграция с формами сотрудников).
- ✅ Панель кассира: отображение логина и 9‑значного пароля, генерация и копирование, обязательный персональный PIN каждого сотрудника, обновлённый виртуальный терминал с двухшаговой авторизацией (slug+пароль → PIN) и выдачей staff key.
- ✅ REST/GraphQL слой портала: сотрудники, группы доступа, торговые точки и кассовые данные с валидацией DTO, пагинацией, счётчиками и массовыми операциями.
- ✅ Next.js-прокси и страницы портала синхронизированы с новым API: сотрудники, торговые точки, аналитика; в layout внедрён ACL по роли `portal/me`.
- ✅ Тестовый ритуал поправлен: `pnpm -C api test` и `test:e2e` автоматически вызывают `prisma generate`, поэтому юнит- и e2e-спеки выполняются в чистом окружении.
- ✅ Добавлены структурные логи и метрики для операций портала (списки сотрудников/групп, изменение статусов, ротация PIN) + unit-тест `listStaff`.
- ✅ Лояльность, аудитории и коммуникации переведены на структурные логи (`portal.loyalty.*`, `portal.customers.*`, `portal.communications.*`) и счётчики (`portal_loyalty_*`, `portal_audiences_*`, `portal_communications_*`) для наблюдаемости действий UI.
- ✅ Уровни лояльности: расчёт и парсинг вынесены в общий helper, переиспользуемый сервисами, обновлены юнит-тесты на бонусы уровней.
- ✅ Антифрод (ядро): velocity/факторы переключены на outletId, введены новые пороги, блок-факторы и unit-тесты (guard/service/throttler).

- ✅ Сделаны промокоды на баллы: новая страница с табами «Активные/Архивные», строкой «Показаны записи …», таблицей с колонками «Промокод/Описание/Баллы/Группа/Срок/Использован» и иконками RUD (в архиве — «Вернуть»), полнофункциональной модалкой создания/редактирования (период действия, начисление баллов, сгорание, уровень, лимиты, периодичность, визиты) и поддержкой восстановления промокода.
- ✅ Раздел «Акции»: tabs «Предстоящие/Активные/Прошедшие», карточки c участниками, мини‑графиками выручки, режимом «Акция не запущена», расширенная модалка создания (период, аудитория, выдача баллов, сгорание, PUSH‑уведомления, автозапуск).
- ✅ Раздел «Аудитории клиентов»: поиск, таблица всех метрик, модалка создания/редактирования с чекбоксами, мультиселектами, диапазонами, уровнями RFM, просмотр состава аудитории.
- ✅ Механика «Баллы за регистрацию»: UI подключен к `rulesJson.registration`, поддерживает настройки TTL и задержку начисления через реальные данные `/portal/settings`.
- ✅ Механика «Сгорание (TTL)»: напоминания читают/сохраняют `rulesJson.burnReminder`, отображают срок жизни и наличие Telegram-бота по данным мерчанта.
- ✅ Промокоды: портал работает с `PromoCode` (CRUD, лимиты, визиты, периоды), commit начисляет баллы/TTL и повышает уровни.
- ✅ Почистил e2e на промокоды: убраны ссылки на ваучеры, обновлены ожидания под реальные расчёты и закрыт тип по JSON-колонкам.

### Merchant Portal — Каталог и торговые точки (новое ТЗ)

#### Товары
- [x] Бэкенд: Prisma-модели товаров/категорий/стоков, эндпоинты портала для списка, карточки, создания, редактирования, массовых действий.
- Список:
  - Фильтры: **Категория** (дропдаун «Все категории»), **Статус** (дропдаун «Все товары»: «Отображаются в каталоге», «Не отображаются в каталоге»), **Правила баллов** (дропдаун: «С начислением баллов», «Без начисления баллов»), поиск по названию/артикулу.
  - Таблица: чекбокс, превью, **Название**, **Категория**, **Покупок за месяц**, **Покупок всего**, **Артикул**.
  - Пустое состояние: иллюстрация + кнопка **«Добавить товар»**.
  - Массовые действия после выбора: скрыть/показать в каталоге, разрешить/запретить оплату баллами, удалить (с подтверждением).
- Добавление товара (страница с табами): **Основное**, **Каталог и характеристики**, **Цены и остатки**.
  - «Основное»:
    - **Название товара** — обязательно.
    - **Артикул** — опционально (генерация бэком).
    - **Категория** — дропдаун.
    - **Правила для баллов**: тогглы **«Начислять баллы за товар»**, **«Разрешить платить баллами за товар»** (обе включены по умолчанию), поле **Какую часть товара можно оплатить баллами, %** (0…100, по умолчанию 100).
    - Кнопка **«Далее»** сохраняет черновик и переводит на следующий таб.
  - «Каталог и характеристики»:
    - **Порядок** (число, сортировка списков).
    - **Связанный товар в iiko (Delivery)** — селект, опционально.
    - Тоггл **«Этот товар имеет варианты»** — при включении открывается менеджер вариантов (названия/цены/артикулы/характеристики).
    - **Изображения товара** — галерея с drag&drop, рекомендация 1000×1000, поддержка смены порядка и удаления.
    - **Описание** — WYSIWYG.
    - Блок **Цена**: тоггл **«Цена»** (скрытие цены в карточке), поле **Цена, ₽** (обязательно, если цена включена), тоггл **«Запретить добавление в корзину»**.
    - **Габариты**: Вес (кг/г), Высота/Ширина/Глубина (см) — опционально.
    - **Пищевая ценность** (на 100 г/мл): Белки/Жиры/Углеводы (г), Калорийность (ккал) — опционально.
    - **Маркерные теги** (переключатели): Новинка, Популярный, Острое, Для вегетарианцев.
    - Тоггл **«Отображать товар в каталоге»** — включён по умолчанию.
    - Кнопки: **«Сохранить и опубликовать»**, **«Удалить товар»** (с подтверждением).
  - «Цены и остатки»: поля/таблица цен по складам/точкам (если применимо), остатки; сохранение без смены табов, валидации числовых значений.

#### Категории
- Список: колонки превью, **Название категории**, **Порядок** (кнопки ↑/↓ или drag&drop), кнопка **«Создать категорию»**.
- Создание категории:
  - **Название** — обязательно.
  - **Изображение** — одно, рекомендация 1200×1200 (1:1).
  - **Описание** — WYSIWYG.
  - **Адрес (slug)** — латиница/дефис, автогенерация из названия с возможностью правки, проверка уникальности.
  - **Родительская категория** — дропдаун для вложенности.
  - Кнопка **«Создать»**: успех → возврат в список и toast.

#### Торговые точки
- Список: табы **Работают**/**Не работают**, поиск по названию, карточки с **Названием** и адресом (город, улица, дом); клик → профиль точки; кнопка **«Добавить торговую точку»**.
- Создание торговой точки (**Торговые точки → Добавить торговую точку**):
  - Вкладка «Основное»: тоггл **«Работает»**, тоггл **«Скрыть торговую точку от клиентов»**, **Название**, **Описание**, **Контактный телефон**, **Адрес** с подсказками и опцией **«Поставить маркер вручную»**, **Почта администратора** (несколько через запятую). Кнопка **Создать/Сохранить**.
  - Вкладка «Режим работы»: **Часовой пояс**, тоггл **«Отображать расписание»**, график работы (вариант круглосуточно либо по дням с интервалами), кнопка **Сохранить**.
  - Вкладка «Интеграции»: **Внешний ID / BranchID / IDBranch** — обязательный идентификатор из кассы/POS, кнопка **Сохранить**.

4) Аналитика/Аудитории/Отзывы/Рассылки — расширение
- Добрать разделы аналитики по ТЗ, аудитории (CRUD/состав), отзывы (миниаппа + портал), Telegram‑уведомления.

5) Интеграции — паритет по GMB API и каталог API
- Сверка функционала с: gmb_api.pdf, gmb_catalog_api.pdf; доработать API.
- Интеграции по pdf (1C/r_keeper/iiko/Poster/Frontol/МойСклад/CommerceML): адаптеры/валидаторы/вебхуки.

Каждый батч → тестовый ритуал: `pnpm -C api test && pnpm -C api test:e2e`. Обновлять README/Docs и этот план.

Обновлённый рабочий план доведения проекта лояльности до стабильного и надёжного состояния с современным UI. План синхронизирован с Memories (dev/test ритуал, бэкенд гарантий, Prisma‑правила, фичефлаги/воркеры, интеграции/bridge, фронтенды, DoD).

## Волны работ

- Волна 0 — Префлайт (завершена)
  - Пересмотр плана.
  - Строгий TS/ESLint/Prettier, базовый `tsconfig.base.json`. Скрипты: `typecheck`, `lint`, `lint:fix`, `test`.
  - Глобальная защита API: Helmet, CORS из `CORS_ORIGINS`, Nest Throttler/Redis, JSON‑логирование (pino). Валидация ENV (fail‑fast).
  - Прогон тестов: `pnpm -C api test && pnpm -C api test:e2e`.

- Волна 1 — Устойчивость и надёжность бэкенда
  - Идемпотентность commit/refund через `Idempotency-Key`, ретраи безопасны.
  - Транзакционные границы в денежных сценариях; инварианты Wallet/Transaction/Hold покрыты тестами.
  - Фичефлаги: `EARN_LOTS_FEATURE`, `POINTS_TTL_FEATURE`, `POINTS_TTL_BURN`, переключатель `WORKERS_ENABLED` — тесты сценариев TTL/отложенных начислений.
  - Алерты на 5xx/аномалии; базовые метрики latency/RPS/errors.

- Волна 2 — Функции лояльности (ядро)
  - Уровни (CustomerLevel): правила перехода и выгоды.
  - TTL/сгорание баллов: безопасный расчёт; тесты.
  - Промокоды: выпуск/активация/ограничения; анти‑фрод капы.
  - Рефералка многоуровневая; защита от саморефералки/дубликатов.
  - Акции: buy‑N‑get‑1, спеццены, бонусные коэффициенты.
  - Подарки за баллы и «Подарок на ДР».

- Волна 3 — Коммуникации и CRM/аналитика
  - Email/push через адаптеры, сегментация; outbox + ретраи.
  - Отчёты LTV/ретеншен/ARPU, сегменты и выгрузки.

- Волна 4 — Интеграции и Bridge
  - Единый интерфейс адаптеров: POS/Payments/ERP/Shipper; dry‑run, валидация конфигов, подписанные webhooks.
  - Минимальные коннекторы (iiko/r_keeper/frontol/Evotor/1C/CommerceML/robokassa/ecommpay/DPD и др.) с записями `Integration`.
  - Встроить в Bridge; подпись `BRIDGE_SECRET`.

- Волна 5 — Фронтенды (Owner Admin / Merchant Portal / Cashier / Miniapp)
  - Современный UI: единая дизайн‑система, i18n, доступность, skeletons/загрузки.
  - Owner Admin (админ‑консоль): глобальные настройки и наблюдаемость системы (страница Metrics, воркеры, Outbox/вебхуки, POS‑метрики, интеграции), управление мерчантами и ролями; режим «Просмотр как мерчант» с правом редактирования.
  - Merchant Portal (личный кабинет бизнеса): аналитика и CRM, механики/акции, аудитории, промокоды, отзывы; настройки перенесены в админку.
  - Cashier: QR → quote → commit, возвраты, безопасные повторы. Авторизация кассира: login = slug от имени мерчанта, пароль = 9 цифр; у сотрудников — пинкод 4 цифры (по точкам).
  - Miniapp (Telegram): баланс/история/QR, промо/подарки/ДР, уведомления; рефералка через deep‑link t.me/<bot>?start=ref_<code> и активацию при первом визите мини‑аппы.

## Definition of Done (общие)
- Строгий TS, валидируемые ENV; глобальные фильтры ошибок и логирование; Helmet/CORS/rate‑limit включены.
- Все тесты зелёные: `pnpm -C api test && pnpm -C api test:e2e`.
- Миграции Prisma — атомарны; без потерь денежных данных; тесты на миграции и инварианты.
- Современный UI и понятные UX‑флоу на фронтендах.
- Документация обновлена: README/DEPLOYMENT_GUIDE/API_DOCUMENTATION; краткий итог в `plan.md`.

## Риски и блокеры
- Отсутствующая dev‑БД → поднять Docker Compose.
- Долгие агрегации аналитики → кеш Redis + индексы.
- Интеграции с внешними API → мок/фичефлаги, dry‑run.

## Выполнено недавно
- ✅ Торговые точки: вынесли POS-поля (`posType`, `posLastSeenAt`, `bridgeSecret*`) в `Outlet`, миграцией подтянули данные из `Device` и зафиксировали правила агрегации в README.
- ✅ Admin/Portal API: управление `bridgeSecret`/`bridgeSecretNext` и POS-статусами перенесено на `/merchants/:id/outlets/:outletId/*`, CLI Bridge и фронтовые клиенты используют `outletId`.
- ✅ Miniapp клиента: полностью обновлён UI под мобильные Telegram miniapp — карточка с QR/балансом/уровнем, прогресс до следующего уровня, история, промокоды и модальное увеличение QR; добавлена страница первичного онбординга и запрос телефона.
  - ✅ Merchant Portal: раздел «Торговые точки» подключён к реальному бэкенду — список точек загружается через прокси `/app/api/portal/outlets` → `GET /portal/outlets`, страница создания точки отправляет реальные данные (`POST /portal/outlets`) с расписанием; заглушки/демо‑сохранения удалены без изменения UI.
- ✅ Merchant Portal: реализованы разделы каталога (список товаров с фильтрами и массовыми действиями, создание товара с табами, список и создание категорий, список и мастер создания торговых точек) на мок-данных по новому ТЗ.
- ✅ API: добавлены модуль админки (мерчанты/настройки Bridge/QR/Staff), мерчант-панели (сотрудники/доступы/точки/кассовая панель), ядро лояльности (механики/акции/промокоды/журнал), CRM-аудитории и коммуникации на новой Prisma-схеме.
- ✅ Merchant Panel API: убраны дубли из PortalController, REST/GraphQL сервис сотрудников теперь сохраняет персональные и кассовые PIN, массовые операции и пароль, совместим со старыми роутами `/portal/staff/*` и `/portal/cashier`.

- ✅ Merchant Portal: журнал операций `/operations` переведён на реальные данные из БД без моков
  - Добавлены прокси-роуты Next: `app/api/operations/log/route.ts`, `app/api/operations/log/[receiptId]/route.ts` → бэкенд `GET /portal/operations/log` и `GET /portal/operations/log/:receiptId`.
  - Страница `app/operations/page.tsx`: удалены мок-данные; загрузка списка с сервера с фильтрами/пагинацией; отображение без изменения интерфейса.
  - Исправлены ошибки UI: вложенные `<button>` (вынесено в `div role="button"`, компонент `StarRating` рендерит `<button>` только в интерактивном режиме), TDZ для `inputStyle` (введён `inputFieldStyle`).
  - Карточка клиента: устранён сбой порядка хуков (перенос `useMemo(groups)` выше раннего `return`), доступ к параметрам через `useParams()`.

- Модернизация admin analytics: единый `TopBar`/`Card`/`Skeleton`, улучшенные графики (`SimpleLineChart` с tooltip/hover/линейкой).
- Инициализирован `merchant-portal` (Next.js) — базовый дашборд, подключение дизайн‑системы.
- Создан пакет `@loyalty/ui` (токены темы, базовые компоненты: Button/Card/Skeleton/Chart; иконки Lucide; анимации Framer Motion). Обновлён `pnpm-workspace.yaml`.
- Merchant Portal: реализована аутентификация по email+паролю (+ TOTP опц.), добавлена страница `/login`, middleware защиты, server routes `/api/session/*`.
- API: модуль `PortalAuth` (`POST /portal/auth/login`, `GET /portal/auth/me`), CORS для `authorization`, `PORTAL_JWT_SECRET` в ENV и `infra/env-examples/api.env.example`.
- Prisma: у `Merchant` добавлены `portalEmail` (unique), `portalPasswordHash`, а также `portalKeyHash/portalTotpSecret/portalTotpEnabled/portalLoginEnabled/portalLastLoginAt`; миграции применены.
- Admin: «Мерчанты» — список/создание (Name/Email/Password), включение/выключение входа, TOTP (init/verify/disable), «Открыть как мерчант» (имперсонация в портал).
- Merchant Portal: подключены данные — `Настройки` (GET/PUT), `Сотрудники` (список/создать), `Точки` (список/создать), `Устройства` (список/создать), `Клиенты` (поиск по телефону), `Операции` (транзакции/чеки); добавлены `Ваучеры` (список/выпуск/деактивация), `Рассылки` (dry-run/enqueue), `Интеграции` (список); аналитика подключена: `Дашборд`, `RFM`, `Портрет`, `Повторы`, `Время`, `ДР` (через портальные прокси `/portal/analytics/*`).
 - PortalAuth: добавлены e2e-тесты `login` (email+пароль), ветвь `TOTP`, `me` и админская имперсонация; внедрён jose-wrapper `getJose()` для стабильных тестов (используется в `PortalAuthController`, `PortalGuard`, `MerchantsService.signPortalJwt`); добавлен smoke‑тест портальной аналитики; обновлён `README` (раздел PortalAuth/имперсонация); все тесты зелёные.
- RBAC: переименована роль `MANAGER` → `MERCHANT` во фронтах/admin‑proxy и Prisma enum (миграция).
- Аналитика backend: заменены сырые SQL ($queryRaw) на Prisma в `getTopCustomers/getTopOutlets/getTopStaff/getDeviceUsage`.
- Включён строгий TS на уровне монорепо: обновлён `tsconfig.base.json` (`strict`, `noUncheckedIndexedAccess`).
- Настроены ESLint/Prettier во всех пакетах (`api`, `admin`, `cashier`, `miniapp`, `bridge`); добавлены корневые `.prettierrc`, `.prettierignore`, `.eslintignore`, `.editorconfig`.
- Корневой `package.json`: добавлены скрипты `format`/`format:check` и унифицированные `typecheck/lint`.
- API hardening: подтверждены Helmet/CORS/Throttler/Pino; добавлена schema‑валидация ENV через Ajv (fail‑fast в `api/src/main.ts`).
- Поднята dev‑БД (`docker compose -f infra/docker-compose.yml up -d`), применены миграции (`prisma migrate deploy`).
- Тестовый ритуал выполнен: `pnpm -C api test && pnpm -C api test:e2e` — зелёные.

- 5xx алерты: `AlertsService` интегрирован в `HttpMetricsInterceptor`, сэмплинг по `ALERTS_5XX_SAMPLE_RATE`; добавлены переменные для Telegram в `api/.env.example`.
- Идемпотентность commit: `merchantId` выводится из `hold`, кэшируемый ответ нормализован (устранён дрейф `alreadyCommitted`), повторные вызовы стабильно детерминированы.
- Антифрод: `dailyCap` переведён на скользящее 24‑часовое окно, чтобы избежать TZ/полуночных артефактов.
- E2E: добавлен тест идемпотентности `refund` (повтор по одному `Idempotency-Key`).
- Wave 1: углублённые e2e по идемпотентности и инвариантам — коллизии `orderId`, конкурентные `commit`, многошаговые частичные `refund` для `EARN/REDEEM`, идемпотентность `refund`.
- Воркеры/флаги: добавлены unit‑тесты `PointsTtlWorker`, `PointsBurnWorker`, `EarnActivationWorker`; документированы фичефлаги и интервалы, примеры `.env` обновлены (локальный/infra).
- Тестовая инфраструктура: устранены «залипающие» open handles в Jest. Во всех воркерах таймеры `unref()`, таймауты очищаются; Prometheus default timers выключены в тестах (`METRICS_DEFAULTS=0`), e2e запускаются `--runInBand --detectOpenHandles`.
- Интеграции: Evotor — AJV‑валидация конфигурации, журнал `SyncLog` (IN ok/error), контроллер инкрементирует `pos_webhooks_total`. ModulKassa/Poster — `POST /register` с OAuthGuard, валидация и upsert `Integration`, вебхуки пишут `SyncLog`, стандартизированы лейблы метрик; добавлены e2e тесты (включая проверку `pos_webhooks_total`).

## Волна 1 — Завершена (2025-09-15)
- Идемпотентность денежных операций: `commit/refund` с `Idempotency-Key`, эмулированы повторы/гонки; стабильные e2e на коллизии `orderId` и повторные вызовы.
- Транзакционные инварианты: активное использование Prisma‑транзакций; тесты на баланс и атомарность `Wallet/Transaction/Hold` под конкуренцией — зелёные.
- Безопасность по умолчанию: Helmet, CORS из `CORS_ORIGINS`, rate‑limit (порог по умолчанию), централизованные фильтры ошибок и структурные логи.
- Воркеры/фичефлаги: `WORKERS_ENABLED`, TTL‑воркеры и earn‑активации — покрыты unit‑тестами; таймеры размечены `unref()` для чистоты тестов.
- Наблюдаемость: ключевые метрики (RPS/latency/errors, outbox) экспортируются на `/metrics`; алерты 5xx интегрированы; дефолтные пром‑метрики отключаются в тестах.
- ENV‑валидация: Ajv‑schema для API, fail‑fast при некорректных значениях; примеры `.env` обновлены.

— Следующий шаг: оформить PR (conventional commits) с DoD, финальный смоук: `docker compose -f infra/docker-compose.yml up -d` → `pnpm -C api test && pnpm -C api test:e2e`; затем приступить к Wave 2 (ядро лояльности: уровни/TTL/промо).

## Волна 2 — Прогресс (2025-09-15)

- Выполнено:
  - Levels: применяются бонусы уровня к `earnBps`/`redeemLimitBps` в `quote()` по `rulesJson.levelsCfg` + `levelBenefits`; добавлены unit/e2e тесты.
  - Admin: добавлены редакторы `levelsCfg`/`levelBenefits` и страница предпросмотра уровня клиента (`admin/src/app/levels/page.tsx`).
  - UI-качество: заменены внутренние `<a>` на `Link` в Admin и безопасная типизация `catch (unknown)`.
  - Тестовый ритуал: исправлен «зависон» после e2e — в `api/package.json` скрипт `test:e2e` дополнен `--forceExit`.
  - E2E комбо: прежние сценарии Levels + промокод + Promo требуются заново после миграции на новый сервис.
  - TTL: усилены unit‑тесты `PointsBurnWorker` (явные проверки суммы сгорания/баланса/события), превью TTL (`PointsTtlWorker`) и активация лотов — зелёные.
  - Документация: `API_DOCUMENTATION.md` — разделы «Уровни и бонусы» и «TTL/Сгорание баллов» (флаги, события, настройки в админке).
  - Admin: добавлены проверки валидности JSON для `levelsCfg` и `levelBenefits` (кнопки «Проверить уровни/бонусы» на странице настроек).
  - Подключён `PromosModule` (prev. этап) и добавлены превью‑правила (категория, minEligible), e2e `promos.e2e-spec.ts` — зелёные.
  - Legacy ваучеры удалены: сервисы и контроллеры `vouchers/*` заменены на единый `PromoCodesService`, работающий с реальными таблицами `PromoCode`/`PromoCodeUsage`.
  - E2E: сценарии на legacy ваучеры (portal + loyalty) переписаны под `PromoCodesService`, старые проверки удалены как дублирующие.
  - Интеграция в денежный флоу: `loyalty.controller.quote|commit` принимает поле `promoCode`, использует `PromoCodesService.apply`, начисляет баллы, TTL и уровни в рамках транзакции.
  - Portal/merchant-portal: `GET/POST /portal/promocodes*`, прокси в `merchant-portal/app/api/portal/promocodes/*` и страница `/promocodes` обновлены под `promoCodeId` и статусы `ACTIVE/ARCHIVED`.
  - Cashier auth: публичные эндпоинты в `LoyaltyController` — `POST /loyalty/cashier/login` (merchantLogin+password9) и `POST /loyalty/cashier/staff-token` (по PIN и точке).
    - `CashierGuard`: whitelist для `/loyalty/cashier/*` и прочих публичных GET.
    - `LoyaltyModule`: импортирован `MerchantsModule` для DI.
    - Восстановлен `POST /loyalty/qr` в корректном месте.
  - Навигация портала: «Ваучеры» заменены на «Промокоды», ссылки «Устройства»/«Настройки» убраны из шапки.
-  - Merchant Portal: реализована боковая навигация (sidebar) по структуре из PAGES.md: Мастер настройки; Аналитика (все подпункты); Программа лояльности (механики/акции/акции с начислением/push/telegram/промокоды/мотивация/антифрод/панель кассира); Отзывы; Клиенты и аудитории; Товары и категории; Карта Wallet; Настройки; Инструменты. Созданы страницы‑скелеты по каждому разделу. Корневая страница теперь «Мастер настройки».
  - Панель кассира (портал): backend эндпойнты `GET /portal/cashier` и `POST /portal/cashier/rotate`, прокси в `merchant-portal` и страница `/loyalty/cashier` с показом логина/статуса пароля, ротацией (отображение нового 9‑значного пароля, кнопка «Скопировать»), таблицей пин‑кодов сотрудников по точкам (обновление PIN/отозвать доступ).
  - Ритуал тестов после правок: `pnpm -C api test && pnpm -C api test:e2e` — все зелёные.
  - Merchant Portal: «Акции» — список с фильтрами статуса (`/loyalty/actions`, прокси `/api/portal/campaigns`), детальная страница `/loyalty/actions/[id]` (прокси `/api/portal/campaigns/[id]`, backend `GET /portal/campaigns/:campaignId`).
  - Merchant Portal: «Акции с начислением» — отдельный список кампаний с наградой POINTS/PERCENT (`/loyalty/actions-earn`).
  - Merchant Portal: «Механики» — добавлена сводка параметров программы из `/portal/settings` (earnBps/redeemLimitBps/TTL/задержка/QR TTL/требования Staff‑Key/Bridge).
  - Merchant Portal: добавлены страницы механик и сохранение в `rulesJson`:
    - «Ограничения списания» (`/loyalty/mechanics/redeem-limits`) — TTL баллов, запрет одновременного списания/начисления, задержка активации.
    - «Автовозврат клиентов» (`/loyalty/mechanics/auto-return`) — конфиг `rulesJson.autoReturn` (enabled/days/text/giftPoints/giftTtlDays/repeat).
    - Автовозврат клиентов — подключены реальные настройки и статистика (правка `rulesJson.autoReturn`, аналитика `/portal/analytics/auto-return`, перенаправление из аналитики на таб «Статистика», удалён устаревший `/analytics/auto-return`).
    - «ДР‑поздравления» (`/loyalty/mechanics/birthday`) — конфиг `rulesJson.birthday` (enabled/daysBefore/daysAfter/text/giftPoints/giftTtlDays).
    - ДР‑поздравления: добавлены реальные настройки и статистика — прокси `/api/portal/loyalty/birthday`, аналитика `/portal/analytics/birthday-mechanic`, UI таб «Статистика», редирект со старой страницы `/analytics/birthdays`.
    - «Бонус за регистрацию» (`/loyalty/mechanics/registration-bonus`) — конфиг `rulesJson.registration` (enabled/points/ttlDays/text).
    - «Сгорание (TTL)» (`/loyalty/mechanics/ttl`) — управление `pointsTtlDays` и `rulesJson.burnReminder` (enabled/daysBefore/text).
  - Merchant Portal: `auto-return` сохранение рефакторено — отправляется минимальный DTO (`earnBps`, `redeemLimitBps`, `rulesJson`) вместо полного объекта настроек.
  - Требуется обновить e2e под новый `PromoCodesService` (earn/commit/idempotency) — старые сценарии на ваучеры удалены.
  - Prisma: legacy таблицы `Voucher*` удалены — остались только `PromoCode*`, внешних интеграций/отчётов на них не осталось.
  - Seeds/fixtures: генераторов записей ваучеров не осталось — чистка не требуется.
  - SDK TS: поле запроса переименовано в `promoCode`, удалён клиент `vouchers.*`.
  - README и документация обновлены под промокоды портала вместо ваучеров.
  - Все тесты зелёные: `pnpm -C api test && pnpm -C api test:e2e`.
  - Merchant Portal — Клиенты: подключено бэкенд‑взаимодействие без изменения UI. Страница `/customers` и карточка клиента используют прокси `app/api/customers/*` к `http://localhost:3004/customers` (CRUD). Создание/редактирование, а также модалки «Начислить»/«Списать» сохраняют данные в БД. Добавлен пример ENV `infra/env-examples/merchant-portal.env.example` с `CUSTOMERS_API_BASE`.
  - Admin UI: legacy раздел «Ваучеры» удалён, вместо него основной фокус — порталские промокоды.
  - API: legacy эндпоинты `/vouchers/*` вычищены.
  - Admin (CRM): мини‑карточка уровня на странице клиентов, автозагрузка уровня, ссылка «Подробнее», бейдж уровня в транзакциях/чеках с tooltip «эффективные ставки» (base rules + level bonus).
  - Admin (Levels): автозагрузка по query `merchantId/customerId`, прогресс‑бар, расчёт «эффективных ставок» на странице уровней и в настройках мерчанта.
  - TTL e2e: полный флоу PENDING→ACTIVE→preview→burn (`ttl.flow.e2e-spec.ts`) и FIFO‑сгорание с проверкой `consumedPoints` (`ttl.fifo.e2e-spec.ts`).
  - Levels x TTL interplay: при metric=earn активация PENDING(120) поднимает уровень до Silver; quote на 1000 даёт 70 баллов (700 bps) — `levels.ttl.interplay.e2e-spec.ts`.
  - Метрики: e2e проверки /metrics после превью и burn (`metrics.workers.e2e-spec.ts`), gauge `loyalty_worker_last_tick_seconds`, счётчики burn.
  - Referrals: e2e‑заглушки контроллера с mock Prisma (`referral.e2e-spec.ts`); подключён `ReferralModule`, экспортирован `LoyaltyService` из `LoyaltyModule`.
  - Docs: `API_DOCUMENTATION.md` — добавлены примеры конфигов уровней и раздел «Порядок применения» (Promo → Rules + Levels) с формулами и примерами; подчёркнуто, что поддерживаются только промокоды.
  - Admin: единый поповер «эффективные ставки» (`admin/components/EffectiveRatesPopover.tsx`) подключён на страницах `customers` и `levels`.
  - E2E REDEEM: пер‑заказный cap — `redeem.order.cap.e2e-spec.ts` (учёт `receipt.redeemApplied`), дневной cap — `redeem.daily.cap.e2e-spec.ts` (rolling 24h) — оба зелёные.
  - Docs: `README.md` дополнен Quickstart «Levels + TTL». `API_DOCUMENTATION.md` — раздел «Referrals (beta/preview)» и примечания к REDEEM (per‑order cap и daily cap).
  - E2E EARN: дневной cap — `earn.daily.cap.e2e-spec.ts` — зелёный.
  - Referrals: позитивный флоу create→activate→complete — `referral.flow.e2e-spec.ts` — зелёный; API docs — добавлен `/referral/complete`.
  - Idempotency: конкурентные commit по одному `orderId` — `redeem.concurrent.order.commit.e2e-spec.ts` — второй commit идемпотентен.
  - Admin UX: поповер — закрытие по клику вне и по Esc, скелетон‑состояние загрузки.

 - Следующий шаг (Wave 2):
  - E2E: «промокод+уровень+commit → повторный quote (per‑order cap)», расширение TTL‑кейсов, нагрузочные sanity‑чек‑тесты.
  - Referrals: e2e без моков на dev‑БД (идемпотентность, самореферал), SDK методы и примеры.
  - Admin: типографика/отступы/тени поповера (унификация с дизайн‑системой), быстрые подсказки на списках.
  - Ритуал: держать `pnpm -C api test && pnpm -C api test:e2e` зелёным на каждом батче; фиксировать прогресс в `plan.md`.

— Следующий шаг (Wave 2, текущая сессия):
  - Cashier UI: реализовать экран кассира (login 9‑значный пароль мерчанта → ввод PIN сотрудника по точке) и привязку к `X-Staff-Key`.
  - Promocodes (points): расширить обработку в `LoyaltyService.commit()` для начислений по промокоду (POINTS) — idempotent по `orderId`, структурные логи/метрики; e2e.
    - [x] Централизовать бизнес-логику промокодов в `PromoCodesService`, перевести портал/loyalty-контроллеры и метрики на единый слой.
  - E2E: добавить кейс earn по промокоду POINTS (issue → quote/commit с promoCode → проверка баланса/транзакций).

## Волна 3 — Завершена (2025-09-15)

- Выполнено:
  - Заготовка уведомлений: `NotificationsService.broadcast/test` — постановка задач в Outbox (`eventType=notify.*`), метрика `notifications_enqueued_total`.
  - Подключён `NotificationsModule` в `AppModule` (используем существующие Email/Push контроллеры для дальнейшей интеграции).
  - Admin UI: добавлена страница `admin/app/notifications` с формой рассылки (канал, сегмент, шаблон), поддержкой `dry-run`, выводом оценки получателей, выпадающим списком сегментов (`getSegmentsAdmin`).
  - Worker: создан `NotificationDispatcherWorker` (обработка `notify.broadcast`/`notify.test`), исключены `notify.*` из `OutboxDispatcherWorker`. Метрики `notifications_processed_total` и liveness.
  - Worker: добавлены per‑channel метрики (`notifications_channel_attempts_total/sent_total/failed_total` с label `channel`) и запись аудита в `AdminAudit` для событий broadcast.
  - Worker: внедрён per‑merchant RPS‑троттлинг (`NOTIFY_RPS_DEFAULT`, `NOTIFY_RPS_BY_MERCHANT`), события при ограничении переносятся на +1s; покрыто unit‑тестом `notification-dispatcher.worker.spec.ts`.
  - README и `infra/env-examples/api.env.example`: добавлены раздел и переменные для SMTP/FCM и настроек воркера уведомлений.
  - Dry-run: `NotificationsService.broadcast()` возвращает `estimated` по сегменту или каналам (email/push) на основе Prisma счётчиков и consent’ов.
  - Admin UI: i18n (RU/EN), a11y‑лейблы, skeleton‑лоадеры для сегментов; предпросмотр шаблонов с `{{var}}`.
  - Метрики: пер‑канальные метрики дополнены лейблом `merchantId` для разреза по мерчанту.
  - Тесты: добавлены unit‑тесты воркера на троттлинг и ветви ошибок/ретраев (`notification-dispatcher.worker.spec.ts`, `notification-dispatcher.errors.spec.ts`).

- Итог: функционал рассылок завершён — воркер уведомлений с метриками/аудитом, dry‑run и сегментами; Admin UI с предпросмотром/валидацией; документация и env‑пример обновлены; покрыто unit/e2e тестами; все тесты зелёные.

## Волна 4 — Старт (2025-09-15)

- Задачи:
  - Адаптеры интеграций: унифицировать интерфейсы (`POSAdapter`/`PaymentProvider`/`ERPAdapter`/`Shipper`), описать контракты.
  - Валидация конфигов интеграций (AJV): схемы для Evotor/ModulKassa/Poster, ошибки — fail‑fast.
  - Подписанные вебхуки провайдеров: проверка подписи, окно времени; логирование входа/выхода, ретраи.
  - Журнал `SyncLog`: IN/OUT события, статус/ошибка, payload, план ретраев.
  - Bridge: обновить README/пример `.env`, описать подпись `BRIDGE_SECRET`, офлайн‑очередь.
  - Тесты: unit для валидаторов/подписей, e2e флоу интеграций (моки провайдеров), метрики `pos_*`.

## Волна 4 — Прогресс (2025-09-15)

- Выполнено:
- Evotor: валидация конфигов (AJV), `SyncLog` входящих вебхуков, метрики `pos_webhooks_total` и `pos_requests_total`/`pos_errors_total` в контроллере.
- ModulKassa/Poster: реализованы `POST /register` (OAuthGuard) с валидацией и upsert `Integration`; вебхуки пишут `SyncLog`; стандартизированы лейблы провайдера в метриках; e2e на вебхуки и метрики.
- E2E инфраструктура стабилизирована без open handles.
- Централизация POS‑метрик: `pos_requests_total`/`pos_errors_total`/`pos_webhooks_total` перенесены в prom‑client (`MetricsService`), роутинг через `inc()` без дублей.
- Негативные e2e: Evotor — неверная подпись вебхука → `SyncLog.status=error` и метрики; ModulKassa/Poster — `POST /register` с некорректным конфигом → 400 и `pos_requests_total{result="error"}`.
- DRY: общий helper `upsertIntegration()` для регистрации интеграций, используется в ModulKassa/Poster.
- Bridge: README дополнен (формат `X-Bridge-Signature`, заголовки, офлайн‑очередь/бэкенды, метрики/эндпоинты); `infra/env-examples/bridge.env.example` обновлён (переменные очереди).
- Merchant Portal: реализована карточка и страница подключения Telegram Mini App с реальными API (регистрация, проверка и отключение бота, обновление статусов интеграций); добавил модалку ввода токена и обновление настроек без заглушек.
- API: привёл сервис Telegram Mini App к корректной работе с JSON-полями Prisma и устранил ошибки типизации TypeScript.
- Backoffice data: добрал миграцию по бэкфиллу `outletId` из `deviceId`, добавил проверки остатков и обновил сиды/фикстуры под новую схему.

- Следующие шаги:
  - Расширить общий helper для ERP/Shipper и перевести оставшиеся адаптеры.
  - Добавить Admin‑виджеты по POS‑метрикам (`pos_*`) и краткий раздел API Docs о верификации `X-Bridge-Signature` в `loyalty.controller`.
  - Покрыть негативные сценарии вебхуков прочих провайдеров (assert `pos_errors_total`, `SyncLog.status=error`).
  - Настроить CI для загрузки Prisma engines в офлайновых средах (экспорт `PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING`).

## Волна 4 — Аналитика (в работе 2025-09-15)

- [x] Сверстать «Сводный отчёт» и «Распределение по времени» по ТЗ: фильтры периода, карточки, графики, подписи.
- [x] Обновить «Портрет клиента», «Повторные продажи» и «Динамика»: фильтры/тумблеры, графики, метрики.
- [x] Реализовать требования для «RFM-анализ», «Активность торговых точек», «Активность сотрудников», «Реферальная программа» (таблицы, модалки, кнопки).
- [x] Реферальная аналитика: фильтры периодов используют реальные временные диапазоны (`/portal/analytics/referral`), данные топа и метрик подгружаются с API без заглушек.
- [x] Пройтись по документации (README/PAGES) и зафиксировать изменения.

## Волна 4 — Механики (в работе 2025-09-15)

- [x] Вынес применение/экспорт/уведомления кампаний в `LoyaltyPromotionService` и добавил миграцию данных из `campaigns` в `loyalty_promotions`.
- [x] Обновил README/API/docs под `LoyaltyPromotion`, добрал e2e (экспорт/применение/уведомления) и фронтовые тесты на новый формат.
- [x] Портал и фронтенд `merchant-portal` переведены на новую сущность `LoyaltyPromotion` через прокси `/portal/loyalty/promotions` (backend контроллеры + Next API).
- [x] Удалён legacy-модуль `Campaign`: Prisma-модель и миграции очищены, сервисы/отчёты/аналитика переведены на `LoyaltyPromotion` и `PromotionParticipant`.
- [ ] Обновить страницу перечня механик: карточки с иконками/описаниями, тумблеры по ТЗ.
- [ ] Реализовать UI «Уровни клиентов»: список, создание, редактирование, детальная с корректировками и составом.
- [ ] Сверстать страницы настроек: «Ограничения в баллах», «Автовозврат», «Поздравить с днём рождения», «Баллы за регистрацию», «Напоминание о сгорании», «Реферальная программа».
- [x] Реферальная программа: форма настроек в портале подключена к `/portal/settings`, поддерживает многоуровневые награды, реальные значения бонусов и текст приглашения.
- [x] Обновлён раздел «Акции»: вкладки Предстоящие/Текущие/Прошедшие, поиск и таблица с меню действий, мастер создания в два шага.
- [x] Добавлен «Журнал начисления баллов»: фильтры, список операций с пагинацией и модальное окно просмотра операции.
- [x] Push-рассылки: вкладки активных/архивных кампаний, таблица и модальное окно создания с ограничением 300 символов и выбором аудитории.
- [x] Telegram-рассылки: пустое состояние, таблица архивов, расширенная модалка с лимитом 512 символов, загрузкой изображения и валидациями.
- [x] Мотивация персонала: настройки начислений и отображения рейтинга, предпросмотр панели кассира, сохранение только при изменениях.
- [x] Навигация портала: сворачиваемые группы разделов и ссылка на «Журнал начисления баллов» в блоке «Программа лояльности».
- [x] Бэкенд портала: API для push/telegram-рассылок, мотивации персонала, списка акций и журнала операций с фильтрами и деталями.
- [x] Раздел «Защита от мошенничества»: форма лимитов с уведомлениями, контакты получателей, сохранение настроек.
- [x] Клиенты: обновлён список с фильтрами, модалкой создания/редактирования и импортом CSV; карточка клиента с историей, отзывами и модалками операций; страница комплиментарных баллов.
- [x] Loyalty API: quote/commit/refund переключены на outletId (канал по Outlet.posType, outbox/транзакции/hold наполняются outletId, подписи берут секреты из Outlet → MerchantSettings, кеш правил и тесты обновлены).
- [x] Push-рассылки: вкладки активных/архивных кампаний, таблица и модальное окно создания с ограничением 300 символов и выбором аудитории.
- [x] Telegram-рассылки: пустое состояние, таблица архивов, расширенная модалка с лимитом 512 символов, загрузкой изображения и валидациями.
- [x] Мотивация персонала: настройки начислений и отображения рейтинга, предпросмотр панели кассира, сохранение только при изменениях.
- [x] Навигация портала: сворачиваемые группы разделов и ссылка на «Журнал начисления баллов» в блоке «Программа лояльности».
