# Planning Mode — Long Run (2025-09-15)

## Хотфикс 2025-12-XX — Удаление платежей и кассовых интеграций
- [x] API: удалён модуль платежей (YooKassa/CloudPayments/Тинькофф), вебхуки/рефанды, связанные эндпоинты подписок и события outbox.
- [x] API: вычищены интеграции касс (АТОЛ/Эвотор/Poster/МодульКасса/1С) и вспомогательные схемы/валидации.
- [x] Prisma: убрана модель Payment и поля lastPayment* в Subscription, cron-процессы переведены на истечение по дате без автоплатежей.
- [x] Документация: ENV/README/API docs обновлены с пометкой об отключении платежных провайдеров и кассовых вебхуков, примеры .env очищены.

## Хотфикс 2025-12-XX — Подписка Full
- [x] Тарифная сетка сведена к одному плану `plan_full` без лимитов; выдача/сброс подписки вручную через админку и админ‑API на заданное число дней.
- [x] Жёсткое применение подписки: PortalGuard и SubscriptionGuard блокируют портал/кассу/API после истечения, предупреждение за 7 дней и карточка тарифа в портале, оверлей блокировки при просрочке.
- [x] Админка мерчантов: карточка текущего тарифа, ручной грант Full на N дней и сброс подписки, отображение срока действия.

## Хотфикс 2025-12-XX — Admin cleanup
- [x] Admin: удалены legacy-страницы онбординга, notifications, transactions и тест правил, а также фронтовый клиент подписок/платежей и устаревший `admin/lib/notifications.ts`.
- [x] Admin: навигация и главная страница приведены к целевому набору разделов (мерчанты, outbox, TTL, антифрод, статус API, документация, экспорт, подпись).
- [x] Admin: аутентификация упрощена до одной роли ADMIN (пароль + опциональный TOTP), manager/merchant-пароль убран.
- [x] Admin: клиент к API использует только реальный `NEXT_PUBLIC_API_KEY` без `test-key`, примеры prod-окружения обновлены (.env.production.example, infra/env-examples/admin.env.example).
- [x] Admin docs: обновлены страницы деплоя и наблюдаемости под актуальные ENV/метрики (ADMIN_UI_PASSWORD, NEXT_PUBLIC_API_KEY/NEXT_PUBLIC_API_BASE, loyalty_errors_total, loyalty_request_duration_seconds_bucket и др.).
 - [x] Admin: страницы `/admin/settings`, `/admin/merchants` и `/admin/antifraud` приведены к новой модели лимитов и брендинга (базовые BPS и JWT для QUOTE, убраны daily caps/staff-key/Bridge-тумблеры, read-only anti-fraud отчёты, блок брендинга miniapp с цветами/логотипом и ссылкой на настройки мерчанта).

## Хотфикс 2025-12-XX — Admin обзор и мерчанты
- [x] Главная админки: системный обзор из `/observability/summary` (Outbox/5xx/Breaker/Rate limited, версия, инциденты, проблемные воркеры) и быстрые ссылки на Outbox/TTL/observability/health/audit/export.
- [x] Виджет мерчантов на главной: счётчики активных/истекающих/истёкших, отключённого логина, последние созданные мерчанты с подсветкой подписки.
- [x] Список мерчантов: поиск по id/названию/email, фильтры по статусу подписки, счётчики и явный refresh, подсказка об обращении только к реальному API.
- [x] README admin обновлён под реальные разделы и ENV (API_BASE/ADMIN_KEY/ADMIN_SESSION_SECRET/NEXT_PUBLIC_API_KEY/METRICS_TOKEN) без упоминаний моков.
- [x] Убран «мерчант по умолчанию»: никаких автоподстановок M-1 в UI/ENV; метрики главной только агрегированные, страницы Outbox/TTL/Antifraud/Settings требуют явного выбора мерчанта с сохранением локально.

## Хотфикс 2025-12-XX — Устройства и антифрод
- [x] Вернули модель `Device`, добавили `deviceId` в Hold/Receipt/Transaction/Ledger/EarnLot, антифрод считает лимиты по устройствам и точкам (ENV `AF_*_DEVICE/AF_*_OUTLET` + `rulesJson.af`).
- [x] Портал точек: управление устройствами (до 50 идентификаторов) вместо внешнего ID, API возвращает devices, журналы операций/отзывы показывают код устройства, операции/рефералы/рефанды сохраняют `deviceId`.
- [x] Журнал операций портала: реальные фильтры по сотрудникам/статусу/устройствам/точкам, вывод «Сотрудник»/«Устройство» по факту исполнителя, промокоды видны в «Все операции».
- [x] CashierGuard: убрано требование staff-key и обязательной bridge-подписи для кассы (валидация подписи только при переданном заголовке), сохраняем проверки сессии/teleauth.

## Хотфикс 2025-12-XX — Акции с начислением баллов (очистка)
- [x] Удалены legacy product/bonus экраны и API `/portal/actions`, в портале осталась заглушка `/loyalty/actions` с переходом в «Акции с начислением баллов».
- [x] Promotions API принимает только POINTS-акции с положительным вознаграждением, списки/статусы/миниаппа отфильтровывают остальные типы.
- [x] Аудитория «Все клиенты» считает MerchantCustomer и обновляется через refresh/ensureDefault; totalCustomers в аналитике строится по тем же данным.
- [x] Из админки убран раздел документации по акциям.
- [x] Портал `/loyalty/actions-earn`: карточки и табы строятся по реальным статусам акций, аудитория «Все клиенты» подтягивается из системного сегмента (`includeSystem=1`) с корректными размерами, шаровые графики считают чистую выручку (покупки со списанием акционных баллов минус сами баллы). Формы создания/редактирования валидируют даты, сгорание и пуши, отправляют реальные payload в `/portal/loyalty/promotions`.
- [x] Claim акций: если у POINTS-акции включено сгорание, но TTL не задан, срок истечения вычисляется от `endAt` промо (баллы сгорают после окончания акции, при активном статусе).
- [x] Miniapp: акции с аудиторией «Все клиенты» доступны без членства в сегменте (разрешены системный сегмент all-customers и правила kind=all), чтобы промо сразу были видны всем клиентам мерчанта.
- [x] Получение промо: при claim акции сегмента «Все клиенты» не требуют записи `segmentCustomer`, допускаются системный сегмент `all-customers` и правила `kind=all` в audience.
- [x] Метрики акций: график выручки строится по чекам участников с `redeemApplied>0` после вступления в акцию (сумма `total - redeemApplied` по дням), данные прокидываются в promotions list/get. Если клиент участвовал в нескольких акциях, redeem распределяется по акциям в порядке их активации, пока не «съедены» выданные баллы предыдущей акции.
- [x] Портал `/loyalty/actions-earn`: карточки акций с начислением баллов и блок графика сделаны компактнее и без лишних подзаголовков; клики и hover по графику больше не открывают окно редактирования, значения оси выручки полностью помещаются в блок без обрезания.

## Хотфикс 2025-12-XX — Чистка уровней (tiers)
- [x] Убраны legacy `levelsCfg/levelBenefits` (admin) из расчётов: уровни считаются только по `LoyaltyTier` портала, окно 365 дней по сумме чеков.
- [x] Автоповышение и эндпоинт `/levels` используют одни и те же tiers (скрытые исключены), при отсутствии tiers создаётся базовый `Base`.
- [x] Портал промокодов читает список уровней из `/portal/loyalty/tiers`, доки обновлены под новую схему.
- [x] Прогресс уровня учитывает возвраты/отмены: полные возвраты помечают чек отменённым, частичные вычитаются пропорцией `share` из `TxnType.REFUND`; при падении прогресса выполняется авто‑понижение tier.

## Хотфикс 2025-12-XX — Промокоды (miniapp + портал)
- [x] Убраны legacy эндпоинты `/portal/loyalty/promocodes*` и дубль CRUD в `PromoCodesService`, остался единый портал `/promocodes`.
- [x] Портал `/promocodes`: добавлен лимит «N клиентам» через `usageLimitValue`, убрана кнопка «Одно использование одному клиенту», сохранены поля TTL, визит и уровень.
- [x] README/API_DOCUMENTATION обновлены под актуальный интерфейс, списки «Активные/Архивные» опираются на реальные статусы и лимиты.
- [x] Скрытые уровни (isHidden) тоже доступны в списке уровней для промокодов, помечены как «(скрытый)».
- [x] Присвоение уровня промокодом уважает текущий уровень (запрет на понижение), поддерживает срок действия уровня (`levelExpireDays`, по истечении — автоподбор уровня по сумме покупок).
- [x] Миниаппа показывает чистое сообщение об ошибке активации промокода без префикса «Не удалось активировать».
- [x] Портал промокодов: редактирование сохраняет лимиты/срок уровня; «Одно использование каждому клиенту» ставит per-customer, «Одно использование N клиентам» хранит общий лимит и не скрывает поле ввода на значении 1.
- [x] Промокоды: повторное создание разрешено, если старый код в архиве; автоархив истёкших при загрузке списка; при активации проверяются конфликты по коду и отдаются точные сообщения об ошибках без лишнего текста.
- [x] Переименование/создание с занятым кодом: портал спрашивает подтверждение «перезаписать?», бэкенд поддерживает overwrite; при активации из архива не проверяется активный дубль.
- [x] Сообщение о дубликате упрощено до «Промокод с таким названием уже существует, перезаписать?» для механизма overwrite.

## Хотфикс 2025-12-XX — История операций при совместном списании/начислении
- [x] Карточка клиента: при `allowSameReceipt` покупки показываются одной строкой с начислением/списанием рядом, возвраты по таким чекам не дублируются.
- [x] Miniapp: возвраты с совместным начислением схлопнуты в одну запись с разными суммами, сохранены раздельные исходные начисление/списание и жёлтое оформление промокодов.
- [x] Журнал и карта клиента подсвечивают промокодные начисления отдельным видом, транзакции промокода получают явный source.
- [x] allowSameReceipt считается включённым по явному разрешению или при отсутствии запрета `disallowEarnRedeemSameReceipt`, чтобы объединение срабатывало после тумблера мерчанта.

## Хотфикс 2025-12-XX — Отображение возвратов в клиентах и журнале
- [x] Карточка клиента: записи возврата администратором не затемняются, исходные операции остаются серыми.
- [x] Карточка клиента: возвраты с кассы подсвечивают исходные операции меткой «Возврат: …», сами записи возврата показывают номер/дату в формате отмены.
- [x] Журнал операций: отменённые и возвращённые исходные операции затемняются, записи о возврате остаются без затемнения.
- [x] Журнал операций: одинаковый цвет статуса для отмены/возврата, убран фильтр и поле «Носитель», отметка «Возврат оформлен» не теряется при фильтре «Покупка».

## Хотфикс 2025-12-XX — Название мерчанта в портале
- [x] Дать мерчанту менять название компании в системных настройках портала и сохранять новое имя в API без потери связности.
- [x] Сохранять исходное админское имя, показывать его в админке с пометкой о переименовании, обновить документацию и UI.

## Хотфикс 2025-11-17 — Сводный отчёт аналитики
- [x] Пересобрать backend /portal/analytics/dashboard под новый набор метрик без возвратов/отмен
- [x] Обновить UI страницы /analytics: быстрые/произвольные периоды, карточки, график с отдельными осями
- [x] Покрыть расчёты и интерфейс тестами, обновить документацию

## Анализ 2025-11-13 — Miniapp ревью
- [x] Оценены избыточные части front миниаппы и зафиксированы замечания для чистки интерфейса и состояния.

## Хотфикс 2025-11-13 — Miniapp приглашения (share)
- [x] Кнопка «Отправить сообщение» в шторке «Пригласить друга» открывает Telegram-share (openTelegramLink) с `https://t.me/share/url` вместо прямого перехода по реферальной ссылке.
- [x] Текст для отправки берётся из поля мерчант-портала «Текст сообщения при нажатии «Отправить сообщение»», плейсхолдеры `{businessname}/{bonusamount}/{code}/{link}` подставляются перед отправкой, данные приходят с API.
- [x] Telegram-share отправляет только текст из портала (без автодобавления `url` параметра), ссылка попадает в сообщение только через плейсхолдер `{link}`.
- [x] PAGES.md уточнён: у блока настройки сообщений теперь два отдельных текстовых поля с единым списком плейсхолдеров.

## Хотфикс 2025-11-14 — Levels base + miniapp
- [x] Миниаппа: не присваиваем новый уровень автоматом, если не достигнут порог, берём фактическое назначение `LoyaltyTier`, скрытые уровни исключены из прогресса и кэшбэк читается из `earnRateBps`.
- [x] Автосоздание уровня «Base» (3 % начисления, 50 % списания, `minPaymentAmount=0`, стартовая и видимая группа) при любом обращении к API уровней/калькуляции.
- [x] Страница `/loyalty/mechanics/levels`: добавлена кнопка «Состав» с модалкой клиентов уровня, переходом в карточку и синхронным счётчиком «Клиентов в группе».
- [x] Скрытые группы не появляются в каталоге miniapp, не получают авто-переходы, держатся руками или промокодом; `quote/commit` учитывают только видимые уровни.
- [x] Документация (README, API_DOCUMENTATION) обновлена: описаны автогенерация Base, ограничения скрытых уровней и эндпоинт `GET /portal/loyalty/tiers/:tierId/customers`.
- [x] Модалки создания/редактирования клиентов в портале: убраны поля пароля/фамилии и чекбоксы блокировки, поле «Группа» заменено на реальный список уровней из `/portal/loyalty/tiers` с сохранением `levelId`.
- [x] Карточка клиента: добавлена кнопка «Заблокировать клиента» (режимы «Только начисления» или «Начисления и списания»), бекенд хранит `redemptionsBlocked`, ручные начисления/списания уважают блокировки и отображаются в истории.

## Хотфикс 2025-11-25 — Miniapp realtime events
- [x] Диагностировать отсутствие событий в `/loyalty/events/poll`, описать причину в реализации.
- [x] Добавить продакшн-совместимый источник событий (middleware/outbox) и долговисящий поллер, чтобы транзакции сразу подсвечивали историю/баланс/уровни.
- [x] Обновить документацию (README/API_DOCUMENTATION) и убедиться, что миниаппа получает события без перезагрузки.

## Хотфикс 2025-11-26 — Miniapp feedback
- [x] Финализировать условия показа шторки отзывов: только начисления/списания по покупкам.
- [x] Обновить подписку FeedbackManager на realtime-события, чтобы шторка открывалась сразу после покупки и игнорировала прочие операции.
- [x] Задокументировать или описать в коде допущения (transactionType, orderId) и проверить, что повторное открытие не происходит для уже оценённых чеков.

## Хотфикс 2025-11-27 — Miniapp feedback overlay
- [x] Обеспечить, чтобы шторка отзывов рисовалась поверх всех окон (включая QR), подняв z-index бекдропа/шторки и синхронизировав стили.

## Хотфикс 2025-11-28 — Miniapp регистрация по мерчанту
- [x] Бэкенд: хранить статус профиля/телефона в `MerchantCustomer`, не подтягивать данные из других мерчантов при teleauth и `GET /loyalty/profile`, добавить миграцию и бэкап существующих значений.
- [x] Miniapp: RegistrationGate/форма «Расскажите о себе» должны учитывать и профиль, и привязку номера, без локальных шорткатов; незавершённая регистрация не попадает на главный экран.
- [x] Обновить документацию (`API_DOCUMENTATION.md`, README/plan) и прогнать проверки после изменений.

## Хотфикс 2025-11-29 — Miniapp привязка номера
- [x] Перевели кнопку «Поделиться номером» в режим ожидания Telegram (текст «Ожидаем подтверждения…») и запускаем авто-проверку `profilePhoneStatus` сразу после подтверждения WebApp API, без ручного шага «Готово».
- [x] Очистили дублирующиеся уведомления: при отмене показываем одно инфо-сообщение, при успешной передаче номера пользователь мгновенно попадает на главный экран.
- [x] Вернули подсказку под кнопкой («Вы не привязали номер, попробуйте еще раз») вместо всплывающего уведомления, чтобы пользователь сразу видел, что запрос номера был отменён.
- [x] Убраны всплывающие сообщения «Не удалось распознать номер» и «Пригласительный код применен», чтобы интерфейс не отвлекал от основного шага онбординга.
- [x] Поле «Имя» теперь не подставляет ник Telegram — данные вводятся вручную или берутся из сохранённого профиля.
- [x] Счётчик «Акции» всегда на месте: вместо задержки и pop-анимации показан красный переливающийся скелет до загрузки данных.
- [x] После привязки номера убрали тост «Профиль сохранён», чтобы экран не дублировал уведомления об авто-сохранении.

## Рефактор 2025-11-13 — Miniapp onboarding
- [x] Переписать клиентскую инициализацию: явные статусы `useMiniappAuth`, отображение RegistrationGate без пустых экранов.
- [x] Вынести поканальный рендер (форма/дашборд) и добавить skeleton-состояния при отсутствии локального кеша.
- [x] Централизовать обновление данных (bootstrap + refresh), синхронно обновлять баланс/уровень/историю после действий.
- [x] Реализовать особую логику бейджа акций (анимация и показ только после ответа сервера).

## Релиз 2025-11-14 — Miniapp события баллов
- [x] Бэкенд: добавлен poll-эндпоинт `/loyalty/events/poll` и сервис `LoyaltyEventsService`, транзакции автоматически производят realtime-события.
- [x] Фронтенд: `subscribeToLoyaltyEvents` теперь открывает долговисящий запрос, транслирует события через BroadcastChannel/localStorage и триггерит обновление истории/баланса.
- [x] Отзывы показываются по реальным событиям транзакций, без ожидания опроса истории.
## Хотфикс 2025-11-23 — Miniapp: выравнивание QR и статусов
- [x] Вписать `FakeQr` в выделенный блок карточки без излишнего масштабирования.
- [x] Удалить сервисные сообщения под историей операций.
- [x] Снять анимацию показа QR-модалки и описать изменение здесь (проверено `pnpm -C miniapp lint`).

## Хотфикс 2025-11-12 — Miniapp: скрытие дашборда до статуса онбординга
- [x] Прятать главный экран, пока `teleOnboarded` не определён и нет локального флага онбординга, чтобы незарегистрированные пользователи сразу видели форму регистрации без промежуточного дашборда.

## Хотфикс 2025-11-21 — Miniapp: мгновенная инициализация
- [x] Убрать видимый «пустой» экран на старте: поднимать `merchantCustomerId` и снапшот синхронно до сетевых запросов, чтобы главный экран сразу наполнялся кешом.
- [x] Полностью удалить спиннеры/скелеты/appear-анимации из миниаппы, оставив один постоянный экран с мгновенным обновлением данных.
- [x] Обновить документацию/план (при необходимости) и проверить, что после фоновых запросов значения просто обновляются без промежуточных состояний.
- [x] Перевести страницу миниаппы в полностью клиентский рендер (без SSR), чтобы кешированные данные из `localStorage` появлялись в ту же секунду.

## Хотфикс 2025-11-20 — Miniapp: ускорение загрузки
- [x] Проанализирована текущая инициализация (`useMiniappAuth` → `teleauth` → `bootstrap`) и точка блокировки, сформулированы рекомендации по кешу и постепенной отрисовке.
- [x] Реализован cache-first снапшот (`bootstrap`/`balance`/`levels`/`transactions`/`promotions`/`referral`) в `localStorage`, данные обновляются при любом изменении и сразу восстанавливаются при входе.
- [x] Убран общий `screenLoading`, секции миниаппы рендерятся независимо, добавлены inline‑skeleton’ы только при отсутствии кеша и отдельный спиннер-счётчик для акций, `FakeQr` стал статичной SVG.
- [x] `merchantCustomerId` и профиль Telegram подхватываются из локального кеша до завершения `teleauth`, что позволяет мгновенно показать последнюю сессию и параллельно тянуть живой API.

## Хотфикс 2025-11-06 — Мотивация персонала (Portal + Cashier)
- [x] API: записи мотивации, начисление/списание при покупках и возвратах, лидерборд кассира с периодами (неделя/месяц/квартал/год/кастом).
- [x] Merchant Portal: страница `/loyalty/staff-motivation` с реальным API, дефолты 30/10, период «Год».
- [x] Cashier: реальный рейтинг сотрудников, отображение очков за выбранный период, рабочий фильтр по филиалу, подсказка с настройками мерчанта.
- [x] Документация и быстрая проверка.

## Хотфикс 2025-11-09 — Cashier: история и возвраты
- [x] История чеков и возвратов отображается только в рамках мерчанта сотрудника.
- [x] Возвраты по номерам чеков работают на актуальном API, legacy-логика удалена.
- [x] `merchantCustomerId` определяется автоматически по мерчанту сотрудника.
- [x] Карточка клиента показывает имя и уровень без поля «ID клиента».
- [x] Карточка «Сотрудник / Торговая точка» скрыта на этапе создания транзакции.
- [x] В заголовках убран ID мерчанта и добавлено динамическое название разделов.

## Хотфикс 2025-11-12 — Portal: аналитика по времени
- [x] Убраны мок-данные на `/analytics/time`, фронт использует живой API.
- [x] Добавлены эндпоинты `analytics/time/recency` и `analytics/time/activity`, исключающие отменённые и возвратные операции.
- [x] Портал: новые графики, переключатели группировок и периодов, слайдер диапазона и подсказки тепловой карты.
- [x] Обновлены `API_DOCUMENTATION.md` и текущий план.

## Хотфикс 2025-11-13 — Portal: портрет клиента
- [x] Метрики портрета (`Средний чек`, `Количество продаж`, `Сумма продаж`) пересчитываются в `AnalyticsService.getCustomerPortrait` по суммам чеков (`Receipt.total`) с учётом фильтра по аудиториям.
- [x] Барчарт по полу объединён: все три показателя отображаются совместно с отдельными Y-осями и скрытыми подписями.
- [x] Тултипы графиков «Возраст» и «Зависимость пола и возраста» показывают значение оси X; подписи оси X для зависимости выводят варианты `М-…` и `Ж-…`.
- [x] Обновлены `API_DOCUMENTATION.md` и страница `/analytics/portrait` в мерчант-портале.

## Хотфикс 2025-11-14 — Portal: повторные продажи
- [x] Страница `/analytics/repeat` использует реальные периоды (`week`, `month`, `quarter`, `year`) и подгружает список торговых точек через `/portal/outlets`, без моковых селектов.
- [x] Гистограмма «Покупок на покупателя» показывает долю клиентов (в %) по числу покупок, карточки метрик и график получают данные только из живого API.
- [x] Чекбокс «Не показывать значения меньше … процентов» с полем по умолчанию `3` заменил прежний тумблер; входные данные скрывают столбцы, где доля клиентов ≤ порога, без подсказки `?`.

## Хотфикс 2025-11-16 — Portal: аналитика динамики
- [x] API: вернуть реальные ряды начислений, списаний, сгораний и баланса с поддержкой группировок по дню/неделе/месяцу и периода/кастомного диапазона.
- [x] Merchant Portal: доработать `/analytics/dynamics` — живые данные, график среднего чека, переключатели периодов («Вчера», «Неделя», «Месяц», «Квартал», «Год»), детализация баллов, кастомный диапазон.
- [x] Документация: обновить `API_DOCUMENTATION.md` и README/подразделы при необходимости.

## Хотфикс 2025-11-17 — Portal: реферальная аналитика
- [x] API `/portal/analytics/referral`: счётчик регистраций строится по `Referral.activatedAt`, первые покупки — по `completedAt`, выручка — суммой чеков (`Receipt.total`) новых клиентов за выбранный период, топ пригласивших формируется по числу активаций и исключает отменённые чеки.
- [x] Merchant Portal `/analytics/referrals`: вместо селекта периодов добавлены пресеты «Вчера/Неделя/Месяц/Квартал/Год», поле произвольного периода и карточки с пояснениями, данные всегда подтягиваются с API без промежуточных заглушек.
- [x] Документация и план: описан эндпоинт в `API_DOCUMENTATION.md`, зафиксированы изменения в текущем плане.

## Хотфикс 2025-11-17 — Portal: часовые пояса
- [x] PortalGuard и аналитика получают настроенный часовой пояс мерчанта, период расчётов синхронизирован для всех отчётов.
- [x] `/settings/system` содержит только выбор часового пояса России относительно МСК, дефолт Барнаул (МСК+4).
- [x] Вся аналитика и журнал операций отображают даты и графики по выбранному часовому поясу (UI и API), новые эндпоинты `/portal/settings/timezone`.

## Хотфикс 2025-11-18 — Portal: динамика без возвратов
- [x] API `/portal/analytics/revenue` и `/portal/analytics/loyalty` исключают чеки и транзакции с REFUND или `canceledAt`, поэтому средний чек и график баллов не учитывают админские отмены и возвраты.
- [x] Страница `/analytics/dynamics` в мерчант‑портале проверена на новых данных: график «Средний чек» отрисовывается, баллы не содержат операций из отменённых чеков.
- [x] Обновлены `API_DOCUMENTATION.md` и текущий план с описанием правил фильтрации возвратов/отмен.
- [x] Исправлена разбивка бакетов по часовым поясам: месячная, недельная и дневная детализация больше не «перескакивает» даты, поэтому график «Средний чек» получает реальные точки.
- [x] `computePeriod` в PortalController нормализует даты через UTC-методы, поэтому в API перестали появляться смещения границ периода и расчёт среднего чека учитывает только выбранный диапазон.

## Хотфикс 2025-11-18 — Portal: RFM группы и аудитории
- [x] API: добавить `/portal/analytics/rfm` с реальным распределением клиентов по RFM, автоподбором порогов Frequency/Money и настройками из `MerchantSettings.rulesJson`.
- [x] Merchant Portal `/analytics/rfm`: загрузка данных из API, показ реальных диапазонов групп, сохранение настроек без изменения интерфейса, пояснения к полям.
- [x] Аудитории: фильтры по RFM-группам (R/F/M 1–5) в UI и `CustomerAudiencesService`, прокинуть в API создания/редактирования.
- [x] Документация: обновить `API_DOCUMENTATION.md`, README (раздел аналитики) и план.
- [x] Перенумеровать RFM-баллы: `1` — самые активные клиенты, `5` — потерянные (включая агрегации, таблицы и heatmap API).

## Хотфикс 2025-11-19 — Portal: активность точек/сотрудников
- [x] API `GET /portal/analytics/operations`: поддержать `from/to`, считать показатели по всем точкам и сотрудникам (выручка по чекам, количество чеков, средний чек, начисленные/списанные баллы, покупатели, новые клиенты, KPI персонала), подтягивать рейтинг кассира и среднюю оценку по реальным отзывам за период.
- [x] Merchant Portal: `/analytics/outlets` и `/analytics/staff` используют реальные данные, поле произвольного периода (дефолт 30 дней), раздельные колонки «Очки» и «Оценки работы» (среднее по пятибалльной шкале + ⭐️), удалён столбец «Выдано подарков за штампы», таблица точек охватывает все торговые точки мерчанта и выводит сноску «ИТОГО».
- [x] Документация: обновить `API_DOCUMENTATION.md` (параметры/ответы `analytics/operations`) и README, зафиксировать изменения в плане.
- [x] Колонки «Новые клиенты» в аналитике точек и сотрудников считают только тех покупателей, у кого первая покупка по чеку произошла в выбранном периоде (на уровне SQL выделяем первый чек клиента и фильтруем по диапазону).

## Хотфикс 2025-11-20 — Portal: чистые данные аналитики
- [x] Повторные продажи (`/analytics/repeat`) считают уникальных/повторных покупателей по чекам, игнорируя отменённые операции и все заказы с активными `REFUND` транзакциями из кассы.
- [x] Портрет клиента (`/analytics/portrait`) фильтрует чеки с возвратами и админскими отменами, чтобы метрики по полу/возрасту отображали только действительные продажи.
- [x] Раздел «По часам» учитывает те же фильтры (часы, дни недели, теплокарта), поэтому возвраты кассира и отмены администратора не попадают в распределения.
- [x] RFM-анализ перестал складывать новых клиентов в группу `unknown`: при отсутствии сохранённых R/F/M-оценок баллы пересчитываются на лету по визитам/спенду/давности и сегментация остаётся стабильной.

## Хотфикс 2025-11-21 — Portal: возвраты в реферальной/временной аналитике
- [x] Реферальная аналитика (`/analytics/referrals`) считает выручку только по валидным продажам (без отмен и чеков с `REFUND` из кассира); топ пригласивших и карточки клиентов теперь синхронизированы с очищенными данными.
- [x] Карточка «Новые покупатели» на странице повторных продаж исключает клиентов, у которых первая покупка была отменена или полностью возвращена.
- [x] Распределение «Время с последней покупки», аудитории и карточка клиента используют `CustomerStats`, пересчитанные по чекам без отмен/возвратов; recency в UI соответствует реальным активным покупкам.
- [x] Портальные агрегаты (месячные траты, общее число визитов) и списки приглашённых клиентов фильтруют чеки с возвратами через единый SQL-хелпер.

## Хотфикс 2025-11-22 — Portal/Miniapp: реферальные возвраты
- [x] Карточка «Совершили первую покупку» в реферальной аналитике считает только валидные первые чеки (без отмен и кассовых возвратов); если первая попытка была отменена, учитывается ближайшая успешно оплаченная покупка.
- [x] В настройках реферальной программы добавлена опция «Минимальная сумма заказа для награды» (дефолт 0), портал и API учитывают её при расчёте бонусов.
- [x] Возврат/отмена чека, за который начислялась реферальная награда (включая многоуровневые схемы), автоматически списывает баллы пригласителя и создаёт транзакцию «Возврат реферала» с `source=REFERRAL_ROLLBACK`.
- [x] При триггере «За первую покупку» откат выполняется только если не осталось других валидных покупок выше порога; при триггере «За все покупки» откатываем каждую возвратную операцию.
- [x] Журнал операций портала, карточка клиента и миниаппа распознают `REFERRAL_ROLLBACK` и выводят отдельный заголовок; план и API документация обновлены.
- [x] После отката награды связка `referral` возвращается в статус `ACTIVATED`, чтобы награда могла быть выдана повторно при следующей валидной покупке.

## Хотфикс 2025-11-24 — Portal: финальные возвраты
- [x] API `/portal/operations/log/{id}/cancel` отклоняет повторные отмены `TxnType.REFUND`, а `getDetails` больше не маркирует такие операции как доступные для отмены (`canCancel=false`).
- [x] Merchant Portal (журнал операций и карточка клиента) прячет кнопку отмены для возвратов и показывает пользователю, что «Возврат нельзя отменить».
- [x] Обновлены `API_DOCUMENTATION.md` и текущий план с описанием запрета на отмену возвратных транзакций.

## Хотфикс 2025-11-24 — Device / Outlet / Staff
- [x] Merchant Portal `/operations`: вместо поля «Сотрудник» в строках и деталях журнала показывается идентификатор устройства из `carrier.code` (без типов PC_POS/SMART), торговая точка остаётся отдельной колонкой.
- [x] Merchant Portal `/reviews`: колонка «Устройство / сотрудник» в первую строку выводит идентификатор устройства (`deviceId` из backend), а ниже — имя сотрудника, торговая точка остаётся отдельным столбцом.
- [x] API PortalReviewsService расширен полем `deviceId` (берётся из `Outlet.code` / `Outlet.externalId` / `Outlet.id`), OperationsLog по‑прежнему использует `carrier.code`; в UI типы устройств не отображаются.
- [x] Антифрод и документация: конфигурация `rulesJson.af` и ENV‑лимиты описаны через scope `outlet` (лимит по торговой точке, включающей все устройства и сотрудников), staff‑key и Bridge‑подпись задокументированы как опциональные/legacy настройки без управления из админ‑UI.

## Хотфикс 2025-10-25 — Cashier: мобильный интерфейс
- [x] Переработать экран авторизации и главную страницу кассира под мобильные устройства.
- [x] Добавить пошаговый сценарий сканирования QR, ввода суммы, списания и подтверждения с анимированным чеком.
- [x] Обновить разделы «История», «Рейтинг», «Возвраты» в новом стиле с навигацией снизу.
- [x] Адаптировать модалку сканера и блоки действий, блокируя кнопки на время сетевых запросов.
## Хотфикс 2025-10-29 — Portal: ночной пересчёт аудиторий клиентов
- [x] Реализовать метод `recalculateSegmentMembership` в `CustomerAudiencesService`, чтобы ночной воркер успешно пересчитывал составы сегментов.
- [x] Прогнать сборку `api` и убедиться, что TypeScript-ошибки по аудиториям исчезли.
- [x] Подключить реальные фильтры аудиторий (пол, возраст, регистрации, покупки, устройства) и синхронизировать UI портала.

## Хотфикс 2025-10-30 — Portal: метрики аудиторий и карточка клиента
- [x] Подключить к списку аудиторий расчётные метрики сегмента (чек, покупки, сумма, давность) из `metricsSnapshot` с запасом по структуре ответа.
- [x] Уточнить карточку клиента: показывать «Дней с последней покупки», корректную частоту визитов и общее количество покупок по данным API.
- [x] Исправить фильтр сегментов по «дням с последней покупки» и показать частоту визитов как «≈N дн.».
 - [x] Исключить отменённые/нулевые чеки из агрегаторов (`customerStats`, агрегаты портала) для коррекции `lastOrderAt` и расчёта состава аудиторий по давности покупок.

## Хотфикс 2025-11-02 — Portal: Telegram-оповещения и антифрод
- [x] Реализовать хранение и API для персональных Telegram-настроек (инвайты со `staffId`, привязка подписчиков, `staffNotify` в `rulesJson`).
- [x] Подключить отправку Telegram-уведомлений сотрудникам: новые заказы, отзывы, сводка и антифрод с фильтрацией по настройкам.
- [x] Обновить «Уведомления в Telegram» (загрузка/сохранение настроек, переключатель «Оповещения о подозрительных действиях», ссылка на «Защита от мошенничества»).
- [x] Переработать «Защита от мошенничества»: убрать контактные поля, подключить реальные лимиты (день/месяц/кап) к API с дефолтами 5/40/3000.
- [x] Синхронизировать документацию (README/API_DOCUMENTATION) и провести ручную проверку страниц.

## Хотфикс 2025-10-31 — Cashier: сессии авторизации
- [x] Провести аудит текущего потока авторизации кассира и определить требования к долгим сессиям.
- [x] Реализовать на backend хранение сессий кассира, уникальность PIN и удаление устаревшего `X-Staff-Key`.
- [x] Обновить фронтенд кассира: авторизация через куки, "Сохранить PIN", автоматический выбор точки/сотрудника.
- [x] Обновить README/API документацию по новой авторизации кассира.
- [ ] Прогнать smoke-проверки терминала (логин, quote, commit, refund).

## Хотфикс 2025-10-21 — Cashier: стили не подключались
- [x] Активный layout `cashier/app/layout.tsx` делегирует в `src/app/layout.tsx`, чтобы подключились `globals.css` (Tailwind v4) и шрифты.
- [x] `handlePointsSubmit`: сводка подтверждения строится из актуальной котировки (`updated`/`effectiveQuote`) и локального значения списания, а не из устаревших `result`/`selectedPoints`.
- [x] `handleConfirm`: если API вернул `finalPayable`, используем его; иначе — запасной расчёт от суммы и списания.

## Хотфикс 2025-10-30 — Cashier: очистка виртуального терминала
- [x] Удалить ввод промокода из кассира, включая UI, состояние и параметры запросов.
- [x] Убрать учёт категорий товаров при начислениях/списаниях в кассире и синхронизировать типы/клиентов API.
- [x] Переработать идентификаторы операций: отказаться от публичных `orderId`, добавить необязательный номер чека, применяемый в истории и refund.

## Хотфикс 2025-10-19 — Portal: аудитории и карточка клиента
- [x] Перед пересчётом сегмента обновлять `customerStats` по фактическим чекам (визиты, сумма, средний чек, последняя покупка).
- [x] Нормализовать карточку клиента: считать дни и частоту визитов по транзакциям, показывать частоту числом без текстовых ярлыков.

## Хотфикс 2025-10-25 — Merchant Portal: аудитории и фильтры
- [x] Удалить обращения к несуществующему состоянию вкладок в модалке аудиторий портала.
- [x] Исправить сборку фильтров статистики в `CustomerAudiencesService`, чтобы исключить спред не-объектов и восстановить сборку.
- [ ] Прогнать smoke-проверки сегментов клиентов после выката.
- [x] Переработать пересчёт состава: при создании/редактировании сегмента и изменении клиента аудитории обновляются сразу.
- [x] Вынести просмотр состава аудитории в таблицу (отдельная кнопка с модалкой участников).

## Хотфикс 2025-10-28 — Portal: компактные строки журнала операций
- [x] Сверстать обновлённые строки журнала: дата/время, торговая точка, клиент/сотрудник, рейтинг, статусы, суммы.
- [x] Настроить вывод пагинации на 10 записей за страницу и скорректировать запросы.
- [x] Проверить поведение (hover, ссылки, тексты); документация не требует обновления.
- [x] Для непокупочных операций показывать основание вместо суммы покупки.
- [x] Убрать подпись «Основание операции», оставив только текст основания.
- [x] Возвратам тоже показывать основание вместо суммы покупки.

## Хотфикс 2025-10-27 — Miniapp: отменённые операции
- [x] Обновить `/loyalty/transactions`: вернуть `canceledAt` и исходную дату покупки для возвратов.
- [x] Обновить miniapp-историю: скрыть отменённые операции (кроме покупок) и расширить заголовок возвратов.
- [x] Синхронизировать типы/документацию и проверить изменения.
## Хотфикс 2025-10-26 — Portal: стабильный порядок хуков в карточке клиента
- [x] Разобраться с предупреждением React о смене порядка хуков `CustomerCardPage`.
- [x] Привести компонент к стабильному порядку хуков и перепроверить перезагрузку данных.
- [x] Пробовать `pnpm --filter merchant-portal lint` (упало: ESLint 9 не находит `eslint.config.*` в проекте).
- [x] Переименовать кнопку «Создать» в модалке комплиментарных баллов на «Начислить».
- [x] Убрать обязательный выбор торговой точки при начислении комплиментарных баллов.
- [x] Починить импорт `portalFetch` в API-роуте начисления комплиментарных баллов (`Module not found: ../../../../../portal/_lib`).

## Хотфикс 2025-10-24 — Portal: ручные операции и отмены
- [x] Реализовать отмену чеков в портале: backend (маркировка квитанций, возврат баллов, новые DTO) + фронт (кнопка отмены, подтверждение, подсветка в журнале, текст «Операция отменена администратором»).
- [x] Пересчитать выдачу деталей операций: расписать категории (покупки, акции, промокоды, рефералка, возвраты, сгорание, регистрация, ДР, автовозврат, комплимент) и прокинуть комментарии комплиментарных начислений.
- [x] Привести модалки начисления/списания/комплимента к рабочему API: убрать поля #клиента/#устройства, подтягивать автокалькуляцию по уровню, хранить комментарий комплимента, заменить страницу модалкой.
- [x] В таблице срока действия показывать только начисления со сроком сгорания.
- [x] В форме клиента оставить обязательным только телефон (email/пароль необязательны) и синхронизировать валидацию/сохранение.
- [x] Обновить подписи операций: комплиментарные начисления → «Начислено администратором», отмены с текстами «Операция отменена: …» и «Операция #N (дата, время) отменена».
- [x] Модалки начисления/списания: подгрузка реальных торговых точек, удаление поля комментария при списании, актуализация API-документации.
- [x] Miniapp история баллов: ручные начисления как «Начисление», комплиментарные операции — отдельное оформление «Начислено администратором» с иконкой и комментарием.
- [x] Ограничить комментарий комплиментарных начислений 60 символами и включить перенос текста в миниаппе.
- [x] Комплиментарные баллы: счётчик символов в модалке и новое название операций в истории.

## Хотфикс 2025-10-24 — Portal: отмена всех операций
- [x] Расширить `/portal/operations/log`: поддержка фильтра `operationType`, новые поля `kind`, `details`, `note`, `change` в списке и деталях операций.
- [x] Реализовать отмену транзакций без чеков (акции, промокоды, регистрация, день рождения, автовозврат, комплимент, рефералы, возвраты, сгорание).
- [x] Обновить журнал операций и историю клиента: отображение новых данных, возможность отмены для всех типов операций.
- [x] Обновить документацию (`API_DOCUMENTATION.md`) и UI, отразить новые сценарии отмены.

- [x] Переименовать раздел в «Журнал операций», унифицировать тексты отмен (включая возвраты покупок) и добавить пагинацию по 7 записей в карточке клиента.

## Хотфикс 2025-10-23 — Portal: карточка клиента
- [x] Собрать фактическую схему данных карточки клиента (портал + API): уточнить источники для баланса, отложенных баллов, визитов, покупок, отзывов, рефералов, регистрационной даты и комментариев.
- [x] Расширить backend (`PortalCustomersService` и связанные DTO/модель) для полноценной выдачи данных списка и карточки клиента, включая начисления, удержания, визиты, рефералку и отзывы.
- [x] Добавить хранение комментария и флага блокировки начислений на стороне БД/сервиса, прокинуть через create/update, обеспечить фактическую блокировку начислений.
- [x] Обновить фронтенд портала (`/customers`, карточка клиента, модалка редактирования) для работы с реальными данными, переименовать поля, удалить моковые блоки и добавить переходы к пригласившему.
- [x] Обновить документацию (README/API_DOCUMENTATION/PAGES) и зафиксировать smoke-проверку списка и карточки клиентов.
- [ ] Прогнать релевантные тесты/линтеры, записать результаты.
## Хотфикс 2025-10-22 — TTL-напоминания о сгорании баллов
- [x] Проанализировать механику напоминаний: актуальные воркеры, портал, миниаппа и связанные механики TTL.
- [x] Реализовать/доработать отправку push без заголовка с плейсхолдерами `%username%`, `%amount%`, `%burn_date%`, учесть антидубли и тайминги.
- [x] Обновить портал (`/loyalty/mechanics/ttl`): убрать лишние подписи и превью с пояснениями.
- [x] Оформить в миниаппе операции сгорания: красный тон, иконка огня, текст «Баллы сгорели».
- [x] Проверить TTL в ограничениях, автовозврате, ДР, бонусе регистрации, акциях, промокодах и комплиментарных начислениях.
- [x] Обновить README/API_DOCUMENTATION/env и зафиксировать необходимые проверки.

## Хотфикс 2025-10-22 — Miniapp + Portal: Telegram-onboarding
- [x] Миниаппа требует валидный Telegram initData: убраны локальные `merchantCustomerId`, dev-автологины и прочие обходы, вне Telegram показываем понятную ошибку.
- [x] `teleauth` возвращает `merchantCustomerId`, `hasPhone`, `onboarded`; миниаппа использует флаги для быстрого старта и не грузит лишний профиль.
- [x] Автосинх профиля не запускается без телефона; шаг привязки номера завершает регистрацию и гарантирует, что окно «о себе» появляется только при реальной необходимости.
- [x] Portal `/customers` по умолчанию показывает только клиентов с заполненным профилем (имя, пол, ДР, телефон); добавлен серверный фильтр.
- [x] Обновлены API документация и раздел про миниаппу в admin; README без изменений.
- [x] Все чувствительные эндпоинты миниаппы требуют `Authorization: tma <initData>`; бэкенд валидирует подпись и сопоставляет `merchantCustomerId`.
- [x] Выделен общий `TelegramMiniappGuard`, которым защищены ручки регистрации бонуса и реферальные методы.
- [x] Добавлен `/loyalty/bootstrap`: старт миниаппы получает профиль/баланс/уровни/историю/акции одним запросом, фронт использует эндпоинт вместо набора отдельных fetch'ей.
- [ ] Прогнать смоук по потоку входа/регистрации после выката.

## Хотфикс 2025-10-21 — Механика «День рождения» (admin + api)
- [x] Реплицировать настройки механики и зафиксировать фактические запросы к `/loyalty/mechanics/birthday`.
- [x] Провести аудит опций: «За сколько дней поздравлять клиента», «Поздравлять только клиентов с покупками», тексты push в Telegram, подарочные баллы и сгораемость.
- [x] Доработать backend/admin/bridge при необходимости, обеспечить сквозную работу без моков и локальных значений.
- [x] Прогнать smoke-сценарий начисления/списания, проверить отправку уведомления, обновить документацию и env-переменные при необходимости. (unit: `pnpm test birthday.worker.spec.ts` — ✅; полный `pnpm test` падает на существующих guard/levels/referral спеках)
- [x] Плейсхолдеры механики ограничены `%username%` и `%bonus%`, `%username|обращение_по_умолчанию%` убран из UI/doc и обработчиков.
- [x] Разрешено значение `0` дней до поздравления (отправка в сам день), UI показывает пояснение.
## Хотфикс 2025-10-20 — Miniapp: подтверждение номера
- [x] Добавить индикатор загрузки в кнопке «Готово» до завершения сохранения профиля.
- [x] Добавить анимации нажатий на кнопки карточки профиля и шага «Поделиться номером».
- [x] Починить показ ошибки «Вы не привязали номер, попробуйте еще раз» при отсутствии телефона.
- [ ] Прогнать smoke-проверку шага привязки номера на стенде после выката.

## Хотфикс 2025-10-19 — Miniapp: «Поделиться номером» не возвращает на главную
- [x] Реплицировать проблему в миниаппе и зафиксировать текущие запросы/ответы.
- [x] Исправить фронтенд/бэкенд так, чтобы после успешного запроса выполнялся переход на главную.
- [ ] Прогнать smoke-сценарий, убедиться что переход происходит стабильно, обновить документацию при необходимости.

## Хотфикс 2025-10-18 — Miniapp: разделение клиентов по мерчантам
- [x] Проанализировать повторное использование Customer между мерчантами (teleauth, Telegram bot, CRM/Portal).
- [x] Исправить backend: teleauth, Telegram bot, CRM/portal поиск, чтобы создавать отдельные Customer для каждого мерчанта и требовать профиль.
- [x] Обновить документацию/README по авторизации и проверить сценарий входа в бот другого мерчанта.

## Хотфикс 2025-10-16 — Автовозврат клиентов (admin + api)
- [x] Разобраться в текущей механике автовозврата: фронтенд admin (`/loyalty/mechanics/auto-return`) и соответствующие сервисы API.
- [x] Уточнить расчёт интервала последней покупки: учитывать только начисления/списания за покупки, исключить акции/промокоды/реферал/возвраты.
- [x] Проверить и доработать подстановку плейсхолдеров `%username%`, `%bonus%`, убрать `%username|обращение_по_умолчанию%`.
- [x] Убедиться что опции «Подарить баллы» и «Сделать подарочные баллы сгораемыми» выполняются корректно (начисление, срок жизни).
- [x] Настроить повторные попытки возврата: рассылка и повторное начисление по интервалу при невозврате клиента.
- [x] Обновить документацию/README при необходимости и прогнать smoke-проверку механики.

## Хотфикс 2025-10-14 — Miniapp: баланс/история не обновляются
- [x] Реплицировать проблему после транзакции: проверить ответы `GET /loyalty/transactions`, `/loyalty/balance`, `/levels` и связанные кэши.
- [x] Найти и исправить ошибки по модели `merchantCustomer`, влияющие на построение eTag/кэш и отсутствие обновлений (исправлено: `quote` теперь прокидывает `customerId`, перестаёт создавать ложные `merchantCustomer`/кошельки).
- [ ] Обновить затронутые компоненты (API, bridge, miniapp) и документацию при необходимости.
- [ ] Протестировать обновлённый поток: транзакция → баланс/история/уровень в миниаппе, убедиться что статусы задач в очереди переходят в `DONE` (нужно подтвердить на стенде).

## Хотфикс 2025-10-12 — Merchant Portal: сессия/refresh токены

- [x] API (`api/src/portal-auth/portal-jwt.util.ts`): добавлены refresh‑токены (`signPortalRefreshJwt`/`verifyPortalRefreshJwt`) с отдельным секретом `PORTAL_REFRESH_SECRET` (TTL 30 дней).
- [x] API (`api/src/portal-auth/portal-auth.controller.ts`): `POST /portal/auth/login` теперь возвращает `{ token, refreshToken }`; добавлен `POST /portal/auth/refresh` с ротацией refresh‑токена; TTL access‑токена 24 часа.
- [x] Merchant Portal:
  - `app/api/session/login/route.ts`: установка `portal_jwt` (maxAge 24ч) и `portal_refresh` (maxAge 30д), опциональный `PORTAL_COOKIE_DOMAIN`, удалён localhost‑fallback у `NEXT_PUBLIC_API_BASE`.
  - `app/api/portal/_lib.ts`: авто‑рефреш access‑токена при `401` с установкой новых кук.
  - `app/api/session/accept-token/route.ts`: `portal_jwt` с `maxAge` и доменом.
  - `app/api/session/logout/route.ts`: очищаются обе куки `portal_jwt` и `portal_refresh`.
  - `middleware.ts`: при истёкшем `portal_jwt` и наличии `portal_refresh` — редирект на `/api/session/refresh?redirect=...`, иначе — на `/login`.
  - `app/api/session/refresh/route.ts`: обновление `portal_jwt`/`portal_refresh` через `POST /portal/auth/refresh` и возврат на исходный URL.
- [x] ENV: добавлены примеры переменных `PORTAL_REFRESH_SECRET` (API) и `PORTAL_COOKIE_DOMAIN` (merchant-portal) в `infra/env-examples/*`.
- [x] Docs: обновлён `API_DOCUMENTATION.md` (ответ логина, эндпоинт refresh, поведение кук).
- [x] Admin Impersonation: TTL имперсонационного токена увеличен с 10 минут до 24 часов (`api/src/merchants/merchants.service.ts: impersonatePortal`).

## Хотфикс 2025-10-12 — Miniapp: QR-модалка выравнивание

- [x] Miniapp: выровнять карточки «Баланс»/«Уровень» и прогресс с фоном QR-блока, обеспечить равномерное масштабирование элементов.
- [x] Miniapp: привязать заголовок, QR, кнопку обновления и таймер к фону, чтобы сохранялась пропорциональность при масштабировании.
- [x] Miniapp: обновить документацию/README при необходимости после правок верстки (обновления не потребовались).

## Хотфикс 2025-10-13 — Miniapp: ручная привязка номера телефона

- [x] Шаг «Привяжите номер»: кнопка после первого нажатия остаётся на экране в статусе «Готово» (зелёная, с иконкой галочки) и запускает ручную проверку номера только по повторному клику.
- [x] При подтверждении номера сохраняем профиль и возвращаем пользователя на главную. При отказе — показываем ошибку «Вы не привязали номер телефона, повторите попытку» и возвращаем кнопку к состоянию «Поделиться номером».
- [x] Убрано автоматическое сохранение без номера; логика миниаппы переведена на явную проверку ответа Telegram WebApp перед сохранением профиля.
- [x] Miniapp: состояние «Поделиться номером» → «Готово» с проверкой `GET /loyalty/profile/phone-status`, участием тостов при отмене/ошибке и повторной попыткой после неудачи.
- [x] API Miniapp: добавлен `GET /loyalty/profile/phone-status` (возвращает `{ hasPhone }`), документация обновлена.

## Хотфикс 2025-10-13 — Telegram Bot: повторная авторизация по уже привязанному номеру

- [x] `TelegramBotService.processWebhook()` теперь при конфликте уникальности телефона ищет клиента с таким номером и перекидывает текущего Telegram-пользователя на существующий `customerId`.
- [x] Добавлен `linkTelegramToCustomer()` — обновляет `customerTelegram` и `customer.tgId`, очищает старые связи, если номер уже зарегистрирован.
- [x] Бот больше не оставляет в логах предупреждения об ошибке Prisma при повторной привязке номера; вместо 400 возвращается успешная авторизация уже существующего клиента.

## Фича 2025-10-14 — Merchant Portal: Авторизация по email + пароль (+TOTP), группы доступа

- [x] Backend PortalAuth: единый логин мерчанта/сотрудника (по email), проверка пароля и TOTP (только для мерчанта), обновление `portalLastLoginAt`/`lastPortalLoginAt`, JWT с типом субъекта, `merchantId`, `staffId`, признак имперсонации.
- [x] PortalGuard/PortalController: верификация токена, подгрузка портальных прав сотрудника (группы `AccessGroup`), расширенный ответ `/portal/me` с permissions/role/actor, проброс `portalPermissions`.
- [x] Merchant Portal (Next.js): страница логина (TOTP-поле по требованию, валидации), layout и навигация, скрывающая разделы без прав; редиректы неавторизованных.
- [x] Docs: README + API_DOCUMENTATION про PortalAuth (email staff/merchant, TOTP только для мерчанта, структура `/portal/me`, cookie `portal_jwt`).
- [x] Проверки: прогнать smoke (логин мерчанта без/с TOTP, сотрудника с ограниченной группой), убедиться что сессия в cookie, middleware блокирует доступ.

## Фича 2025-10-09 — Реферальная программа в Mini App

- [x] Miniapp: добавлена кнопка `Пригласить друга` рядом с `Акции` (каждая занимает 50% ширины, адаптивная вёрстка): `miniapp/app/page.tsx` + стили `page.module.css` (`.actionsPair`, `.inviteActionButton`).
- [x] Miniapp: шторка «Пригласить друга» в стиле настроек (`.modalBackdrop`/`.sheet`) с кликабельными плейсхолдерами `{link}`/`{code}` (копирование в буфер) и кнопкой «Отправить сообщение» (вызов Telegram share). Тексты шаблона и кнопки приходят из API.
- [x] Miniapp: на шаге «Расскажите о себе» показ опционального поля «Пригласительный код» при активной реферальной программе.
- [x] Backend: расширена Prisma‑модель `ReferralProgram` полем `shareButtonText`.
- [x] API: `ReferralService` — поддержка `shareButtonText` в create/update/settings/link; `PortalController.normalizeReferralProgramPayload()` — проксирование `shareButtonText`.
- [x] Merchant Portal: страница `referrals/program` — добавлено поле «Текст сообщения при нажатии «Отправить сообщение»», отправляется в `PUT /api/portal/referrals/program`.
- [x] Docs: дополнен `API_DOCUMENTATION.md` по рефералкам (настройки портала и ответ `GET /referral/link`).

## Хотфикс 2025-10-11 — Miniapp: UX шторок и QR

- [x] Miniapp: обновлена шторка «Пригласить друга» — центрированы тексты, primary-кнопка стала фиолетовой, чипы ссылки/кода получили облегчённую обводку и адаптивные отступы.
- [x] Miniapp: для всех шторок и QR-модалки добавлены анимации открытия/закрытия (хук `useDelayedRender`, обновлённые backdrop/slide keyframes); `FeedbackManager` синхронизирован с новой анимацией.
- [x] Miniapp: карточка «Расскажите о себе» стала компактнее, паддинги и ширина зависят от высоты экрана и наличия поля пригласительного кода.
- [x] Miniapp: переработан модальный QR — полноэкранная оболочка с автоматической подстройкой QR-кода, кнопки «Обновить QR» и карточек метрик без наложений.

- [x] Miniapp: форма профиля — поле даты заменено на три селекта «Год»/«Месяц»/«День» (обязательны к выбору), расположены горизонтально. Заголовок «Дата рождения» сохранён. Стили добавлены в `miniapp/app/page.module.css` (`.dateRow`, `.dateSelect`), дата собирается в формат `YYYY-MM-DD`.
- [x] Miniapp: обновлены тексты шага профиля — субтитр заменён на «Эта информация поможет нам подобрать акции лично для вас», подсказка под полем пригласительного кода удалена.
- [x] Miniapp: QR-модалка — при скрытом прогресс-баре контент не растягивается по вертикали (правки `miniapp/app/qr/page.module.css`: `.modalBody { align-items/start; align-content/start; grid-auto-rows: max-content; }`).

## Хотфикс 2025-10-11 — Miniapp: телефон обязателен при сохранении профиля

- [x] Miniapp (`miniapp/app/page.tsx`): двухшаговый сценарий.
  - Шаг 1 «Расскажите о себе»: по нажатию «Сохранить» при отсутствии номера — переход на шаг привязки (без запроса прав).
  - Шаг 2 «Привяжите номер телефона»: кнопка «Поделиться номером» вызывает `requestContact()` (fallback `requestPhoneNumber()`). При успешном получении номера профиль сохраняется и происходит переход на главную. При отмене — остаёмся на шаге 2, без действий.
- [x] Miniapp API‑клиент (`miniapp/lib/api.ts`): `profileSave()` принимает опциональный `phone` и передаёт его на сервер.
- [x] Backend DTO (`api/src/loyalty/dto.ts`): добавлено поле `phone?: string` в `CustomerProfileSaveDto`.
- [x] Backend контроллер (`api/src/loyalty/loyalty.controller.ts`): при первом сохранении профиля для клиента телефон обязателен (если ещё не сохранён). Номер нормализуется (`+7XXXXXXXXXX`), сохраняется в `Customer.phone`, при конфликте уникальности возвращается `400` «Номер телефона уже используется».
- [x] Docs (`API_DOCUMENTATION.md`): обновлён раздел `POST /loyalty/profile` — добавлено поле `phone` и требование обязательности при первичном сохранении.

## Хотфикс 2025-10-09 — Miniapp UX (скелетоны/BackButton)

- [x] Страница QR (`miniapp/app/qr/page.tsx`): добавлен Telegram BackButton в нативную шапку (`WebApp.BackButton`), обработчик `onClick` → `router.back()`/fallback `push('/')`. Типизация `lib/telegram.ts` расширена (BackButton, onEvent/offEvent).
- [x] Главная (`miniapp/app/page.tsx`): внедрён общий skeleton-режим загрузки — карточка, поле промокода, пара кнопок «Акции/Пригласить друга», история. Убран оверлей со спиннером.
- [x] Онбординг: исключён «мигающий» показ формы — до полной инициализации отображается skeleton; поле «Пригласительный код» доступно сразу при первом заходе.
- [x] Кнопки: добавлены лёгкие анимации нажатия, отключён синий tap‑highlight (селекторы `:global` в `page.module.css` и `qr/page.module.css`).
- [x] Шторка «Пригласить друга»: улучшен вывод копируемых значений — чипы с моноширинным шрифтом и переносом по многоточию; из копируемых блоков убраны подписи «Ссылка»/«Код».

## Хотфикс 2025-10-10 — Рефералки: deep link и валидация кода

- [x] Backend (`api/src/referral/referral.service.ts`): ссылки рефералок теперь — Telegram Mini App deep link вида `https://t.me/<bot>?startapp=<token>`, при наличии `merchant.settings.telegramBotUsername` и `TMA_LINK_SECRET`. В payload токена добавлен `referralCode` для автоподстановки.
- [x] Backend: методы `createReferral()` и `getCustomerReferralLink()` отдают deep link; QR код строится по deep link. `sendReferralEmail()` использует сгенерированный deep link.
- [x] Miniapp (`miniapp/app/page.tsx`): автоподстановка `inviteCode` из `initData.startapp` (payload.referralCode) на шаге онбординга.
- [x] Miniapp: на сабмите профиля при наличии кода сначала выполняется `referralActivate`; при ошибке — НЕ сохраняем профиль, показываем ошибку «Недействительный пригласительынй код». Если код не указан — сохраняем профиль без ошибок.

Требуется после обновления выполнить миграции Prisma и пересобрать сервисы.

## Хотфикс 2025-10-10 — Реферальная программа: начисления при покупках

- [x] Backend (`api/src/loyalty/loyalty.service.ts`): начисление реферальных бонусов перенесено в `LoyaltyService.commit()` через приватный метод `applyReferralRewards()`. Начисления происходят сразу после создания `receipt`.
- [x] Триггер начислений: учитывается настройка программы — «За первую покупку друга» (`rewardTrigger = 'first'`) или «За все покупки друга» (`'all'`). Для `first` связь помечается `COMPLETED` после первой покупки.
- [x] Тип поощрения: «Фиксированное количество баллов» (`rewardType = 'FIXED'`) или «Процент от суммы покупки» (`'PERCENT'`). Процент считается от суммы чека `total`.
- [x] Многоуровневость: при `multiLevel=true` учитываются уровни из `levelRewards` (L1 всегда включён). Для каждого уровня начисляется соответствующее вознаграждение пригласителю цепочки.
- [x] Стэкинг с регистрацией: в `grantRegistrationBonus()` запрещена выдача регистрационного бонуса приглашённому клиенту, если в активной программе `stackWithRegistration = false`. При `true` регистрационный бонус и реферальные бонусы суммируются корректно (только для приглашённого).
- [x] Документация: дополним раздел Referrals в `API_DOCUMENTATION.md` описанием триггеров/типов/многоуровневости и примерами расчётов (to-do).

### Miniapp — отображение реферальной программы

- [x] История: транзакции типа `REFERRAL` отображаются как «Реферальная программа» с отдельной иконкой человека и сиреневым оформлением (`historyTone_referral`/`historyIcon_referral`).
- [x] Кнопка «Пригласить друга»: заменена иконка рукопожатия на иконку человека (SVG) в `miniapp/app/page.tsx`.
- [x] Окно отзыва: не показывается для реферальных начислений у пригласившего (исключено в `isPurchaseTransaction()`), показывается только покупателю по чеку.
## Новая структура панелей (договорились)

- Админ‑панель (Owner Admin):
  - Мерчанты: список/создание/редактирование/удаление. При создании ОБЯЗАТЕЛЬНО ownerName; автоматически создаётся сотрудник‑владелец.
  - Настройки мерчанта (перенос): QR TTL, Требовать подпись Bridge, Требовать Staff‑ключ; логин кассира (slug) и пароль из 9 цифр (регенерация).
  - Интеграции и POS‑настройки, Telegram‑бот (токен), наблюдаемость (Metrics/Outbox/SyncLog).

- Мерчант‑панель (Merchant Portal):
  - Сотрудники: табы Работает/Уволен, фильтры (Роли/Точки/«Только с доступом в панель»), поиск, карточка сотрудника (доступы/связанные точки/пин‑коды/уволить/сменить пароль и т.п.).
  - Торговые точки (вместо устройств): список/создание/редактирование.
  - Программа лояльности: Механики, Акции, Промокоды (взамен Ваучеров), Push/Telegram‑рассылки, Мотивация персонала, Антифрод, Панель кассира (логин/пароль, таблица пинкодов сотрудников по точкам).
  - Клиенты и аудитории; Товары и категории; Отзывы; Аналитика (Сводный, По времени, Портрет, Повторы, Динамика, RFM, Активность точек/сотрудников, Рефералы, ДР, Автовозврат).

— Устройства: депрекация. UI/роуты удаляем, опираемся на Торговые точки.
  - [x] Бэкенд-агрегации/выгрузки перевёл на `outletId`: аналитика (Top Devices → Outlet usage c `posLastSeenAt`), воркер активации начислений, CRM-таймлайн, push-устройства (реестр по `outletId`), интеграционные DTO и CSV/SDK.
- [x] DTO/ответы merchants/loyalty и клиенты (admin/bridge/cashier) очищены от `deviceId`, добавлены поля POS-агрегации (`outletPosType`, `outletLastSeenAt`).
- [x] Staff DTO/SDK/doc: `allowedDeviceId` убран, публичные схемы и коллекции пересобраны под `allowedOutletId`/`outletId`.
- [x] OpenAPI/документация и e2e/контрактные тесты приведены к схеме без `deviceId`; зафиксированы outlet-секреты.
  - [x] LoyaltyController окончательно отказался от `deviceId`: подпись Bridge/hold кешируются только по `outletId`, публичные DTO и роуты очищены.
- [x] LoyaltyService: расчёт/commit/refund и outbox работают только с `outletId`, записи `deviceId` прекращены.
- [x] Guard'ы: троттлер, антифрод и кассир работают без `deviceId`, опираются на `outletId` и роли сотрудников.
- [x] AntiFraud конфиг: UI/сервис переименовали `af.device` → `af.outlet`, добавлена миграция по rulesJson.
- [x] Device-модель убрана окончательно: миграция добрала `bridgeSecret`/`lastSeen`, ограничение сотрудников переведено на точки, Prisma очищена от `deviceId`.

## Батчи внедрения (план)

- Перенести конфигурацию Prisma из `package.json#prisma` в `prisma.config.ts` (депрекация в Prisma 7). Обновить README и примеры ENV при необходимости.

## Хотфикс 2025-09-16 — Отзывы (новое)
- [x] Диагностировать множественный показ окна отзыва после транзакции и починить UX
- [x] Усилить submitReview: требовать реальную транзакцию/заказ, предотвращать повторные начисления
- [x] Починить показ блока «Поделиться отзывом» при выполнении порога настроек
- [x] Обновить README/доки по изменениям
- [x] Miniapp: второй этап окна отзыва берёт площадки из ответа `POST /loyalty/reviews`, fallback убирает пустые просьбы без ссылок, документировано API

## Хотфикс 2025-10-03 — Отзывы (production hardening)
- [x] Убраны локальные значения в прод‑коде портала: `merchant-portal/app/api/portal/_lib.ts` больше не имеет дефолта `http://localhost:3000`, требуется `NEXT_PUBLIC_API_BASE`.
- [x] Miniapp: dev‑автогенерация `customerId` теперь только по флагу `NEXT_PUBLIC_MINIAPP_DEV_AUTO_CUSTOMER` (проверка `localhost` удалена) — прод по умолчанию `0`.
- [x] MerchantsService: Ajv‑валидация `rulesJson.reviewsShare` (enabled/threshold/platforms/outlets) в `validateRules()`.
- [x] Portal Catalog: валидация URL для `reviewsShareLinks` (http/https, без `javascript:`), патч‑обновление ссылок точек (строка = upsert, null = удалить), кейсы мержатся без потерь.
- [x] LoyaltyController: метрика `reviews_share_stage_total{outcome,reason}` для наблюдаемости решений по показу второго шага.
- [x] Miniapp/Backend: строгая привязка «поделиться отзывом» только к текущей точке (`outletId`) — фоллбеки на другие точки/`platform.url` удалены.
- [x] .env: обновлён `.env.production.example` — добавлены `NEXT_PUBLIC_API_BASE`, `NEXT_PUBLIC_MINIAPP_DEV_AUTO_CUSTOMER`.

- [x] Miniapp: окно отзыва открывается только для покупок — учитываются только операции `EARN/REDEEM`; возвраты/акции/промокоды/прочие начисления/списания исключены (`miniapp/app/page.tsx`: `formatTxType()`/`isPurchaseTransaction()` и фильтр `eligibleTransactions`).

## Декомпозиция 2025-10-03 — Отзывы: только для портала (без публичных функций)
- [x] Публичные эндпоинты `reviews/*` упразднены (возвращают 404): «Статистика», «Модерация», «Популярные отзывы», «Детали отзыва», «Реакции», «Шаблоны ответов», «Удаление».
- [x] Физическая чистка `api/src/reviews/review.service.ts`: удалены неиспользуемые типы/методы (`CreateReviewResponseDto`, `ReviewStats`, `createReviewResponse`, `moderateReview`, `getMerchantReviews`, `getReviewStats`, `reactToReview`, `getReview`, `deleteReview`, `getPopularReviews`, `updateReviewCounters`).
- [x] Поток создания отзыва оставлен только через `POST /loyalty/reviews` (миниаппа). Просмотр отзывов — только через `GET /portal/reviews` (PortalController → PortalReviewsService) с полями: Клиент, Оценка, Комментарий, Сотрудник, Торговая точка, Дата/время визита.
- [ ] (Опционально) Полностью удалить `reviews`-контроллер, оставив лишь `loyalty/reviews` и `portal/reviews` — после проверки отсутствия внешних интеграций.

## Хотфикс 2025-09-15 — Группы доступа (в работе)
- [x] Диагностировать `/portal/access-groups`: выяснил отсутствие дефолтных групп и отсутствие UX-обработки ошибок в портале.
- [x] Исправить сервис `MerchantPanelService`: автосоздание дефолтных групп, структурные логи/метрики, проверка сохранения участников.
- [x] Обновить фронт `/settings/access`: устойчивый фетч, обработка ошибок, синхронизация после CRUD.
- [ ] Покрыть тестами (юнит/интеграция) сценарии листинга/создания/назначения, чтобы зафиксировать регрессию.
- [ ] Задокументировать поведение (README/PAGES) и проверить `/metrics` после изменений.
- [x] Карточка сотрудника: подтянул реальные данные через `/portal/staff/:id`, починил загрузку точек/групп и совместимость с `React.use(params)`.
- [x] Удалил персональный PIN из карточки сотрудника: пин-коды теперь появляются только при добавлении торговых точек и берутся из `staffOutletAccess`.
- [x] Обновил блок доступа в портал: тумблер лишь раскрывает форму с группой/e-mail/паролем, пароль задаётся однократно и скрывается после сохранения, для уволенных показывается кнопка «Восстановить».
- [x] Починил авторизацию кассира по PIN: поиск идёт по `staffOutletAccess`, выдаём реальные данные для /loyalty/cashier и API `/portal/cashier/pins`.
- [x] Карточка сотрудника: убрал повторные запросы групп доступа и перезагружаю пин-коды точек после операций (добавление/удаление/ротация).
- [x] Портал: очистил разделы «Сотрудники»/«Торговые точки»/«Группы доступа» от моков, использую реальные группы при выдаче доступа и убрал системного владельца из списка.
- [x] Портал: при сохранении портальной роли сохраняю ранее назначенные группы доступа (не очищаю кассовые/аналитические права).
- [x] API создания сотрудника: вынес возврат `getStaff` из транзакции, чтобы после POST не падало с 404 «Сотрудник не найден».
- [x] Механика «Ограничения в баллах»: подключил TTL, запрет одновременного начисления/списания и задержку использования к /portal/settings и обновил UI.
- [x] Telegram Mini App: подчистил UI (состояние кнопки, skeleton для блоков, скрытие данных после отключения — и на карточке интеграций тоже) и учёл предупреждение о webhook без падения подключения.
- [x] Реферальная программа: перенёс настройки на реальные данные (проксирование через портал, Prisma-миграция, расчёт вознаграждений в процентах/баллах), подключил аналитику и отдал в miniapp кнопку «Пригласить друга» с рабочими плейсхолдерами и вводом кода приглашения.
- [x] Miniapp: подключил отображение реального баланса/уровня/кэшбэка, активацию промокодов и обновление истории транзакций.
- [x] Miniapp: показ окна оценки визита после начисления или списания с историей и сохранением оценок локально.
- [x] Miniapp: шторка оценки показывается один раз для покупок (earn/redeem purchase) и не повторяется после закрытия.
- [x] Miniapp: обновляю баланс, историю и прогресс уровней после commit событий через локальные уведомления из кассы и при возврате в приложение.
- [x] Miniapp: открываю шторку оценки визита сразу после commit-покупки, если начислены или списаны баллы.
- [x] Miniapp: фикс повторного пропуска шторки — учитываю новые транзакции и расширяю окно поиска, чтобы отзыв открывался сразу после commit.
- [x] Miniapp: ввёл резервный показ шторки по новым транзакциям и определяю покупки по типу/заказу, чтобы отзыв открывался даже без локальных событий.
- [x] Miniapp: предлагает поделиться отзывом на подключённых сервисах при высокой оценке, учитывая порог и настройки портала.
- [x] Miniapp: отправка отзывов в реальный API с моментальной публикацией и появлением в портальной таблице без модерации.
- [x] Miniapp: настроил периодический фоновой опрос истории и баланса, чтобы автообновление работало между разными устройствами.

## Хотфикс 2025-10-05 — Miniapp QR и главная
- [x] Генерация QR перенесена только на страницу `/qr`, главная перестала автоматически вызывать mint и лишний тумблер убран из настроек.
- [x] Главный экран: карточка баланса/уровня/кэшбэка обновлена (белые подписи, кнопка «Нажмите» без подчёркивания, стрелка «Назад» убрана).
- [x] Страница QR: удалена ссылка «Вернуться в профиль», уменьшена подложка вокруг кода, таймер остался рядом с кнопкой.
- [x] Страница QR: добавлен адаптивный прогресс-бар «Сумма покупок до следующего уровня» с отображением текущей суммы и порога (заглушка).
- [x] Миниаппа: логика окна отзыва вынесена в общий контроллер, окно появляется на любой странице после покупки.
- [x] Страница QR автоматически обновляет баланс и уровень по событиям и при возврате в приложение.

- [x] Реферальная программа: поправил типизацию под Prisma v6 (используем `ReferralProgram` из клиента и корректно формируем payload create/update), чтобы `tsc` не падал на сервисе.
- [x] PortalModule импортирует ReferralModule, чтобы `ReferralService` в портале резолвился без ошибок DI.
- [x] Коммуникации: Push/Telegram кампании перевёл на CommunicationTask (миграция данных, единый сервис/контроллеры, чистка тестов и прокси).
- [x] Push-реестр и антифрод очищены от `deviceId`: скоринг, уведомления и миграции опираются на `outletId`.
- [x] Проверил миграции `backfill_device_outlet`, `push_outlet_id`, `remove_device_table`, `referral_program_enhancements`: добавил проверки схемы и гарантировал совместимость со старыми/новыми базами.
- [x] Починил сборку после апдейта Prisma/Nest: удалил лишний декоратор, привёл типы JSON и переписал подсчёт уникальных участников акций через groupBy.

## Хотфикс 2025-10-06 — Telegram уведомления сотрудников (единый бот)
- [x] Prisma: добавлены модели `TelegramStaffInvite` и `TelegramStaffSubscriber` для токенов инвайтов и реестра подписчиков (пользователи/группы), `@@unique([merchantId, chatId])`.
- [x] API: сервис и контроллер единого бота уведомлений сотрудников — вебхук `POST /telegram/notify/webhook` (проверка `X-Telegram-Bot-Api-Secret-Token`), диагностика `GET /telegram/notify/webhook-info`.
- [x] Admin API: `GET /notifications/telegram-notify/state`, `POST /notifications/telegram-notify/set-webhook`, `POST /notifications/telegram-notify/delete-webhook`.
- [x] Admin UI: вынесен раздел в отдельную страницу `/telegram_notifications`; пункт добавлен в боковую панель. Страница показывает статус, username, URL webhook, ошибки; кнопки управления webhook.
- [x] Portal API: `GET /portal/settings/telegram-notify/state`, `POST /portal/settings/telegram-notify/invite`, `GET /portal/settings/telegram-notify/subscribers`, `POST /portal/settings/telegram-notify/subscribers/:id/deactivate`.
- [x] Merchant Portal UI: страница `settings/telegram` перешла на реальные данные — генерирует deep‑link `start`/`startgroup`, показывает список подписчиков и позволяет отвязать.
- [x] ENV: обновлён `.env.production.example` — добавлены `TELEGRAM_NOTIFY_BOT_TOKEN`, `TELEGRAM_NOTIFY_WEBHOOK_SECRET`.
- [x] Docs: в `API_DOCUMENTATION.md` добавлен раздел «Telegram уведомления сотрудников (единый бот)» с описанием ENV, вебхука и эндпоинтов Admin/Portal.

## Фича 2025-10-06 — Telegram Mini App (персональный бот на мерчанта)
- [x] Portal API: эндпоинты интеграции —
  - `GET /portal/integrations/telegram-mini-app` (state),
  - `POST /portal/integrations/telegram-mini-app/connect` (подключение бота),
  - `POST /portal/integrations/telegram-mini-app/check` (проверка webhook),
  - `POST /portal/integrations/telegram-mini-app/link` (генерация deep link с `startapp`),
  - `POST /portal/integrations/telegram-mini-app/setup-menu` (установка Chat Menu Button),
  - `DELETE /portal/integrations/telegram-mini-app` (отключение).
- [x] Portal UI: страница `integrations/telegram-mini-app` — кнопки «Сгенерировать ссылку», «Установить кнопку меню», показ deep link и копирование; обновление сообщения о состоянии.
- [x] Mini App backend: `POST /loyalty/teleauth` — валидация `initData` токеном бота мерчанта и проверка подписанного `start_param` (HS256, `TMA_LINK_SECRET`) на соответствие `merchantId`.
- [x] ENV: добавлены `MINIAPP_BASE_URL`, `TMA_LINK_SECRET` в `api/.env.production.example`; `API_BASE_URL` — для установки webhook.
- [x] Docs: раздел «Telegram Mini App (персональный бот на мерчанта)» в `API_DOCUMENTATION.md`.

## Хотфикс 2025-10-08 — Профиль Mini App (кросс‑девайс)
- [x] API: добавлены публичные эндпоинты профиля клиента для Mini App — `GET /loyalty/profile` и `POST /loyalty/profile`.
  - Формат профиля: `{ name: string|null, gender: 'male'|'female'|null, birthDate: 'YYYY-MM-DD'|null }`.
  - Сохранение: `{ merchantId, customerId, name, gender, birthDate }` с валидацией формата/длины и изоляцией по `(merchantId, customerId)` через `ensureCustomerForMerchant()`.
- [x] Guard: `CashierGuard` разрешает публичный доступ к `/loyalty/profile` (GET/POST), аналогично `teleauth/consent`.
- [x] Mini App:
  - Подтягиваем профиль с сервера после авторизации (`profileGet`) и сохраняем на сервер по сабмиту формы (`profileSave`).
  - Локальный кэш синхронизируется с серверным (`miniapp.profile.v2:<merchantId>`).
  - Клиент больше не использует `start_param/startapp` для определения `merchantId` — только URL (`?merchantId`/`?merchant`).
- [x] Docs: `API_DOCUMENTATION.md` обновлён — описаны `GET/POST /loyalty/profile`, оговорена изоляция по мерчанту и серверная валидация.

## Хотфикс 2025-10-09 — Ops алерты и наблюдаемость
- [x] Алерт-бот админов: AlertsService с throttle и историей инцидентов, добавлен фоновый мониторинг outbox/воркеров (пороги через `ALERT_*`), 5xx алерты дополнились traceId; новые admin эндпоинты `/observability/summary`, `/alerts/state`, `/alerts/test`.
- [x] Админка: раздел `/observability` (статус бота, последние инциденты, метрики outbox/HTTP, состояние воркеров, кнопка теста); обновлены README/API_DOCUMENTATION/env-примеры с порогами алертов и рекомендациями по Prom/Grafana/Sentry/OTel.

## Хотфикс 2025-10-02 — Подписи Bridge для лояльности
- [x] CashierGuard: нормализуем payload подписи Bridge под контроллеры (quote/commit/refund/cancel) и берём `outletId` из hold/receipt, чтобы корректные подписи пропускались без Staff-Key.
- [x] CashierGuard: при staff-key подхватываем outletId из hold/receipt и разрешаем mint QR с валидной bridge-подписью без staff-key.
- [x] CashierGuard: для commit/cancel при валидации подписи используем только `outletId` из hold, игнорируя значение из тела, чтобы исключить обход изоляции точек.
- [x] Earn lots: удалил передачу `metadata` при создании записи, чтобы `POST /loyalty/promocodes/apply` не падал на Prisma-валидации при включённом флаге `EARN_LOTS_FEATURE`.
- [x] LoyaltyModule тянет `ReviewModule` через `forwardRef`, чтобы публичный эндпоинт отзывов резолвил `ReviewService` без ошибок DI.

1) Бэкенд — мерчанты/владелец/CRUD (минимальная версия, обратная совместимость)
- Добавить в админ‑API: PUT/DELETE мерчанта; POST /merchants принимать ownerName и авто‑создавать сотрудника‑владельца (роль MERCHANT). До миграции — без новых полей, только `login`.
- [x] Перенос настроек в админку: использовать существующие поля `MerchantSettings` (qrTtlSec, requireBridgeSig, requireStaffKey); портальную страницу настроек позже очистить.
- Прогнать тесты, починить до зелёного.

2) Prisma‑миграции (расширение моделей)
- Staff: firstName/lastName/position/phone/comment/avatarUrl, pinCode(4), canAccessPortal(bool), isOwner(bool).
- Merchant: cashierLogin(unique), cashierPassword9, archivedAt.
- AccessGroup/AccessGroupMember; StaffOutletAccess (staff↔outlet + pinCode, lastTxnAt).
- Методы Admin/Portal для управления пинкодами и доступами.
- LoyaltyPromotion: вынесена отдельная таблица `loyalty_promotions`, миграция и сиды обновлены.

3) Портал/Админ — фронтенд
- Удалить «Устройства», усилить «Торговые точки».
- [x] Перенести UI настроек (QR TTL/BridgeSig/StaffKey) в админку; в портале убрать эти поля.
- [x] Портал: раздел «Системные настройки» заменён на справку про уровни и ссылку на админ‑панель; поля Earn/Redeem Bps убраны.
- ✅ Реализованы «Сотрудники» по ТЗ: табы «Работает»/«Уволен», фильтры (роли/точки/только с доступом), поиск, новая таблица с аватарами/иконкой владельца, карточка сотрудника (доступы, связанные точки, PIN‑коды, увольнение, смена пароля, просмотр транзакций), модалки создания/редактирования.
- ✅ Добавлен клиентский UI управления группами доступа (таблица RUD, модалка CRUD‑прав, локальное хранение и интеграция с формами сотрудников).
- ✅ Панель кассира: отображение логина и 9‑значного пароля, генерация и копирование, обязательный персональный PIN каждого сотрудника, обновлённый виртуальный терминал с двухшаговой авторизацией (slug+пароль → PIN) и выдачей staff key.
- ✅ REST/GraphQL слой портала: сотрудники, группы доступа, торговые точки и кассовые данные с валидацией DTO, пагинацией, счётчиками и массовыми операциями.
- ✅ Next.js-прокси и страницы портала синхронизированы с новым API: сотрудники, торговые точки, аналитика; в layout внедрён ACL по роли `portal/me`.
- ✅ Тестовый ритуал поправлен: `pnpm -C api test` и `test:e2e` автоматически вызывают `prisma generate`, поэтому юнит- и e2e-спеки выполняются в чистом окружении.
- ✅ Добавлены структурные логи и метрики для операций портала (списки сотрудников/групп, изменение статусов, ротация PIN) + unit-тест `listStaff`.
- ✅ Лояльность, аудитории и коммуникации переведены на структурные логи (`portal.loyalty.*`, `portal.customers.*`, `portal.communications.*`) и счётчики (`portal_loyalty_*`, `portal_audiences_*`, `portal_communications_*`) для наблюдаемости действий UI.
- ✅ Уровни лояльности: расчёт и парсинг вынесены в общий helper, переиспользуемый сервисами, обновлены юнит-тесты на бонусы уровней.
- ✅ Антифрод (ядро): velocity/факторы переключены на outletId, введены новые пороги, блок-факторы и unit-тесты (guard/service/throttler).

- ✅ Сделаны промокоды на баллы: новая страница с табами «Активные/Архивные», строкой «Показаны записи …», таблицей с колонками «Промокод/Описание/Баллы/Группа/Срок/Использован» и иконками RUD (в архиве — «Вернуть»), полнофункциональной модалкой создания/редактирования (период действия, начисление баллов, сгорание, уровень, лимиты, периодичность, визиты) и поддержкой восстановления промокода.
- ✅ Раздел «Акции»: tabs «Предстоящие/Активные/Прошедшие», карточки c участниками, мини‑графиками выручки, режимом «Акция не запущена», расширенная модалка создания (период, аудитория, выдача баллов, сгорание, PUSH‑уведомления, автозапуск).
- ✅ Раздел «Аудитории клиентов»: поиск, таблица всех метрик, модалка создания/редактирования с чекбоксами, мультиселектами, диапазонами, уровнями RFM, просмотр состава аудитории.
- ✅ Механика «Баллы за регистрацию»: UI подключен к `rulesJson.registration`, поддерживает настройки TTL и задержку начисления через реальные данные `/portal/settings`.
- ✅ Механика «Сгорание (TTL)»: напоминания читают/сохраняют `rulesJson.burnReminder`, отображают срок жизни и наличие Telegram-бота по данным мерчанта.
- ✅ Промокоды: портал работает с `PromoCode` (CRUD, лимиты, визиты, периоды), commit начисляет баллы/TTL и повышает уровни.
- ✅ Убраны демонстрационные сиды `WELCOME2025`/`SUMMER2024`, вкладки портала грузят реальные статусы, а мини-аппа активирует промокоды через `POST /loyalty/promocodes/apply` с начислением баллов, TTL и повышением уровня.
- ✅ Почистил e2e на промокоды: убраны ссылки на ваучеры, обновлены ожидания под реальные расчёты и закрыт тип по JSON-колонкам.

### Merchant Portal — Каталог и торговые точки (новое ТЗ)

#### Товары
- [x] Бэкенд: Prisma-модели товаров/категорий/стоков, эндпоинты портала для списка, карточки, создания, редактирования, массовых действий.
- Список:
  - Фильтры: **Категория** (дропдаун «Все категории»), **Статус** (дропдаун «Все товары»: «Отображаются в каталоге», «Не отображаются в каталоге»), **Правила баллов** (дропдаун: «С начислением баллов», «Без начисления баллов»), поиск по названию/артикулу.
  - Таблица: чекбокс, превью, **Название**, **Категория**, **Покупок за месяц**, **Покупок всего**, **Артикул**.
  - Пустое состояние: иллюстрация + кнопка **«Добавить товар»**.
  - Массовые действия после выбора: скрыть/показать в каталоге, разрешить/запретить оплату баллами, удалить (с подтверждением).
- Добавление товара (страница с табами): **Основное**, **Каталог и характеристики**, **Цены и остатки**.
  - «Основное»:
    - **Название товара** — обязательно.
    - **Артикул** — опционально (генерация бэком).
    - **Категория** — дропдаун.
    - **Правила для баллов**: тогглы **«Начислять баллы за товар»**, **«Разрешить платить баллами за товар»** (обе включены по умолчанию), поле **Какую часть товара можно оплатить баллами, %** (0…100, по умолчанию 100).
    - Кнопка **«Далее»** сохраняет черновик и переводит на следующий таб.
  - «Каталог и характеристики»:
    - **Порядок** (число, сортировка списков).
    - **Связанный товар в iiko (Delivery)** — селект, опционально.
    - Тоггл **«Этот товар имеет варианты»** — при включении открывается менеджер вариантов (названия/цены/артикулы/характеристики).
    - **Изображения товара** — галерея с drag&drop, рекомендация 1000×1000, поддержка смены порядка и удаления.
    - **Описание** — WYSIWYG.
    - Блок **Цена**: тоггл **«Цена»** (скрытие цены в карточке), поле **Цена, ₽** (обязательно, если цена включена), тоггл **«Запретить добавление в корзину»**.
    - **Габариты**: Вес (кг/г), Высота/Ширина/Глубина (см) — опционально.
    - **Пищевая ценность** (на 100 г/мл): Белки/Жиры/Углеводы (г), Калорийность (ккал) — опционально.
    - **Маркерные теги** (переключатели): Новинка, Популярный, Острое, Для вегетарианцев.
    - Тоггл **«Отображать товар в каталоге»** — включён по умолчанию.
    - Кнопки: **«Сохранить и опубликовать»**, **«Удалить товар»** (с подтверждением).
  - «Цены и остатки»: поля/таблица цен по складам/точкам (если применимо), остатки; сохранение без смены табов, валидации числовых значений.

#### Категории
- Список: колонки превью, **Название категории**, **Порядок** (кнопки ↑/↓ или drag&drop), кнопка **«Создать категорию»**.
- Создание категории:
  - **Название** — обязательно.
  - **Изображение** — одно, рекомендация 1200×1200 (1:1).
  - **Описание** — WYSIWYG.
  - **Адрес (slug)** — латиница/дефис, автогенерация из названия с возможностью правки, проверка уникальности.
  - **Родительская категория** — дропдаун для вложенности.
  - Кнопка **«Создать»**: успех → возврат в список и toast.

#### Торговые точки
- Список: табы **Работают**/**Не работают**, поиск по названию, карточки с **Названием** и адресом (город, улица, дом); клик → профиль точки; кнопка **«Добавить торговую точку»**.
- Создание торговой точки (**Торговые точки → Добавить торговую точку**):
  - Вкладка «Основное»: тоггл **«Работает»**, тоггл **«Скрыть торговую точку от клиентов»**, **Название**, **Описание**, **Контактный телефон**, **Адрес** с подсказками и опцией **«Поставить маркер вручную»**, **Почта администратора** (несколько через запятую). Кнопка **Создать/Сохранить**.
  - Вкладка «Режим работы»: **Часовой пояс**, тоггл **«Отображать расписание»**, график работы (вариант круглосуточно либо по дням с интервалами), кнопка **Сохранить**.
  - Вкладка «Интеграции»: **Внешний ID / BranchID / IDBranch** — обязательный идентификатор из кассы/POS, кнопка **Сохранить**.

4) Аналитика/Аудитории/Отзывы/Рассылки — расширение
- Добрать разделы аналитики по ТЗ, аудитории (CRUD/состав), отзывы (миниаппа + портал), Telegram‑уведомления.

5) Интеграции — паритет по GMB API и каталог API
- Сверка функционала с: gmb_api.pdf, gmb_catalog_api.pdf; доработать API.
- Интеграции по pdf (1C/r_keeper/iiko/Poster/Frontol/МойСклад/CommerceML): адаптеры/валидаторы/вебхуки.

Каждый батч → тестовый ритуал: `pnpm -C api test && pnpm -C api test:e2e`. Обновлять README/Docs и этот план.

Обновлённый рабочий план доведения проекта лояльности до стабильного и надёжного состояния с современным UI. План синхронизирован с Memories (dev/test ритуал, бэкенд гарантий, Prisma‑правила, фичефлаги/воркеры, интеграции/bridge, фронтенды, DoD).

## Волны работ

- Волна 0 — Префлайт (завершена)
  - Пересмотр плана.
  - Строгий TS/ESLint/Prettier, базовый `tsconfig.base.json`. Скрипты: `typecheck`, `lint`, `lint:fix`, `test`.
  - Глобальная защита API: Helmet, CORS из `CORS_ORIGINS`, Nest Throttler/Redis, JSON‑логирование (pino). Валидация ENV (fail‑fast).
  - Прогон тестов: `pnpm -C api test && pnpm -C api test:e2e`.

- Волна 1 — Устойчивость и надёжность бэкенда
  - Идемпотентность commit/refund через `Idempotency-Key`, ретраи безопасны.
  - Транзакционные границы в денежных сценариях; инварианты Wallet/Transaction/Hold покрыты тестами.
  - Фичефлаги: `EARN_LOTS_FEATURE`, `POINTS_TTL_FEATURE`, `POINTS_TTL_BURN`, переключатель `WORKERS_ENABLED` — тесты сценариев TTL/отложенных начислений.
  - Алерты на 5xx/аномалии; базовые метрики latency/RPS/errors.

- Волна 2 — Функции лояльности (ядро)
  - Уровни (CustomerLevel): правила перехода и выгоды.
  - TTL/сгорание баллов: безопасный расчёт; тесты.
  - Промокоды: выпуск/активация/ограничения; анти‑фрод капы.
  - Рефералка многоуровневая; защита от саморефералки/дубликатов.
  - Акции: buy‑N‑get‑1, спеццены, бонусные коэффициенты.
  - Подарки за баллы и «Подарок на ДР».

- Волна 3 — Коммуникации и CRM/аналитика
  - Email/push через адаптеры, сегментация; outbox + ретраи.
  - Отчёты LTV/ретеншен/ARPU, сегменты и выгрузки.

- Волна 4 — Интеграции и Bridge
  - Единый интерфейс адаптеров: POS/Payments/ERP/Shipper; dry‑run, валидация конфигов, подписанные webhooks.
  - Минимальные коннекторы (iiko/r_keeper/frontol/Evotor/1C/CommerceML/robokassa/ecommpay/DPD и др.) с записями `Integration`.
  - Встроить в Bridge; подпись `BRIDGE_SECRET`.

- Волна 5 — Фронтенды (Owner Admin / Merchant Portal / Cashier / Miniapp)
  - Современный UI: единая дизайн‑система, i18n, доступность, skeletons/загрузки.
  - Owner Admin (админ‑консоль): глобальные настройки и наблюдаемость системы (страница Metrics, воркеры, Outbox/вебхуки, POS‑метрики, интеграции), управление мерчантами и ролями; режим «Просмотр как мерчант» с правом редактирования.
  - Merchant Portal (личный кабинет бизнеса): аналитика и CRM, механики/акции, аудитории, промокоды, отзывы; настройки перенесены в админку.
  - Cashier: QR → quote → commit, возвраты, безопасные повторы. Авторизация кассира: login = slug от имени мерчанта, пароль = 9 цифр; у сотрудников — пинкод 4 цифры (по точкам).
  - Miniapp (Telegram): баланс/история/QR, промо/подарки/ДР, уведомления; рефералка через deep‑link t.me/<bot>?start=ref_<code> и активацию при первом визите мини‑аппы.

## Definition of Done (общие)
- Строгий TS, валидируемые ENV; глобальные фильтры ошибок и логирование; Helmet/CORS/rate‑limit включены.
- Все тесты зелёные: `pnpm -C api test && pnpm -C api test:e2e`.
- Миграции Prisma — атомарны; без потерь денежных данных; тесты на миграции и инварианты.
- Современный UI и понятные UX‑флоу на фронтендах.
- Документация обновлена: README/DEPLOYMENT_GUIDE/API_DOCUMENTATION; краткий итог в `plan.md`.

## Риски и блокеры
- Отсутствующая dev‑БД → поднять Docker Compose.
- Долгие агрегации аналитики → кеш Redis + индексы.
- Интеграции с внешними API → мок/фичефлаги, dry‑run.

## Выполнено недавно
- ✅ Merchant Portal — Акции с начислением:
  - Страница `merchant-portal/app/loyalty/actions-earn/page.tsx` переведена на реальные данные без моков (загрузка из `/api/portal/loyalty/promotions`).
- ✅ Miniapp — кнопка QR:
  - Убран превью реального QR на кнопке (чтобы не плодить «настоящие» коды в списке).
  - Добавлен декоративный компонент `miniapp/components/FakeQr.tsx` (фейковый QR, гармоничный с UI).
  - Настоящий QR остаётся в модалке (`QrCanvas`), генерируется через реальное API.
  - Добавлена опция аудитории «Все клиенты» (без сегмента): специальное значение `__ALL__`, маппинг на `targetSegmentId: null` при сохранении.
  - Исправлена ошибка вложенных `<button>` в `components/TagSelect.tsx` (наружный контейнер заменён на `div[role="button"]`), устранены ошибки гидрации.
  - Miniapp: кнопка «Акции» внутри формы промокода получила `type="button"`; модалка акций открывается стабильно, при ошибке загрузки показывается toast.
  - Карточки акций: увеличен спарклайн (`components/Sparkline.tsx` параметры ширины/высоты), добавлены значения «Последний период» и суммарная выручка (скрываются при нулевых значениях).
  - Удалены лишние кнопки «Статистика»/«Открыть»; карточка целиком кликабельна и открывает окно редактирования.
  - Добавлены счётчики «Использовали» и «Проигнорировали» с долями от аудитории (берутся из `segment._count.customers` и `analytics.metrics.participantsCount`).
  - Для акций «Все клиенты» число «Вся аудитория» берётся из `/api/portal/analytics/customers` с фоллбеком `/api/customers?limit=1` (парсинг `X-Total-Count`/`Content-Range`/`total`), всегда показывается число.
  - В модалке редактирования заголовок: «Редактировать акцию» при открытии существующей акции.
  - Убрана визуальная метка «Акция не запущена» на карточке.
  - Форма создания/редактирования: интегрированы реальные аудитории (`/api/portal/audiences`), кнопка «Обновить размер аудитории» вызывает `/portal/audiences/:id/refresh` через прокси `app/api/portal/audiences/[id]/refresh/route.ts`.
  - Поддержаны опции уведомлений: PUSH при старте (`pushOnStart`) и напоминание за 2 дня до конца (`pushReminder` → `reminderOffsetHours=48`).
  - Созданы Next‑прокси:
    - `app/api/portal/loyalty/promotions/route.ts` (GET/POST)
    - `app/api/portal/loyalty/promotions/[id]/route.ts` (GET/PUT/POST → `/status`)
    - `app/api/portal/audiences/[id]/refresh/route.ts` (POST)

- ✅ Prisma миграции: починен скрипт `20251216150000_portal_review_links` — процитировано `ms."rulesJson"` в JSON-выражениях, устранена ошибка Postgres `E42703`; выполнен `pnpm -C api prisma migrate reset --force`, все миграции применены, сиды отработали.
- ✅ Торговые точки: вынесли POS-поля (`posType`, `posLastSeenAt`, `bridgeSecret*`) в `Outlet`, миграцией подтянули данные из `Device` и зафиксировали правила агрегации в README.
- ✅ Admin/Portal API: управление `bridgeSecret`/`bridgeSecretNext` и POS-статусами перенесено на `/merchants/:id/outlets/:outletId/*`, CLI Bridge и фронтовые клиенты используют `outletId`.
- ✅ Miniapp клиента: полностью обновлён UI под мобильные Telegram miniapp — карточка с QR/балансом/уровнем, прогресс до следующего уровня, история, промокоды и модальное увеличение QR; добавлена страница первичного онбординга и запрос телефона.
  - ✅ Merchant Portal: раздел «Торговые точки» подключён к реальному бэкенду — список точек загружается через прокси `/app/api/portal/outlets` → `GET /portal/outlets`, страница создания точки отправляет реальные данные (`POST /portal/outlets`) с расписанием; заглушки/демо‑сохранения удалены без изменения UI.
- ✅ Merchant Portal: реализованы разделы каталога (список товаров с фильтрами и массовыми действиями, создание товара с табами, список и создание категорий, список и мастер создания торговых точек) на мок-данных по новому ТЗ.
- ✅ API: добавлены модуль админки (мерчанты/настройки Bridge/QR/Staff), мерчант-панели (сотрудники/доступы/точки/кассовая панель), ядро лояльности (механики/акции/промокоды/журнал), CRM-аудитории и коммуникации на новой Prisma-схеме.
- ✅ Merchant Panel API: убраны дубли из PortalController, REST/GraphQL сервис сотрудников теперь сохраняет персональные и кассовые PIN, массовые операции и пароль, совместим со старыми роутами `/portal/staff/*` и `/portal/cashier`.

- ✅ Miniapp: второй этап окна отзыва — починен показ сервисов (Яндекс/2ГИС/Google). В `GET /loyalty/settings/:merchantId` добавлен корректный fallback `enabled` для платформ (если глобально включено и у платформы не задан `enabled`, считаем её включённой), а также формирование ссылок из `Outlet.reviewLinks`. Кнопки отображаются при включённой опции, оценке ≥ порога и наличии ссылки для точки/платформы.

- ✅ Merchant Portal: журнал операций `/operations` переведён на реальные данные из БД без моков
  - Добавлены прокси-роуты Next: `app/api/operations/log/route.ts`, `app/api/operations/log/[receiptId]/route.ts` → бэкенд `GET /portal/operations/log` и `GET /portal/operations/log/:receiptId`.
  - Страница `app/operations/page.tsx`: удалены мок-данные; загрузка списка с сервера с фильтрами/пагинацией; отображение без изменения интерфейса.
  - Исправлены ошибки UI: вложенные `<button>` (вынесено в `div role="button"`, компонент `StarRating` рендерит `<button>` только в интерактивном режиме), TDZ для `inputStyle` (введён `inputFieldStyle`).
  - Карточка клиента: устранён сбой порядка хуков (перенос `useMemo(groups)` выше раннего `return`), доступ к параметрам через `useParams()`.

- Модернизация admin analytics: единый `TopBar`/`Card`/`Skeleton`, улучшенные графики (`SimpleLineChart` с tooltip/hover/линейкой).
- Инициализирован `merchant-portal` (Next.js) — базовый дашборд, подключение дизайн‑системы.
- Создан пакет `@loyalty/ui` (токены темы, базовые компоненты: Button/Card/Skeleton/Chart; иконки Lucide; анимации Framer Motion). Обновлён `pnpm-workspace.yaml`.
- Merchant Portal: реализована аутентификация по email+паролю (+ TOTP опц.), добавлена страница `/login`, middleware защиты, server routes `/api/session/*`.
- API: модуль `PortalAuth` (`POST /portal/auth/login`, `GET /portal/auth/me`), CORS для `authorization`, `PORTAL_JWT_SECRET` в ENV и `infra/env-examples/api.env.example`.
- Prisma: у `Merchant` добавлены `portalEmail` (unique), `portalPasswordHash`, а также `portalKeyHash/portalTotpSecret/portalTotpEnabled/portalLoginEnabled/portalLastLoginAt`; миграции применены.
- Admin: «Мерчанты» — список/создание (Name/Email/Password), включение/выключение входа, TOTP (init/verify/disable), «Открыть как мерчант» (имперсонация в портал).
- Merchant Portal: подключены данные — `Настройки` (GET/PUT), `Сотрудники` (список/создать), `Точки` (список/создать), `Устройства` (список/создать), `Клиенты` (поиск по телефону), `Операции` (транзакции/чеки); добавлены `Ваучеры` (список/выпуск/деактивация), `Рассылки` (dry-run/enqueue), `Интеграции` (список); аналитика подключена: `Дашборд`, `RFM`, `Портрет`, `Повторы`, `Время`, `ДР` (через портальные прокси `/portal/analytics/*`).
 - PortalAuth: добавлены e2e-тесты `login` (email+пароль), ветвь `TOTP`, `me` и админская имперсонация; внедрён jose-wrapper `getJose()` для стабильных тестов (используется в `PortalAuthController`, `PortalGuard`, `MerchantsService.signPortalJwt`); добавлен smoke‑тест портальной аналитики; обновлён `README` (раздел PortalAuth/имперсонация); все тесты зелёные.
- RBAC: переименована роль `MANAGER` → `MERCHANT` во фронтах/admin‑proxy и Prisma enum (миграция).
- Аналитика backend: заменены сырые SQL ($queryRaw) на Prisma в `getTopCustomers/getTopOutlets/getTopStaff/getDeviceUsage`.
- Включён строгий TS на уровне монорепо: обновлён `tsconfig.base.json` (`strict`, `noUncheckedIndexedAccess`).
- Настроены ESLint/Prettier во всех пакетах (`api`, `admin`, `cashier`, `miniapp`, `bridge`); добавлены корневые `.prettierrc`, `.prettierignore`, `.eslintignore`, `.editorconfig`.
- Корневой `package.json`: добавлены скрипты `format`/`format:check` и унифицированные `typecheck/lint`.
- API hardening: подтверждены Helmet/CORS/Throttler/Pino; добавлена schema‑валидация ENV через Ajv (fail‑fast в `api/src/main.ts`).
- Поднята dev‑БД (`docker compose -f infra/docker-compose.yml up -d`), применены миграции (`prisma migrate deploy`).
- Тестовый ритуал выполнен: `pnpm -C api test && pnpm -C api test:e2e` — зелёные.

- 5xx алерты: `AlertsService` интегрирован в `HttpMetricsInterceptor`, сэмплинг по `ALERTS_5XX_SAMPLE_RATE`; добавлены переменные для Telegram в `api/.env.example`.
- Идемпотентность commit: `merchantId` выводится из `hold`, кэшируемый ответ нормализован (устранён дрейф `alreadyCommitted`), повторные вызовы стабильно детерминированы.
- Антифрод: `dailyCap` переведён на скользящее 24‑часовое окно, чтобы избежать TZ/полуночных артефактов.
- E2E: добавлен тест идемпотентности `refund` (повтор по одному `Idempotency-Key`).
- Wave 1: углублённые e2e по идемпотентности и инвариантам — коллизии `orderId`, конкурентные `commit`, многошаговые частичные `refund` для `EARN/REDEEM`, идемпотентность `refund`.
- Воркеры/флаги: добавлены unit‑тесты `PointsTtlWorker`, `PointsBurnWorker`, `EarnActivationWorker`; документированы фичефлаги и интервалы, примеры `.env` обновлены (локальный/infra).
- Тестовая инфраструктура: устранены «залипающие» open handles в Jest. Во всех воркерах таймеры `unref()`, таймауты очищаются; Prometheus default timers выключены в тестах (`METRICS_DEFAULTS=0`), e2e запускаются `--runInBand --detectOpenHandles`.
- Интеграции: Evotor — AJV‑валидация конфигурации, журнал `SyncLog` (IN ok/error), контроллер инкрементирует `pos_webhooks_total`. ModulKassa/Poster — `POST /register` с OAuthGuard, валидация и upsert `Integration`, вебхуки пишут `SyncLog`, стандартизированы лейблы метрик; добавлены e2e тесты (включая проверку `pos_webhooks_total`).

## Волна 1 — Завершена (2025-09-15)
- Идемпотентность денежных операций: `commit/refund` с `Idempotency-Key`, эмулированы повторы/гонки; стабильные e2e на коллизии `orderId` и повторные вызовы.
- Транзакционные инварианты: активное использование Prisma‑транзакций; тесты на баланс и атомарность `Wallet/Transaction/Hold` под конкуренцией — зелёные.
- Безопасность по умолчанию: Helmet, CORS из `CORS_ORIGINS`, rate‑limit (порог по умолчанию), централизованные фильтры ошибок и структурные логи.
- Воркеры/фичефлаги: `WORKERS_ENABLED`, TTL‑воркеры и earn‑активации — покрыты unit‑тестами; таймеры размечены `unref()` для чистоты тестов.
- Наблюдаемость: ключевые метрики (RPS/latency/errors, outbox) экспортируются на `/metrics`; алерты 5xx интегрированы; дефолтные пром‑метрики отключаются в тестах.
- ENV‑валидация: Ajv‑schema для API, fail‑fast при некорректных значениях; примеры `.env` обновлены.

— Следующий шаг: оформить PR (conventional commits) с DoD, финальный смоук: `docker compose -f infra/docker-compose.yml up -d` → `pnpm -C api test && pnpm -C api test:e2e`; затем приступить к Wave 2 (ядро лояльности: уровни/TTL/промо).

## Волна 2 — Прогресс (2025-09-15)

- Выполнено:
  - Levels (legacy, удалено): применяются бонусы уровня к `earnBps`/`redeemLimitBps` в `quote()` по `rulesJson.levelsCfg` + `levelBenefits`; добавлены unit/e2e тесты.
  - Admin (legacy, удалено): добавлены редакторы `levelsCfg`/`levelBenefits` и страница предпросмотра уровня клиента (`admin/src/app/levels/page.tsx`).
  - UI-качество: заменены внутренние `<a>` на `Link` в Admin и безопасная типизация `catch (unknown)`.
  - Тестовый ритуал: исправлен «зависон» после e2e — в `api/package.json` скрипт `test:e2e` дополнен `--forceExit`.
  - E2E комбо: прежние сценарии Levels + промокод + Promo требуются заново после миграции на новый сервис.
  - TTL: усилены unit‑тесты `PointsBurnWorker` (явные проверки суммы сгорания/баланса/события), превью TTL (`PointsTtlWorker`) и активация лотов — зелёные.
  - Документация: `API_DOCUMENTATION.md` — разделы «Уровни и бонусы» и «TTL/Сгорание баллов» (флаги, события, настройки в админке).
  - Admin (legacy, удалено): добавлены проверки валидности JSON для `levelsCfg` и `levelBenefits` (кнопки «Проверить уровни/бонусы» на странице настроек).
  - Подключён `PromosModule` (prev. этап) и добавлены превью‑правила (категория, minEligible), e2e `promos.e2e-spec.ts` — зелёные.
  - Legacy ваучеры удалены: сервисы и контроллеры `vouchers/*` заменены на единый `PromoCodesService`, работающий с реальными таблицами `PromoCode`/`PromoCodeUsage`.
  - E2E: сценарии на legacy ваучеры (portal + loyalty) переписаны под `PromoCodesService`, старые проверки удалены как дублирующие.
  - Интеграция в денежный флоу: `loyalty.controller.quote|commit` принимает поле `promoCode`, использует `PromoCodesService.apply`, начисляет баллы, TTL и уровни в рамках транзакции.
  - Portal/merchant-portal: `GET/POST /portal/promocodes*`, прокси в `merchant-portal/app/api/portal/promocodes/*` и страница `/promocodes` обновлены под `promoCodeId` и статусы `ACTIVE/ARCHIVED`.
  - Cashier auth: публичные эндпоинты в `LoyaltyController` — `POST /loyalty/cashier/login` (merchantLogin+password9) и `POST /loyalty/cashier/staff-token` (по PIN и точке).
    - `CashierGuard`: whitelist для `/loyalty/cashier/*` и прочих публичных GET.
    - `LoyaltyModule`: импортирован `MerchantsModule` для DI.
    - Восстановлен `POST /loyalty/qr` в корректном месте.
  - Навигация портала: «Ваучеры» заменены на «Промокоды», ссылки «Устройства»/«Настройки» убраны из шапки.
-  - Merchant Portal: реализована боковая навигация (sidebar) по структуре из PAGES.md: Мастер настройки; Аналитика (все подпункты); Программа лояльности (механики/акции/акции с начислением/push/telegram/промокоды/мотивация/антифрод/панель кассира); Отзывы; Клиенты и аудитории; Товары и категории; Карта Wallet; Настройки; Инструменты. Созданы страницы‑скелеты по каждому разделу. Корневая страница теперь «Мастер настройки».
  - Панель кассира (портал): backend эндпойнты `GET /portal/cashier` и `POST /portal/cashier/rotate`, прокси в `merchant-portal` и страница `/loyalty/cashier` с показом логина/статуса пароля, ротацией (отображение нового 9‑значного пароля, кнопка «Скопировать»), таблицей пин‑кодов сотрудников по точкам (обновление PIN/отозвать доступ).
  - Ритуал тестов после правок: `pnpm -C api test && pnpm -C api test:e2e` — все зелёные.
  - Merchant Portal: «Акции» — список с фильтрами статуса (`/loyalty/actions`, прокси `/api/portal/campaigns`), детальная страница `/loyalty/actions/[id]` (прокси `/api/portal/campaigns/[id]`, backend `GET /portal/campaigns/:campaignId`).
  - Merchant Portal: «Акции с начислением» — отдельный список кампаний с наградой POINTS/PERCENT (`/loyalty/actions-earn`).
  - Merchant Portal: «Механики» — добавлена сводка параметров программы из `/portal/settings` (earnBps/redeemLimitBps/TTL/задержка/QR TTL/требования Staff‑Key/Bridge).
  - Merchant Portal: добавлены страницы механик и сохранение в `rulesJson`:
    - «Ограничения списания» (`/loyalty/mechanics/redeem-limits`) — TTL баллов, запрет одновременного списания/начисления, задержка активации.
    - «Автовозврат клиентов» (`/loyalty/mechanics/auto-return`) — конфиг `rulesJson.autoReturn` (enabled/days/text/giftPoints/giftTtlDays/repeat).
    - Автовозврат клиентов — подключены реальные настройки и статистика (правка `rulesJson.autoReturn`, аналитика `/portal/analytics/auto-return`, перенаправление из аналитики на таб «Статистика», удалён устаревший `/analytics/auto-return`).
    - «ДР‑поздравления» (`/loyalty/mechanics/birthday`) — конфиг `rulesJson.birthday` (enabled/daysBefore/daysAfter/text/giftPoints/giftTtlDays).
    - ДР‑поздравления: добавлены реальные настройки и статистика — прокси `/api/portal/loyalty/birthday`, аналитика `/portal/analytics/birthday-mechanic`, UI таб «Статистика», редирект со старой страницы `/analytics/birthdays`.
    - «Бонус за регистрацию» (`/loyalty/mechanics/registration-bonus`) — конфиг `rulesJson.registration` (enabled/points/ttlDays/text).
    - «Сгорание (TTL)» (`/loyalty/mechanics/ttl`) — управление `pointsTtlDays` и `rulesJson.burnReminder` (enabled/daysBefore/text).
  - Merchant Portal: `auto-return` сохранение рефакторено — отправляется минимальный DTO (`earnBps`, `redeemLimitBps`, `rulesJson`) вместо полного объекта настроек.
  - Требуется обновить e2e под новый `PromoCodesService` (earn/commit/idempotency) — старые сценарии на ваучеры удалены.
  - Prisma: legacy таблицы `Voucher*` удалены — остались только `PromoCode*`, внешних интеграций/отчётов на них не осталось.
  - Seeds/fixtures: генераторов записей ваучеров не осталось — чистка не требуется.
  - SDK TS: поле запроса переименовано в `promoCode`, удалён клиент `vouchers.*`.
  - README и документация обновлены под промокоды портала вместо ваучеров.
  - Все тесты зелёные: `pnpm -C api test && pnpm -C api test:e2e`.
  - Merchant Portal — Клиенты: подключено бэкенд‑взаимодействие без изменения UI. Страница `/customers` и карточка клиента используют прокси `app/api/customers/*` к `http://localhost:3004/customers` (CRUD). Создание/редактирование, а также модалки «Начислить»/«Списать» сохраняют данные в БД. Добавлен пример ENV `infra/env-examples/merchant-portal.env.example` с `CUSTOMERS_API_BASE`.
  - Admin UI: legacy раздел «Ваучеры» удалён, вместо него основной фокус — порталские промокоды.
  - API: legacy эндпоинты `/vouchers/*` вычищены.
  - Admin (CRM): мини‑карточка уровня на странице клиентов, автозагрузка уровня, ссылка «Подробнее», бейдж уровня в транзакциях/чеках с tooltip «эффективные ставки» (base rules + level bonus).
  - Admin (Levels): автозагрузка по query `merchantId/customerId`, прогресс‑бар, расчёт «эффективных ставок» на странице уровней и в настройках мерчанта.
  - TTL e2e: полный флоу PENDING→ACTIVE→preview→burn (`ttl.flow.e2e-spec.ts`) и FIFO‑сгорание с проверкой `consumedPoints` (`ttl.fifo.e2e-spec.ts`).
  - Levels x TTL interplay: при metric=earn активация PENDING(120) поднимает уровень до Silver; quote на 1000 даёт 70 баллов (700 bps) — `levels.ttl.interplay.e2e-spec.ts`.
  - Метрики: e2e проверки /metrics после превью и burn (`metrics.workers.e2e-spec.ts`), gauge `loyalty_worker_last_tick_seconds`, счётчики burn.
  - Referrals: e2e‑заглушки контроллера с mock Prisma (`referral.e2e-spec.ts`); подключён `ReferralModule`, экспортирован `LoyaltyService` из `LoyaltyModule`.
  - Docs: `API_DOCUMENTATION.md` — добавлены примеры конфигов уровней и раздел «Порядок применения» (Promo → Rules + Levels) с формулами и примерами; подчёркнуто, что поддерживаются только промокоды.
  - Admin: единый поповер «эффективные ставки» (`admin/components/EffectiveRatesPopover.tsx`) подключён на страницах `customers` и `levels`.
  - E2E REDEEM: пер‑заказный cap — `redeem.order.cap.e2e-spec.ts` (учёт `receipt.redeemApplied`), дневной cap — `redeem.daily.cap.e2e-spec.ts` (rolling 24h) — оба зелёные.
  - Docs: `README.md` дополнен Quickstart «Levels + TTL». `API_DOCUMENTATION.md` — раздел «Referrals (beta/preview)» и примечания к REDEEM (per‑order cap и daily cap).
  - E2E EARN: дневной cap — `earn.daily.cap.e2e-spec.ts` — зелёный.
  - Referrals: позитивный флоу create→activate→complete — `referral.flow.e2e-spec.ts` — зелёный; API docs — добавлен `/referral/complete`.
  - Idempotency: конкурентные commit по одному `orderId` — `redeem.concurrent.order.commit.e2e-spec.ts` — второй commit идемпотентен.
  - Admin UX: поповер — закрытие по клику вне и по Esc, скелетон‑состояние загрузки.

 - Следующий шаг (Wave 2):
  - E2E: «промокод+уровень+commit → повторный quote (per‑order cap)», расширение TTL‑кейсов, нагрузочные sanity‑чек‑тесты.
  - Referrals: e2e без моков на dev‑БД (идемпотентность, самореферал), SDK методы и примеры.
  - Admin: типографика/отступы/тени поповера (унификация с дизайн‑системой), быстрые подсказки на списках.
  - Ритуал: держать `pnpm -C api test && pnpm -C api test:e2e` зелёным на каждом батче; фиксировать прогресс в `plan.md`.

— Следующий шаг (Wave 2, текущая сессия):
  - Cashier UI: реализовать экран кассира (login 9‑значный пароль мерчанта → ввод PIN сотрудника по точке) и привязку к `X-Staff-Key`.
  - Promocodes (points): расширить обработку в `LoyaltyService.commit()` для начислений по промокоду (POINTS) — idempotent по `orderId`, структурные логи/метрики; e2e.
    - [x] Централизовать бизнес-логику промокодов в `PromoCodesService`, перевести портал/loyalty-контроллеры и метрики на единый слой.
    - [x] CashierGuard учитывает bridge signature и teleauth при `requireStaffKey`, чтобы `quote/commit/refund/cancel` не падали с 403.
    - [x] QR miniapp: допускаем генерацию по Telegram initData при включённых `requireStaffKey`/`requireBridgeSig`, устранив 403 на `/loyalty/qr`.
  - E2E: добавить кейс earn по промокоду POINTS (issue → quote/commit с promoCode → проверка баланса/транзакций).

## Волна 3 — Завершена (2025-09-15)

- Выполнено:
  - Заготовка уведомлений: `NotificationsService.broadcast/test` — постановка задач в Outbox (`eventType=notify.*`), метрика `notifications_enqueued_total`.
  - Подключён `NotificationsModule` в `AppModule` (используем существующие Email/Push контроллеры для дальнейшей интеграции).
  - Admin UI: добавлена страница `admin/app/notifications` с формой рассылки (канал, сегмент, шаблон), поддержкой `dry-run`, выводом оценки получателей, выпадающим списком сегментов (`getSegmentsAdmin`).
  - Worker: создан `NotificationDispatcherWorker` (обработка `notify.broadcast`/`notify.test`), исключены `notify.*` из `OutboxDispatcherWorker`. Метрики `notifications_processed_total` и liveness.
  - Worker: добавлены per‑channel метрики (`notifications_channel_attempts_total/sent_total/failed_total` с label `channel`) и запись аудита в `AdminAudit` для событий broadcast.
  - Worker: внедрён per‑merchant RPS‑троттлинг (`NOTIFY_RPS_DEFAULT`, `NOTIFY_RPS_BY_MERCHANT`), события при ограничении переносятся на +1s; покрыто unit‑тестом `notification-dispatcher.worker.spec.ts`.
  - README и `infra/env-examples/api.env.example`: добавлены раздел и переменные для SMTP/FCM и настроек воркера уведомлений.
  - Dry-run: `NotificationsService.broadcast()` возвращает `estimated` по сегменту или каналам (email/push) на основе Prisma счётчиков и consent’ов.
  - Admin UI: i18n (RU/EN), a11y‑лейблы, skeleton‑лоадеры для сегментов; предпросмотр шаблонов с `{{var}}`.
  - Метрики: пер‑канальные метрики дополнены лейблом `merchantId` для разреза по мерчанту.
  - Тесты: добавлены unit‑тесты воркера на троттлинг и ветви ошибок/ретраев (`notification-dispatcher.worker.spec.ts`, `notification-dispatcher.errors.spec.ts`).

- Итог: функционал рассылок завершён — воркер уведомлений с метриками/аудитом, dry‑run и сегментами; Admin UI с предпросмотром/валидацией; документация и env‑пример обновлены; покрыто unit/e2e тестами; все тесты зелёные.

## Волна 4 — Старт (2025-09-15)

- Задачи:
  - Адаптеры интеграций: унифицировать интерфейсы (`POSAdapter`/`PaymentProvider`/`ERPAdapter`/`Shipper`), описать контракты.
  - Валидация конфигов интеграций (AJV): схемы для Evotor/ModulKassa/Poster, ошибки — fail‑fast.
  - Подписанные вебхуки провайдеров: проверка подписи, окно времени; логирование входа/выхода, ретраи.
  - Журнал `SyncLog`: IN/OUT события, статус/ошибка, payload, план ретраев.
  - Bridge: обновить README/пример `.env`, описать подпись `BRIDGE_SECRET`, офлайн‑очередь.
  - Тесты: unit для валидаторов/подписей, e2e флоу интеграций (моки провайдеров), метрики `pos_*`.

## Волна 4 — Прогресс (2025-09-15)

- Выполнено:
- Evotor: валидация конфигов (AJV), `SyncLog` входящих вебхуков, метрики `pos_webhooks_total` и `pos_requests_total`/`pos_errors_total` в контроллере.
- ModulKassa/Poster: реализованы `POST /register` (OAuthGuard) с валидацией и upsert `Integration`; вебхуки пишут `SyncLog`; стандартизированы лейблы провайдера в метриках; e2e на вебхуки и метрики.
- E2E инфраструктура стабилизирована без open handles.
- Централизация POS‑метрик: `pos_requests_total`/`pos_errors_total`/`pos_webhooks_total` перенесены в prom‑client (`MetricsService`), роутинг через `inc()` без дублей.
- Негативные e2e: Evotor — неверная подпись вебхука → `SyncLog.status=error` и метрики; ModulKassa/Poster — `POST /register` с некорректным конфигом → 400 и `pos_requests_total{result="error"}`.
- DRY: общий helper `upsertIntegration()` для регистрации интеграций, используется в ModulKassa/Poster.
- Bridge: README дополнен (формат `X-Bridge-Signature`, заголовки, офлайн‑очередь/бэкенды, метрики/эндпоинты); `infra/env-examples/bridge.env.example` обновлён (переменные очереди).
- Merchant Portal: реализована карточка и страница подключения Telegram Mini App с реальными API (регистрация, проверка и отключение бота, обновление статусов интеграций); добавил модалку ввода токена и обновление настроек без заглушек.
- API: привёл сервис Telegram Mini App к корректной работе с JSON-полями Prisma и устранил ошибки типизации TypeScript.
- Backoffice data: добрал миграцию по бэкфиллу `outletId` из `deviceId`, добавил проверки остатков и обновил сиды/фикстуры под новую схему.

- Следующие шаги:
  - Расширить общий helper для ERP/Shipper и перевести оставшиеся адаптеры.
  - Добавить Admin‑виджеты по POS‑метрикам (`pos_*`) и краткий раздел API Docs о верификации `X-Bridge-Signature` в `loyalty.controller`.
  - Покрыть негативные сценарии вебхуков прочих провайдеров (assert `pos_errors_total`, `SyncLog.status=error`).
  - Настроить CI для загрузки Prisma engines в офлайновых средах (экспорт `PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING`).

## Волна 4 — Аналитика (в работе 2025-09-15)

- [x] Сверстать «Сводный отчёт» и «Распределение по времени» по ТЗ: фильтры периода, карточки, графики, подписи.
- [x] Обновить «Портрет клиента», «Повторные продажи» и «Динамика»: фильтры/тумблеры, графики, метрики.
- [x] Реализовать требования для «RFM-анализ», «Активность торговых точек», «Активность сотрудников», «Реферальная программа» (таблицы, модалки, кнопки).
- [x] Реферальная аналитика: фильтры периодов используют реальные временные диапазоны (`/portal/analytics/referral`), данные топа и метрик подгружаются с API без заглушек.
- [x] Пройтись по документации (README/PAGES) и зафиксировать изменения.
- [x] «Портрет клиента»: фильтр аудиторий подключён к реальным сегментам, диаграмма пола показывает русские подписи без выносок, показатели «Средний чек»/«Количество продаж»/«Сумма продаж» отображаются барчартами по полу, возраст и связка пола с возрастом визуализированы графиками с ползунками диапазонов.

## Волна 4 — Механики (в работе 2025-09-15)

- [x] Вынес применение/экспорт/уведомления кампаний в `LoyaltyPromotionService` и добавил миграцию данных из `campaigns` в `loyalty_promotions`.
- [x] Обновил README/API/docs под `LoyaltyPromotion`, добрал e2e (экспорт/применение/уведомления) и фронтовые тесты на новый формат.
- [x] Портал и фронтенд `merchant-portal` переведены на новую сущность `LoyaltyPromotion` через прокси `/portal/loyalty/promotions` (backend контроллеры + Next API).
- [x] Удалён legacy-модуль `Campaign`: Prisma-модель и миграции очищены, сервисы/отчёты/аналитика переведены на `LoyaltyPromotion` и `PromotionParticipant`.
- [ ] Обновить страницу перечня механик: карточки с иконками/описаниями, тумблеры по ТЗ.
- [ ] Реализовать UI «Уровни клиентов»: список, создание, редактирование, детальная с корректировками и составом.
- [ ] Сверстать страницы настроек: «Ограничения в баллах», «Автовозврат», «Поздравить с днём рождения», «Баллы за регистрацию», «Напоминание о сгорании», «Реферальная программа».
- [x] Статистика автовозврата в портале: реальные метрики без заглушек, фильтры/графики по ТЗ, автотесты.
- [x] Реферальная программа: форма настроек в портале подключена к `/portal/settings`, поддерживает многоуровневые награды, реальные значения бонусов и текст приглашения.
- [x] Обновлён раздел «Акции»: вкладки Предстоящие/Текущие/Прошедшие, поиск и таблица с меню действий, мастер создания в два шага.
- [x] Добавлен «Журнал начисления баллов»: фильтры, список операций с пагинацией и модальное окно просмотра операции.
- [x] Push-рассылки: вкладки активных/архивных кампаний, таблица и модальное окно создания с ограничением 300 символов и выбором аудитории.
- [x] Telegram-рассылки: пустое состояние, таблица архивов, расширенная модалка с лимитом 512 символов, загрузкой изображения и валидациями.
- [x] Мотивация персонала: настройки начислений и отображения рейтинга, предпросмотр панели кассира, сохранение только при изменениях.
- [x] Навигация портала: сворачиваемые группы разделов и ссылка на «Журнал начисления баллов» в блоке «Программа лояльности».
- [x] Бэкенд портала: API для push/telegram-рассылок, мотивации персонала, списка акций и журнала операций с фильтрами и деталями.
- [x] Раздел «Защита от мошенничества»: форма лимитов с уведомлениями, контакты получателей, сохранение настроек.
- [x] Клиенты: обновлён список с фильтрами, модалкой создания/редактирования и импортом CSV; карточка клиента с историей, отзывами и модалками операций; страница комплиментарных баллов.
- [x] Отзывы: страница портала отображает реальные данные без моков, фильтры используют API, настройки шаринга сохраняются; миниапп предлагает поделиться отзывом на подключённых площадках.
- [x] Loyalty API: quote/commit/refund переключены на outletId (канал по Outlet.posType, outbox/транзакции/hold наполняются outletId, подписи берут секреты из Outlet → MerchantSettings, кеш правил и тесты обновлены).
- [x] Push-рассылки: вкладки активных/архивных кампаний, таблица и модальное окно создания с ограничением 300 символов и выбором аудитории.
- [x] Telegram-рассылки: пустое состояние, таблица архивов, расширенная модалка с лимитом 512 символов, загрузкой изображения и валидациями.
- [x] Мотивация персонала: настройки начислений и отображения рейтинга, предпросмотр панели кассира, сохранение только при изменениях.
- [x] Навигация портала: сворачиваемые группы разделов и ссылка на «Журнал начисления баллов» в блоке «Программа лояльности».

## Хотфикс 2025-10-06 — QR и история миниаппы
- [x] Merchant portal: удалён устаревший раздел `/tools/import`, пункт «Импорт данных» ведёт в `/customers/import`.
- [x] Miniapp: подписи «Баланс/Уровень/Кэшбэк» сделали полужирными, история получила новые иконки и отдельные цвета для промокодов и возвратов.
- [x] Miniapp: убрана стрелка «Назад», QR-код вынесен на страницу `/qr` с обновлением токена, таймером TTL и блоками прогресса уровня.

- [x] Механика уровней: сиды "Базовый"/"VIP"; /loyalty/quote применяет ставки уровня и минимальную сумму к оплате; Portal CRUD уровней на реальном API.

## Хотфикс 2025-10-08 — Миниаппа: профиль Telegram
- [x] Диагностировать потерю профиля при авторизации на другом устройстве (miniapp `useMiniappAuth` + профиль).
- [x] Синхронизировать локально сохранённый профиль с сервером после получения `customerId`; заблокировать ручное сохранение до завершения `teleauth`.
- [x] Форма профиля остаётся открытой до успешной синхронизации, чтобы исключить показ дефолтного дашборда и "фейковых" уровней.
- [x] Повторная попытка `teleauth` при сабмите профиля и автосинхронизация referral-кода с новым `customerId`.
- [x] Поддержать Telegram `initData` через `initDataUnsafe` (только с `hash`) и явно подключить `telegram-web-app.js`, чтобы teleauth работал на iOS/мобильных клиентах.
- [x] Использовать приоритетно `tgWebAppData`/`initData` из query‑параметров и валидировать наличие `hash`, чтобы не слать «синтетический» `initData` без валидной подписи.
- [x] Серверная валидация initData использует секрет `HMAC_SHA256('WebAppData', botToken)` и строит `data_check_string` по всем парам кроме `hash` (как в актуальной документации).
- [x] При необходимости обновить документацию/README и прогнать smoke-тесты миниаппы.
- [ ] Добавить в интерфейс рассылок кнопку немедленного запуска кампании.
## Хотфикс 2025-10-15 — Merchant Portal: Телеграм-рассылки на реальном API
- [ ] Провести аудит текущих telegram-рассылок и аудиторий (frontend, backend, bridge/inтеграциях).
- [ ] Настроить backend: реальные аудитории и связка с интеграцией Telegram, создание скрытой аудитории «Все клиенты», убрать поле общего количества пользователей.
- [ ] Обновить фронтенд рассылок: убрать мок-данные, подключить реальные аудитории, обновить лимиты текста/изображений и UI.
- [ ] Обновить документацию (README/API_DOCUMENTATION) и выполнить проверки рассылки/аудиторий.

## Хотфикс 2025-10-15 — Merchant Portal: PUSH-рассылки через Telegram
- [x] Удалить legacy-провайдеры push-уведомлений и перевести `PushService` на Telegram Mini App уведомления.
- [x] Доработать воркеры/сервисы коммуникаций для обработки push-задач через Telegram-бота мерчанта.
- [x] Обновить интерфейс `merchant-portal/loyalty/push`: реальный API, кнопки «Запустить сейчас»/«Запланировать», убрать блок статуса интеграции.
- [x] Обновить документацию и README по новой схеме push-рассылок.
- [x] Снять ограничения по подписке и сохранять fallback-сообщение в Telegram без удаления.

## Хотфикс 2025-11-17 — Merchant Portal: статистика поздравлений с ДР
- [x] Пересчитать аналитику поздравлений: реальные метрики подарочных баллов и покупок с их расходом, учёт сгорания и фильтра по точкам, группировки день/неделя/месяц.
- [x] Обновить UI вкладки статистики: фильтры без заголовков, единый выбор произвольного интервала, требуемые KPI и графики, убрать лишние секции.
- [x] Покрыть бэкенд и фронтенд тестами, при необходимости актуализировать README/API_DOCUMENTATION.

## Хотфикс 2025-11-18 — Миниаппа: повторное окно отзыва
- [x] Разобраться, почему окно оценки визита появляется повторно после закрытия на другом устройстве.
- [x] Сохранить факт закрытия/отказа от оценки на сервере и учитывать его при выборе транзакции для показа окна.
- [x] Обновить миниаппу под новое поведение и прогнать необходимые проверки/доки.

## Хотфикс 2025-11-26 — Отзывы и realtime события
- [x] Portal reviews: при наличии сотрудника в чеке колонка «Устройство / сотрудник» показывает именно сотрудника; device отображается только при реальном устройстве.
- [x] Loyalty: вернул pg-функцию/триггер `loyalty_emit_realtime_event` + `loyalty_realtime_event_emit` (INSERT/UPDATE на Transaction) для автоматического формирования `LoyaltyRealtimeEvent` и `pg_notify('loyalty_realtime_events', ...)`, чтобы миниаппа сразу обновляла баланс/историю и открывала окно отзыва без перезагрузки.
